<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Super Rotina App</title>
    <style>
        /* --- ESTILOS APP MOBILE --- */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: #f0f2f5; 
            margin: 0; 
            padding-bottom: 90px; /* Espa√ßo extra para menu inferior */
            color: #333; 
            -webkit-tap-highlight-color: transparent;
        }

        /* --- TELAS (SISTEMA DE ABAS) --- */
        .tela { display: none; padding: 15px; padding-top: 70px; animation: fadeIn 0.3s; }
        .tela.ativa { display: block; }
        .tela-login { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- HEADER FIXO (TOPO) --- */
        .app-header {
            position: fixed; top: 0; left: 0; width: 100%; height: 60px;
            background: white; border-bottom: 1px solid #eee;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; box-sizing: border-box; z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        
        /* --- MENU INFERIOR (RODAP√â) --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 65px;
            background: white; border-top: 1px solid #eee;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.03);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: #bdc3c7; font-size: 10px; font-weight: 600;
            background: none; border: none; cursor: pointer; padding: 5px;
        }
        .nav-item span { font-size: 24px; margin-bottom: 2px; }
        .nav-item.ativo { color: #3498db; }

        /* --- CARDS E ELEMENTOS --- */
        .card { background: white; padding: 15px; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        h2 { margin-top: 0; font-size: 16px; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; color: #2c3e50; font-weight: 700; }
        h3 { font-size: 14px; margin-bottom: 10px; color: #7f8c8d; border-left: 3px solid #3498db; padding-left: 8px; }

        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 14px; background: #f9f9f9; margin-bottom: 10px; }
        label { display: block; font-size: 10px; font-weight: bold; color: #95a5a6; text-transform: uppercase; margin-bottom: 4px; letter-spacing: 0.5px; }

        /* --- BOT√ïES --- */
        button { border: none; border-radius: 10px; padding: 12px; font-weight: bold; width: 100%; cursor: pointer; font-size: 14px; margin-bottom: 5px; transition: 0.2s; }
        button:active { transform: scale(0.98); }
        .btn-blue { background: #3498db; color: white; }
        .btn-green { background: #2ecc71; color: white; }
        .btn-red { background: #e74c3c; color: white; }
        .btn-icon { width: 36px; height: 36px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 18px; margin: 0; }
        .btn-small { padding: 5px 10px; font-size: 12px; width: auto; margin: 0; }

        /* --- GALERIA MOBILE --- */
        .galeria-v { 
            display: flex; gap: 8px; overflow-x: auto; 
            background: #f8f9fa; padding: 10px; border-radius: 10px; 
            border: 1px solid #eee; margin-bottom: 10px; min-height: 80px;
        }
        .img-sel { width: 60px; height: 60px; object-fit: contain; background: white; border-radius: 8px; border: 2px solid transparent; flex-shrink: 0; display: none; }
        .img-sel.visivel { display: block; }
        .img-sel.ativa { border-color: #2ecc71; background: #eafaf1; }

        /* --- AGENDA / CALEND√ÅRIO (Corre√ß√£o Scroll) --- */
        .calendario-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 10px; }
        .dia-coluna { 
            min-width: 140px; /* Largura fixa menor */
            max-width: 140px;
            background: white; 
            border: 1px solid #eee; 
            border-radius: 10px; 
            padding: 8px;
            margin-right: 8px;
            flex-shrink: 0; /* Impede encolhimento */
        }
        .card-rotina { 
            background: #f0f8ff; 
            border-left: 3px solid #3498db; 
            padding: 6px; 
            margin-bottom: 6px; 
            border-radius: 4px; 
            font-size: 11px; 
            position: relative;
        }
        .btn-del-mini {
            position: absolute; right: 2px; top: 2px;
            color: #e74c3c; background: none; padding: 2px 6px; 
            font-size: 10px; width: auto;
        }

        /* --- LISTA DE ATIVIDADES (Corre√ß√£o Imagens Grandes) --- */
        .item-lista {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px; border-bottom: 1px solid #f0f0f0;
        }
        .item-lista img {
            width: 40px; height: 40px; object-fit: contain; 
            background: #f9f9f9; border-radius: 6px; margin-right: 10px; border: 1px solid #eee;
        }
        
        /* --- A√á√ïES R√ÅPIDAS (Grid Ajustado) --- */
        .grid-acoes { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .btn-acao { 
            background: white; border: 1px solid #eee; border-radius: 10px; 
            padding: 8px; text-align: center; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .btn-acao img { width: 35px; height: 35px; object-fit: contain; margin-bottom: 5px; }
        .btn-acao small { font-size: 9px; line-height: 1.1; font-weight: bold; }

        /* --- CONTROLES FILHO (Header) --- */
        .grupo-filho { display: flex; align-items: center; gap: 5px; }
        .grupo-filho select { margin: 0; border: none; background: transparent; font-weight: bold; font-size: 16px; width: auto; padding-right: 25px; }
        
        /* --- SWITCH --- */
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2ecc71; }
        input:checked + .slider:before { transform: translateX(20px); }

        /* --- MONITORAMENTO --- */
        .pc-status-card { display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; padding: 12px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #eee; }
        .timeline-box { background: white; border-radius: 10px; padding: 5px; min-height: 50px; }
        .tl-item { display: flex; align-items: center; padding: 10px; margin-bottom: 10px; background: #fff; border: 1px solid #eee; border-radius: 10px; }
        .tl-time { background: #3498db; color: white; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; margin-right: 10px; min-width: 35px; text-align: center; }
        .tl-img { width: 35px; height: 35px; object-fit: contain; margin-right: 10px; }
        .tl-item.passado { opacity: 0.5; filter: grayscale(100%); }
        .tl-item.proximo { border: 2px solid #e67e22; background: #fff8e1; }
        
        /* --- GR√ÅFICO --- */
        .grafico-container { display: flex; align-items: flex-end; gap: 8px; height: 120px; padding-top: 25px; overflow-x: auto; padding-bottom: 5px; }
        .barra-wrapper { display: flex; flex-direction: column; align-items: center; min-width: 30px; position: relative; }
        .barra { width: 14px; background: #3498db; border-radius: 4px 4px 0 0; }
        .barra-valor { position: absolute; top: -20px; font-size: 9px; font-weight: bold; width: 100%; text-align: center; }
        .barra-dia { font-size: 9px; color: #888; margin-top: 4px; }

    </style>
</head>
<body>

    <div id="telaLogin" class="tela-login" style="display:flex;">
        <div style="width: 80%; max-width: 300px; text-align: center;">
            <h1 style="color:#3498db; margin-bottom: 30px;">üîê Super Rotina</h1>
            <input type="email" id="email" placeholder="E-mail">
            <input type="password" id="senha" placeholder="Senha">
            <button class="btn-blue" onclick="fazerLogin()">Entrar</button>
            <button class="btn-green" onclick="criarConta()">Criar Conta</button>
        </div>
    </div>

    <div id="appHeader" class="app-header" style="display:none;">
        <div class="grupo-filho">
            <select id="selectFilho" onchange="mudarFilho()"></select>
            <button onclick="novoFilho()" class="btn-green btn-icon" style="width:28px; height:28px; font-size:14px; border-radius:50%">+</button>
        </div>
        <div style="display:flex; align-items:center; gap:10px;">
            <span id="displayCodigo" style="background:#fff8e1; padding:4px 8px; border-radius:8px; font-size:11px; color:#f1c40f; font-weight:bold; letter-spacing:1px">...</span>
            <button onclick="sair()" class="btn-red btn-icon" style="width:28px; height:28px; font-size:12px; border-radius:50%">üö™</button>
        </div>
    </div>

    <div id="mainContent" style="display:none;">
        
        <div id="tab-home" class="tela ativa">
            <div class="card">
                <h2>üó∫Ô∏è Mapa do Dia</h2>
                <div id="timelineInteligente" class="timeline-box"><p style="text-align:center; color:#999; font-size:12px; margin-top:15px">Carregando roteiro...</p></div>
            </div>
            <div class="card">
                <h2>üñ•Ô∏è Status PC</h2>
                <div id="painelMonitoramento"></div>
                <div id="listaDispositivos" style="display:none;"></div>
            </div>
        </div>

        <div id="tab-criar" class="tela">
            <div class="card">
                <h2>üé® Nova Atividade</h2>
                <input type="hidden" id="editIdAtividade">
                
                <div style="display:flex; gap:10px">
                    <div style="flex:2"><label>ID (Nome Curto)</label><input type="text" id="idAtividade" placeholder="ex: banho"></div>
                    <div style="flex:1"><label>Tempo(s)</label><input type="number" id="tempoAtividade" placeholder="15"></div>
                </div>
                
                <div><label>Texto Principal</label><input type="text" id="txtAtividade" placeholder="O que vai aparecer escrito?"></div>
                
                <div style="background:#f9f9f9; padding:10px; border-radius:10px; border:1px solid #eee; margin-bottom:10px">
                    <label style="margin-bottom:8px">üñºÔ∏è Imagem (Galeria ou Digite)</label>
                    <div id="galVisual" class="galeria-v"></div>
                    <input type="text" id="imgAtividade" oninput="atualizarPreview()" placeholder="IMG/1.gif" style="margin-bottom:5px">
                    
                    <div style="display:flex; align-items:center; gap:10px; margin-top:10px">
                        <div style="flex:1">
                            <label>Tamanho: <span id="labelTamanho">150px</span></label>
                            <input type="range" id="rangeTamanho" min="50" max="300" value="150" oninput="atualizarPreview()" style="width:100%">
                        </div>
                        <div style="width:60px; height:60px; display:flex; align-items:center; justify-content:center; border:1px dashed #ccc; background:white; border-radius:6px; overflow:hidden">
                            <img id="previewAvatar" src="" style="max-width:100%; max-height:100%">
                        </div>
                    </div>
                </div>

                <div style="background:#fff; border:1px solid #eee; padding:10px; border-radius:10px; margin-bottom:10px">
                    <label style="color:#3498db; margin-bottom:10px; display:block">üïí Avisos de Antecipa√ß√£o (Opcional)</label>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:5px">
                        <div><label>Aviso 5 min</label><input type="text" id="txt5min" placeholder="Texto"></div>
                        <div><label>Imagem 5 min</label><input type="text" id="img5min" placeholder="IMG/..."></div>
                    </div>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                        <div><label>Aviso 3 min</label><input type="text" id="txt3min" placeholder="Texto"></div>
                        <div><label>Imagem 3 min</label><input type="text" id="img3min" placeholder="IMG/..."></div>
                    </div>
                </div>

                <label>Posi√ß√£o na Tela</label>
                <select id="posAtividade">
                    <option value="center">Centro</option>
                    <option value="bottom-right">‚Üò Baixo Direita</option>
                    <option value="top-center">‚¨Ü Topo Centro</option>
                    <option value="top-right">‚Üó Topo Direita</option>
                </select>

                <div style="display:flex; justify-content:space-between; margin-bottom:15px; padding:0 5px">
                    <div style="display:flex; align-items:center; gap:5px">Voz <label class="switch"><input type="checkbox" id="checkVoz" checked><span class="slider"></span></label></div>
                    <div style="display:flex; align-items:center; gap:5px">Bloquear <label class="switch"><input type="checkbox" id="checkBlock"><span class="slider"></span></label></div>
                </div>

                <div style="display:flex; gap:10px">
                    <button class="btn-blue" onclick="salvarAtividade()">üíæ Salvar</button>
                    <button style="background:#95a5a6; color:white;" onclick="limparFormAtividade()">Limpar</button>
                </div>
            </div>

            <div class="card">
                <h3>Atividades Salvas</h3>
                <ul id="listaAtividades" style="padding:0; list-style:none; max-height:300px; overflow-y:auto"></ul>
            </div>
        </div>

        <div id="tab-agenda" class="tela">
            <div class="card">
                <h2>üìÖ Novo Agendamento</h2>
                <input type="hidden" id="editIdRotina">
                <div style="display:flex; gap:10px">
                    <div style="flex:1"><label>Hora</label><input type="time" id="horaRotina"></div>
                    <div style="flex:1">
                        <label>Dia</label>
                        <select id="diaRotina">
                            <option value="todos">Todos</option>
                            <option value="1">Seg</option><option value="2">Ter</option><option value="3">Qua</option>
                            <option value="4">Qui</option><option value="5">Sex</option><option value="6">S√°b</option><option value="0">Dom</option>
                        </select>
                    </div>
                </div>
                <div style="display:flex; gap:10px; align-items:flex-end">
                    <div style="flex:1"><label>Atividade</label><select id="selectAtividadeRotina"></select></div>
                    <button class="btn-green" style="width:60px; margin-bottom:10px" onclick="salvarRotina()">OK</button>
                </div>
            </div>
            
            <div class="card">
                <h2>Semana (Arraste para o lado)</h2>
                <div class="calendario-wrapper">
                    <div id="calendarioContainer" style="display:flex; gap:8px;"></div>
                </div>
            </div>
            
            <div class="card">
                <h2>üìä Hist√≥rico</h2>
                <div id="graficoHistorico" class="grafico-container"></div>
            </div>
        </div>

        <div id="tab-controle" class="tela">
            <div class="card">
                <h2>üéÆ A√ß√µes R√°pidas</h2>
                <div id="gridAcoes" class="grid-acoes"></div>
            </div>
            <div class="card">
                <h2>Comandos Gerais</h2>
                <div style="display:flex; gap:10px">
                    <button onclick="enviarAcao('livre')" style="background:#95a5a6; color:white">üîì LIBERAR</button>
                    <button onclick="enviarAcao('bloqueio')" class="btn-red">üîí BLOQUEAR</button>
                </div>
            </div>
        </div>

    </div>

    <div id="bottomNav" class="bottom-nav" style="display:none;">
        <button class="nav-item ativo" onclick="mudarAba('home')"><span>üè†</span>In√≠cio</button>
        <button class="nav-item" onclick="mudarAba('criar')"><span>üé®</span>Criar</button>
        <button class="nav-item" onclick="mudarAba('agenda')"><span>üìÖ</span>Agenda</button>
        <button class="nav-item" onclick="mudarAba('controle')"><span>üéÆ</span>Controle</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot, deleteDoc, updateDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyAh3J8bp7xvNGct8k4TfAoCcIpVRoWjBYI", authDomain: "rotinaeduardo.firebaseapp.com", projectId: "rotinaeduardo", storageBucket: "rotinaeduardo.firebasestorage.app", messagingSenderId: "210945268922", appId: "1:210945268922:web:ce9e585872090b378d7683" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app);
        let usuarioAtual, filhoAtualId, cacheAtividades={}, cacheRotinas={}, unsubs = [];

        // --- SISTEMA DE ABAS ---
        window.mudarAba = (aba) => {
            document.querySelectorAll('.tela').forEach(t => t.classList.remove('ativa'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('ativo'));
            document.getElementById(`tab-${aba}`).classList.add('ativa');
            const btnIndex = { 'home':0, 'criar':1, 'agenda':2, 'controle':3 };
            document.querySelectorAll('.nav-item')[btnIndex[aba]].classList.add('ativo');
        };

        // --- GALERIA AUTOM√ÅTICA ---
        function montarGaleriaInfinita() {
            const container = document.getElementById('galVisual');
            if(!container) return; container.innerHTML = "";
            const nomes = ["ARRUMANDO_CAMA", "BANHO", "BOCEJANDO", "COMER", "DESLIGAR-PC", "LIGAR-PC", "ESCOVANDO_DENTES"];
            for(let i=1; i<=50; i++) nomes.push(`${i}`); 

            nomes.forEach(nomeBase => {
                [".gif", ".png", ".jpg", ".GIF", ".PNG", ".JPG"].forEach(ext => {
                    const nomeArq = nomeBase.includes('.') ? nomeBase : nomeBase + ext;
                    const img = new Image();
                    img.src = `IMG/${nomeArq}`; 
                    img.className = 'img-sel';
                    img.onload = () => { 
                        if(!container.querySelector(`img[src*="${nomeBase}"]`)) { // Evita duplicatas visuais
                            img.classList.add('visivel'); container.appendChild(img); 
                        }
                    };
                    img.onclick = () => {
                        document.querySelectorAll('.img-sel').forEach(i => i.classList.remove('ativa'));
                        img.classList.add('ativa'); document.getElementById('imgAtividade').value = `IMG/${nomeArq}`;
                        window.atualizarPreview();
                    };
                });
            });
        }

        // --- AUTH ---
        window.fazerLogin = async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('senha').value); } catch(e){alert(e.message)} };
        window.criarConta = async () => { try { await createUserWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('senha').value); } catch(e){alert(e.message)} };
        window.sair = () => { signOut(auth); location.reload(); };
        
        onAuthStateChanged(auth, (u) => { 
            if(u) { 
                usuarioAtual=u; 
                document.getElementById('telaLogin').style.display='none';
                document.getElementById('appHeader').style.display='flex';
                document.getElementById('bottomNav').style.display='flex';
                document.getElementById('mainContent').style.display='block';
                carregarFilhos(); 
                montarGaleriaInfinita(); 
            } else { 
                document.getElementById('telaLogin').style.display='flex';
            } 
        });

        // --- FUN√á√ïES ---
        window.atualizarPreview = () => { const r = document.getElementById('rangeTamanho').value; const u = document.getElementById('imgAtividade').value; document.getElementById('labelTamanho').innerText = r + "px"; const i = document.getElementById('previewAvatar'); i.style.width = "auto"; i.style.height = "auto"; if(u) i.src = u; };
        
        function carregarFilhos() { onSnapshot(collection(db, `usuarios/${usuarioAtual.uid}/filhos`), (s) => { const sel = document.getElementById('selectFilho'); sel.innerHTML=""; let tem=false; s.forEach(d=>{ tem=true; let o=document.createElement('option'); o.value=d.id; o.innerText=d.data().nome; sel.appendChild(o); }); if(!tem) novoFilho(); else { if(!filhoAtualId) filhoAtualId=sel.value; carregarDadosFilho(); } }); }
        window.novoFilho = async () => { const n = prompt("Nome:"); if(n){ const c = Math.random().toString(36).substring(2,8).toUpperCase(); const r = await addDoc(collection(db, `usuarios/${usuarioAtual.uid}/filhos`), { nome: n, codigo_pareamento: c }); await setDoc(doc(db, "conexoes", c), { caminho_dados: `usuarios/${usuarioAtual.uid}/filhos/${r.id}` }); mudarFilho(); }};
        window.excluirFilho = async () => { if(confirm("Excluir?")) { await deleteDoc(doc(db, `usuarios/${usuarioAtual.uid}/filhos`, filhoAtualId)); location.reload(); }};
        window.mudarFilho = () => { filhoAtualId=document.getElementById('selectFilho').value; unsubs.forEach(f=>f()); unsubs=[]; carregarDadosFilho(); };

        function carregarDadosFilho() {
            if(!filhoAtualId) return;
            const base = `usuarios/${usuarioAtual.uid}/filhos/${filhoAtualId}`;
            getDoc(doc(db, base)).then(d => { if(d.exists()) document.getElementById('displayCodigo').innerText=d.data().codigo_pareamento; });

            unsubs.push(onSnapshot(collection(db, `${base}/dispositivos`), (snap) => {
                const boxM = document.getElementById('painelMonitoramento'); boxM.innerHTML = "";
                if(snap.empty) boxM.innerHTML = "<p style='text-align:center;color:#999;font-size:12px'>Nenhum PC Conectado</p>";
                snap.forEach(d => {
                    const dev = d.data(); const isO = dev.online && (new Date() - dev.online.toDate() < 120000);
                    const h = Math.floor((dev.tempo_hoje_minutos||0)/60); const m = (dev.tempo_hoje_minutos||0)%60;
                    boxM.innerHTML += `<div class="pc-status-card"><div><strong>${dev.nome||"PC"}</strong> <span class="pc-badge ${isO?'badge-online':'badge-offline'}">${isO?'ON':'OFF'}</span></div><div>${h}h ${m}m</div></div>`;
                });
            }));

            unsubs.push(onSnapshot(query(collection(db, `${base}/historico_uso`), orderBy("data", "desc"), limit(7)), (snap) => {
                const box = document.getElementById('graficoHistorico'); box.innerHTML = "";
                let d = []; snap.forEach(doc => d.push(doc.data())); d.reverse();
                if(d.length===0) return box.innerHTML="<small>Sem hist√≥rico</small>";
                let max = Math.max(...d.map(x => x.minutos), 1);
                d.forEach(i => {
                    const alt = (i.minutos/max)*80; 
                    box.innerHTML += `<div class="barra-wrapper"><div class="barra-valor">${i.minutos>60?(i.minutos/60).toFixed(1)+'h':i.minutos+'m'}</div><div class="barra" style="height:${Math.max(alt,5)}px"></div><div class="barra-dia">${i.data.split('-')[2]}</div></div>`;
                });
            }));

            unsubs.push(onSnapshot(collection(db, `${base}/atividades`), (snap) => {
                const l = document.getElementById('listaAtividades'); const s = document.getElementById('selectAtividadeRotina'); const g = document.getElementById('gridAcoes');
                l.innerHTML=""; s.innerHTML=""; g.innerHTML=""; cacheAtividades={};
                snap.forEach(d => {
                    const dd = d.data(); cacheAtividades[d.id] = dd;
                    // LISTA MENOR
                    l.innerHTML += `<li class="item-lista">
                        <div style="display:flex; align-items:center"><img src="${dd.imagem}"> <b>${d.id}</b></div>
                        <div><button class="btn-small" style="background:#f39c12; margin-right:5px; color:white" onclick="carregarEdicaoAtividade('${d.id}')">‚úèÔ∏è</button><button class="btn-red btn-small" onclick="apagarAtividade('${d.id}')">X</button></div>
                    </li>`;
                    s.innerHTML += `<option value="${d.id}">${d.id}</option>`;
                    // GRID MENOR
                    g.innerHTML += `<div class="btn-acao" onclick="enviarAcao('${d.id}')"><img src="${dd.imagem}"><br><small>${d.id}</small></div>`;
                });
                renderizarTimeline();
            }));

            unsubs.push(onSnapshot(collection(db, `${base}/rotinas`), (snap) => {
                cacheRotinas={}; snap.forEach(d => cacheRotinas[d.id]=d.data());
                const c=document.getElementById('calendarioContainer'); c.innerHTML="";
                const dias=["DOM","SEG","TER","QUA","QUI","SEX","S√ÅB"];
                for(let i=0; i<7; i++) c.innerHTML+=`<div class="dia-coluna"><div style="text-align:center; font-weight:bold; border-bottom:1px solid #eee; margin-bottom:5px; color:#3498db; font-size:12px">${dias[i]}</div><div id="col-${i}"></div></div>`;
                Object.entries(cacheRotinas).forEach(([id, r]) => {
                    const h=`<div class="card-rotina"><b>${r.hora}</b> ${r.acao} <button class="btn-del-mini" onclick="apagarRotina('${id}')">x</button></div>`;
                    if(r.dia_semana==='todos') for(let i=0;i<7;i++) document.getElementById(`col-${i}`).innerHTML+=h;
                    else try{document.getElementById(`col-${r.dia_semana}`).innerHTML+=h}catch(e){}
                });
                renderizarTimeline();
            }));
        }

        function renderizarTimeline() {
            const t = document.getElementById('timelineInteligente'); if(!t) return; t.innerHTML="";
            const hoje = new Date(); const dS = hoje.getDay().toString(); const hA = hoje.getHours()*60+hoje.getMinutes();
            let prox=false;
            const lista = Object.values(cacheRotinas).filter(r=>r.dia_semana==='todos'||r.dia_semana===dS).sort((a,b)=>a.hora.localeCompare(b.hora));
            if(lista.length===0) return t.innerHTML="<p style='color:#999; text-align:center; font-size:12px'>Sem rotina hoje</p>";
            
            lista.forEach(r=>{
                const [h,m] = r.hora.split(':').map(Number); const min = h*60+m;
                let cl = min < hA ? "passado" : (!prox ? (prox=true, "proximo") : "futuro");
                const img = cacheAtividades[r.acao]?.imagem || '';
                t.innerHTML += `<div class="tl-item ${cl}"><div class="tl-time">${r.hora}</div><img src="${img}" class="tl-img"><b>${r.acao}</b></div>`;
            });
        }

        window.salvarAtividade = async () => { const id = document.getElementById('idAtividade').value.toLowerCase().replace(/\s/g,''); if(!id) return alert("ID?"); await setDoc(doc(db, `usuarios/${usuarioAtual.uid}/filhos/${filhoAtualId}/atividades`, id), { texto: document.getElementById('txtAtividade').value, imagem: document.getElementById('imgAtividade').value, tempo_personalizado: document.getElementById('tempoAtividade').value, tamanho_avatar: document.getElementById('rangeTamanho').value, texto_5min: document.getElementById('txt5min').value, texto_3min: document.getElementById('txt3min').value, imagem_5min: document.getElementById('img5min').value, imagem_3min: document.getElementById('img3min').value, posicao_especifica: document.getElementById('posAtividade').value, falar_texto: document.getElementById('checkVoz').checked, bloquear_tela: document.getElementById('checkBlock').checked }); alert("Salvo!"); limparFormAtividade(); };
        window.salvarRotina = async () => { await addDoc(collection(db, `usuarios/${usuarioAtual.uid}/filhos/${filhoAtualId}/rotinas`), { hora: document.getElementById('horaRotina').value, dia_semana: document.getElementById('diaRotina').value, acao: document.getElementById('selectAtividadeRotina').value }); };
        window.apagarAtividade = async(id) => { if(confirm("Apagar?")) await deleteDoc(doc(db, `usuarios/${usuarioAtual.uid}/filhos/${filhoAtualId}/atividades`, id)); };
        window.apagarRotina = async(id) => { if(confirm("Apagar?")) await deleteDoc(doc(db, `usuarios/${usuarioAtual.uid}/filhos/${filhoAtualId}/rotinas`, id)); };
        window.enviarAcao = async(a) => { await setDoc(doc(db, `usuarios/${usuarioAtual.uid}/filhos/${filhoAtualId}/config/estado_atual`), {acao:a, timestamp:new Date()}, {merge:true}); };
        window.carregarEdicaoAtividade = (id) => { const d=cacheAtividades[id]; if(d) { document.getElementById('idAtividade').value=id; document.getElementById('idAtividade').disabled=true; document.getElementById('editIdAtividade').value=id; document.getElementById('txtAtividade').value=d.texto||""; document.getElementById('imgAtividade').value=d.imagem||""; document.getElementById('tempoAtividade').value=d.tempo_personalizado||""; document.getElementById('rangeTamanho').value=d.tamanho_avatar||"150"; document.getElementById('txt5min').value=d.texto_5min||""; document.getElementById('txt3min').value=d.texto_3min||""; document.getElementById('img5min').value=d.imagem_5min||""; document.getElementById('img3min').value=d.imagem_3min||""; document.getElementById('posAtividade').value=d.posicao_especifica||"center"; document.getElementById('checkVoz').checked=(d.falar_texto!==false); document.getElementById('checkBlock').checked=(d.bloquear_tela===true); atualizarPreview(); mudarAba('criar'); }};
        window.limparFormAtividade = () => { document.getElementById('idAtividade').value=""; document.getElementById('txtAtividade').value=""; document.getElementById('imgAtividade').value=""; document.getElementById('idAtividade').disabled=false; document.getElementById('previewAvatar').src=""; };
    </script>
</body>
</html>
