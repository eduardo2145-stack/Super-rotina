<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Super Rotina Pro - Mobile</title>
<style>
/* === ESTILO MOBILE APP NATIVO === */
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { 
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
  margin: 0; padding: 0; color: #333; height: 100vh; overflow: hidden;
  -webkit-font-smoothing: antialiased;
}

/* TELA LOGIN - SPLASH MOBILE */
.tela { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100vh; overflow-y: auto; }
.tela.ativa { display: block; }
.box-login { 
  max-width: 100%; margin: 0; background: rgba(255,255,255,0.95); padding: 60px 30px 40px; text-align: center; 
  backdrop-filter: blur(20px); height: 100vh; display: flex; flex-direction: column; justify-content: center;
}
.box-login h1 { font-size: 2.5em; margin: 0 0 40px; background: linear-gradient(45deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

/* BARRA SUPERIOR NAVEGAÃ‡ÃƒO */
.header-app { 
  background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); padding: 15px 20px; display: flex; 
  justify-content: space-between; align-items: center; box-shadow: 0 2px 20px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100;
}
.header-app h1 { margin: 0; font-size: 1.2em; font-weight: 700; color: #2c3e50; }
.btn-icon { background: none; border: none; font-size: 1.5em; padding: 8px; border-radius: 50%; color: #666; cursor: pointer; transition: all 0.2s; }
.btn-icon:active { transform: scale(0.95); background: rgba(0,0,0,0.1); }

/* SCROLL SECTIONS MOBILE */
.main-grid { display: flex; flex-direction: column; gap: 15px; padding: 20px; max-width: 100%; overflow-y: auto; height: calc(100vh - 80px); }
.card { 
  background: rgba(255,255,255,0.95); backdrop-filter: blur(15px); padding: 25px; border-radius: 20px; 
  box-shadow: 0 8px 32px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.2); position: relative; overflow: hidden;
}
.card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #667eea, #764ba2); }
.card h2 { margin: 0 0 20px; font-size: 1.3em; color: #2c3e50; font-weight: 700; display: flex; align-items: center; gap: 10px; }

.form-group { margin-bottom: 20px; }
label { display: block; font-size: 0.85em; font-weight: 600; margin-bottom: 8px; color: #555; text-transform: uppercase; letter-spacing: 0.5px; }
input, select { 
  width: 100%; padding: 16px 20px; border: 2px solid #e1e8ed; border-radius: 16px; font-size: 1em; 
  background: rgba(255,255,255,0.8); transition: all 0.3s; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
}
input:focus, select:focus { border-color: #667eea; outline: none; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); transform: translateY(-1px); }

/* CHECKBOXES MOBILE */
.devices-box { border: 2px solid #e1e8ed; padding: 15px; border-radius: 16px; max-height: 200px; overflow-y: auto; background: rgba(255,255,255,0.9); }
.device-label { display: flex; align-items: center; padding: 15px; border-radius: 12px; cursor: pointer; transition: all 0.2s; margin-bottom: 8px; background: rgba(255,255,255,0.7); }
.device-label:active { background: #667eea; color: white; transform: scale(0.98); }
.device-label input { width: 22px; height: 22px; margin-right: 15px; cursor: pointer; accent-color: #667eea; }

/* STATUS PC MOBILE */
.pc-status-card { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 16px; padding: 20px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid transparent; }
.pc-status-card.online { border-left-color: #2ecc71; box-shadow: 0 4px 15px rgba(46,204,113,0.2); }
.pc-info h3 { margin: 0; font-size: 1.1em; color: #2c3e50; }
.pc-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 700; }
.badge-online { background: rgba(46,204,113,0.2); color: #27ae60; }
.badge-offline { background: rgba(231,76,60,0.2); color: #e74c3c; }
.pc-timer { text-align: right; }
.pc-timer span { font-size: 1.4em; font-weight: 800; color: #333; display: block; }

/* GRÃFICO MOBILE */
.grafico-container { display: flex; align-items: flex-end; gap: 8px; height: 140px; padding: 15px 0; overflow-x: auto; padding-bottom: 10px; }
.barra-wrapper { display: flex; flex-direction: column; align-items: center; width: 45px; flex-shrink: 0; }
.barra { width: 24px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 12px 12px 0 0; transition: all 0.4s; box-shadow: 0 4px 12px rgba(102,126,234,0.3); }
.barra:active { transform: scale(1.1); }
.barra-valor, .barra-dia { font-size: 0.75em; font-weight: 700; }

/* BOTÃ•ES MOBILE APP */
button { 
  padding: 16px 24px; border: none; border-radius: 16px; cursor: pointer; font-weight: 700; font-size: 1em; 
  transition: all 0.2s; touch-action: manipulation; min-height: 52px; position: relative; overflow: hidden;
}
button:active { transform: translateY(2px); box-shadow: inset 0 4px 8px rgba(0,0,0,0.1); }
.btn-blue { background: linear-gradient(135deg, #667eea, #764ba2); box-shadow: 0 4px 15px rgba(102,126,234,0.4); color: white; }
.btn-green { background: linear-gradient(135deg, #2ecc71, #27ae60); box-shadow: 0 4px 15px rgba(46,204,113,0.4); color: white; }
.btn-red { background: linear-gradient(135deg, #e74c3c, #c0392b); box-shadow: 0 4px 15px rgba(231,76,60,0.4); color: white; padding: 12px 20px; font-size: 0.9em; min-width: 60px; }
.btn-trash { background: linear-gradient(135deg, #e74c3c, #c0392b); padding: 12px 16px; min-width: 50px; }

/* SWITCH MOBILE */
.switch-row { display: flex; align-items: center; justify-content: space-between; padding: 20px; background: rgba(255,255,255,0.8); border-radius: 16px; margin-bottom: 15px; }
.switch { position: relative; display: inline-block; width: 56px; height: 32px; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #ddd; transition: .3s; border-radius: 34px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
.slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 3px; bottom: 3px; background: white; transition: .3s; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
input:checked + .slider { background: #2ecc71; }
input:checked + .slider:before { transform: translateX(24px); }

/* LISTA MOBILE */
.lista-container { max-height: 250px; overflow-y: auto; margin-top: 15px; border-radius: 16px; }
li { background: rgba(255,255,255,0.9); border-radius: 12px; padding: 20px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: all 0.2s; }
li:active { transform: scale(0.98); }

/* CALENDÃRIO MOBILE */
.calendario-wrapper { overflow-x: auto; padding: 15px 0; -webkit-overflow-scrolling: touch; }
.dia-coluna { display: inline-block; width: 140px; vertical-align: top; background: rgba(255,255,255,0.9); margin-right: 12px; padding: 15px; border-radius: 20px; min-height: 180px; border: 1px solid rgba(255,255,255,0.3); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
.card-rotina { background: linear-gradient(135deg, #e3f2fd, #f0f8ff); border-left: 4px solid #667eea; padding: 12px; margin-bottom: 8px; border-radius: 12px; font-size: 0.9em; box-shadow: 0 2px 8px rgba(102,126,234,0.1); }

/* TIMELINE MOBILE */
.timeline-box { padding: 20px; background: rgba(255,255,255,0.95); border-radius: 20px; max-height: 300px; overflow-y: auto; margin-top: 10px; }
.tl-item { display: flex; align-items: center; margin-bottom: 20px; padding: 20px; border-radius: 20px; background: rgba(255,255,255,0.8); box-shadow: 0 4px 15px rgba(0,0,0,0.08); position: relative; transition: all 0.3s; border: 1px solid rgba(255,255,255,0.3); }
.tl-time { width: 60px; text-align: center; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 12px; border-radius: 16px; font-size: 1em; font-weight: 800; margin-right: 20px; box-shadow: 0 4px 12px rgba(102,126,234,0.3); }
.tl-item.proximo { border: 3px solid #f39c12; box-shadow: 0 8px 25px rgba(243,156,18,0.3); transform: scale(1.02); animation: pulse 2s infinite; }
@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(243,156,18,0.4); } 70% { box-shadow: 0 0 0 15px rgba(243,156,18,0); } 100% { box-shadow: 0 0 0 0 rgba(243,156,18,0); } }

/* MODAL MOBILE */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 3000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(10px); }
.modal-overlay.aberta { display: flex; }
.modal-content { background: rgba(255,255,255,0.98); width: 95%; max-height: 85vh; border-radius: 24px; padding: 35px 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow-y: auto; border-top: 6px solid #f39c12; margin: 20px; }

/* GRID AÃ‡Ã•ES MOBILE */
#gridAcoes { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 15px; margin: 20px 0; }
#gridAcoes > div { text-align: center; padding: 20px 10px; border-radius: 20px; cursor: pointer; background: rgba(255,255,255,0.8); transition: all 0.2s; border: 2px solid transparent; }
#gridAcoes > div:active { transform: scale(0.95); border-color: #667eea; box-shadow: 0 8px 25px rgba(102,126,234,0.3); }

/* AVISOS MOBILE */
.aviso-container { background: linear-gradient(135deg, #e3f2fd, #f0f8ff); border: 1px solid rgba(102,126,234,0.2); padding: 20px; border-radius: 16px; margin-bottom: 15px; }
.aviso-titulo { font-size: 1em; font-weight: 700; color: #667eea; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }

/* PREVIEW IMAGE MOBILE */
.form-group img#previewAvatar { max-width: 100%; max-height: 200px; border-radius: 16px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); }

/* RESPONSIVO ULTRA MOBILE */
@media (max-width: 480px) {
  .main-grid { padding: 15px; gap: 12px; }
  .card { padding: 20px 18px; }
  .header-app { padding: 12px 15px; }
  .modal-content { margin: 10px; padding: 25px 20px; }
  input, select, button { font-size: 1.1em; padding: 18px 20px; }
}
</style>
</head>
<body>

<!-- TELA LOGIN MOBILE -->
<div id="telaLogin" class="tela ativa">
<div class="box-login">
<h1>ğŸ” Super Rotina Pro</h1>
<input type="email" id="email" placeholder="ğŸ‘¤ E-mail" autocomplete="email">
<input type="password" id="senha" placeholder="ğŸ”’ Senha" autocomplete="current-password">
<button class="btn-blue" onclick="fazerLogin()">ğŸš€ Entrar</button>
<button class="btn-green" onclick="criarConta()">âœ¨ Nova Conta</button>
</div>
</div>

<!-- DASHBOARD MOBILE -->
<div id="telaDashboard" class="tela">
<div class="header-app">
<div style="display:flex; align-items:center; gap:12px;">
<span style="font-weight:700; color:#555; font-size:1.1em;">ğŸ‘¨â€ğŸ‘¦ Filho:</span>
<select id="selectFilho" onchange="mudarFilho()" style="padding:10px 15px; border:2px solid #667eea; border-radius:12px; background:white; font-weight:600;"></select>
<button onclick="novoFilho()" class="btn-icon" style="background:linear-gradient(135deg,#2ecc71,#27ae60);">â•</button>
<button onclick="excluirFilho()" class="btn-icon" title="Excluir Perfil" style="background:linear-gradient(135deg,#e74c3c,#c0392b);">ğŸ—‘ï¸</button>
</div>
<div style="display:flex; gap:10px; align-items:center;">
<button onclick="abrirDicas()" class="btn-icon" style="font-size:1.3em;">ğŸ’¡</button>
<span style="background:rgba(255,251,230,0.9); padding:8px 15px; border-radius:20px; font-weight:700; font-size:0.85em; color:#d4ac0d; border:1px solid #ffe58f;">CÃ“DIGO: <span id="displayCodigo">...</span></span>
<button onclick="sair()" class="btn-icon" style="background:linear-gradient(135deg,#e74c3c,#c0392b);">ğŸšª</button>
</div>
</div>

<div class="main-grid">
<!-- COLUNA 1 -->
<div class="card" style="border-top:6px solid #667eea;">
<h2>ğŸ¨ Criar Atividade</h2>
<!-- TODO O FORMULARIO AQUI (mantido igual) -->
<input type="hidden" id="editIdAtividade">
<div style="display:flex; gap:12px; margin-bottom:20px;">
<div class="form-group" style="flex:2"><label>ID (Nome Curto)</label><input type="text" id="idAtividade" placeholder="ex: banho"></div>
<div class="form-group" style="flex:1"><label>Tempo (s)</label><input type="number" id="tempoAtividade" placeholder="15"></div>
</div>
<div class="form-group"><label>Texto Principal</label><input type="text" id="txtAtividade" placeholder="DescriÃ§Ã£o da atividade"></div>
<div class="form-group"><label>ğŸ–¼ï¸ Imagem (URL)</label><input type="text" id="imgAtividade" oninput="atualizarPreview()" placeholder="https://..."></div>

<div class="form-group" style="text-align:center;">
<label style="margin-bottom:12px;">ğŸ“ Tamanho: <span id="labelTamanho" style="color:#667eea; font-weight:700">150px</span></label>
<input type="range" id="rangeTamanho" min="50" max="500" value="150" oninput="atualizarPreview()" style="width:100%;">
<div style="min-height: 120px; border: 2px dashed #e1e8ed; background: rgba(255,255,255,0.5); display: flex; align-items: center; justify-content: center; border-radius: 16px; margin-top:10px;">
<img id="previewAvatar" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" style="max-width:150px; max-height:150px; border-radius:16px;">
</div>
</div>

<div class="form-group">
<label>ğŸ“± Onde exibir? (Online = ğŸŸ¢)</label>
<div class="devices-box" id="listaDispositivos"><div style="padding:15px; color:#999; text-align:center;">Aguardando PC...</div></div>
</div>

<div class="aviso-container"><span class="aviso-titulo">ğŸ•’ Aviso 5 Minutos</span><input type="text" id="txt5min" placeholder="Texto aviso"><input type="text" id="img5min" placeholder="Imagem aviso"></div>
<div class="aviso-container"><span class="aviso-titulo">ğŸ•’ Aviso 3 Minutos</span><input type="text" id="txt3min" placeholder="Texto aviso"><input type="text" id="img3min" placeholder="Imagem aviso"></div>

<div class="form-group"><label>ğŸ“ PosiÃ§Ã£o</label>
<select id="posAtividade"><option value="">PadrÃ£o Geral</option><option value="top-left">â†– Topo Esquerda</option><option value="top-center">â¬† Topo Centro</option><option value="top-right">â†— Topo Direita</option
<option value="center">âº Centro da Tela</option><option value="bottom-left">â†™ Baixo Esquerda</option><option value="bottom-center">â¬‡ Baixo Centro</option><option value="bottom-right">â†˜ Baixo Direita</option></select>
</div>

<div class="switch-row"><span>ğŸ”Š Ler em voz alta?</span><label class="switch"><input type="checkbox" id="checkVoz" checked><span class="slider"></span></label></div>
<div class="switch-row"><span>ğŸ”’ Bloquear a Tela?</span><label class="switch"><input type="checkbox" id="checkBlock"><span class="slider"></span></label></div>

<div style="display:flex; gap:12px; margin-top:20px">
<button class="btn-blue" onclick="salvarAtividade()">ğŸ’¾ Salvar</button>
<button style="background:#95a5a6; color:white" onclick="limparFormAtividade()">ğŸ—‘ï¸ Limpar</button>
</div>
<div class="lista-container"><ul id="listaAtividades" style="padding:0; margin:0; list-style:none"></ul></div>
</div>

<!-- COLUNA 2 -->
<div class="card" style="border-top:6px solid #27ae60;">
<h2>ğŸ–¥ï¸ Computadores Online</h2>
<div id="painelMonitoramento" style="min-height:120px;">
<p style="text-align:center; color:#999; padding:40px 20px;">Carregando status...</p>
</div>
</div>

<div class="card" style="border-top:6px solid #3498db;">
<h2 id="tituloHistorico">ğŸ“Š Uso Hoje</h2>
<div id="graficoHistorico" class="grafico-container">
<small style="color:#999; display:block; text-align:center; padding:20px;">Aguardando dados...</small>
</div>
</div>

<div class="card" style="border-top:6px solid #f39c12;">
<h2>ğŸ“… Agendar Rotina</h2>
<input type="hidden" id="editIdRotina">
<div style="background:rgba(240,244,248,0.8); padding:20px; border-radius:16px; display:grid; gap:15px; grid-template-columns:1fr 1fr; margin-bottom:20px;">
<div class="form-group" style="margin:0"><label>Hora</label><input type="time" id="horaRotina"></div>
<div class="form-group" style="margin:0"><label>Dia</label><select id="diaRotina"><option value="todos">Todos</option><option value="1">Seg</option><option value="2">Ter</option><option value="3">Qua</option><option value="4">Qui</option><option value="5">Sex</option><option value="6">SÃ¡b</option><option value="0">Dom</option></select></div>
<div class="form-group" style="grid-column:1/-1"><label>Atividade</label><select id="selectAtividadeRotina"></select></div>
</div>
<div class="calendario-wrapper"><div id="calendarioContainer"></div></div>
</div>

<div class="card" style="border-top:6px solid #9b59b6;">
<h2>ğŸ—ºï¸ Hoje - Timeline</h2>
<div id="timelineInteligente" class="timeline-box">
<div style="text-align:center; color:#888; padding:40px 20px;">Carregando roteiro...</div>
</div>
</div>

<div class="card" style="border-top:6px solid #e67e22;">
<h2>ğŸ® AÃ§Ãµes RÃ¡pidas</h2>
<div id="gridAcoes"></div>
<div style="display:flex; gap:12px; margin-top:20px;">
<button onclick="enviarAcao('livre')" class="btn-blue" style="flex:1;">ğŸ”“ LIBERAR</button>
<button onclick="enviarAcao('bloqueio')" class="btn-red" style="flex:1;">ğŸ”’ BLOQUEAR</button>
</div>
</div>
</div>
</div>

<!-- MODAL DICAS MOBILE -->
<div id="modalDicas" class="modal-overlay">
<div class="modal-content">
<h2 style="margin:0 0 25px; color:#2c3e50; font-size:1.5em;">ğŸ’¡ 5 Pilares Rotina Autismo</h2>
<div style="margin-bottom:25px;">
<div style="margin-bottom:20px; padding-bottom:20px; border-bottom:1px solid #eee;">
<div style="font-size:1.2em; font-weight:700; color:#667eea; margin-bottom:10px; display:flex; align-items:center; gap:12px;">ğŸ”® 1. AntecipaÃ§Ã£o</div>
<p style="color:#555; line-height:1.5;">Use avisos de 5 e 3 minutos antes das transiÃ§Ãµes.</p>
</div>
<div style="margin-bottom:20px; padding-bottom:20px; border-bottom:1px solid #eee;">
<div style="font-size:1.2em; font-weight:700; color:#667eea; margin-bottom:10px; display:flex; align-items:center; gap:12px;">ğŸ§  2. Visual</div>
<p style="color:#555; line-height:1.5;">Imagens claras e Ã­cones ajudam na compreensÃ£o.</p>
</div>
<div style="margin-bottom:20px; padding-bottom:20px; border-bottom:1px solid #eee;">
<div style="font-size:1.2em; font-weight:700; color:#667eea; margin-bottom:10px; display:flex; align-items:center; gap:12px;">â° 3. Tempo</div>
<p style="color:#555; line-height:1.5;">Timers visuais reduzem ansiedade nas mudanÃ§as.</p>
</div>
</div>
<button class="btn-blue" onclick="fecharDicas()" style="width:100%; padding:18px; font-size:1.1em;">âœ… Entendi</button>
</div>
</div>

<!-- SCRIPT COMPLETO (IDÃŠNTICO AO ORIGINAL) -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot, deleteDoc, updateDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

const firebaseConfig = { apiKey: "AIzaSyAh3J8bp7xvNGct8k4TfAoCcIpVRoWjBYI", authDomain: "rotinaeduardo.firebaseapp.com", projectId: "rotinaeduardo", storageBucket: "rotinaeduardo.firebasestorage.app", messagingSenderId: "210945268922", appId: "1:210945268922:web:ce9e585872090b378d7683", measurementId: "G-MDYWRH9RNP" };
const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app);
let usuarioAtual, filhoAtualId, cacheAtividades={}, cacheRotinas={}, unsubscribeAtividades, unsubscribeRotinas, unsubscribeDispositivos, unsubscribeHistorico;

window.fazerLogin = async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('senha').value); } catch(e){alert(e.message)} };
window.criarConta = async () => { try { await createUserWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('senha').value); } catch(e){alert(e.message)} };
window.sair = () => signOut(auth);

onAuthStateChanged(auth, (u) => {
if(u) { usuarioAtual=u; document.getElementById('telaLogin').classList.remove('ativa'); document.getElementById('telaDashboard').classList.add('ativa'); carregarFilhos(); }
else { document.getElementById('telaLogin').classList.add('ativa'); document.getElementById('telaDashboard').classList.remove('ativa'); }
});

window.atualizarPreview = () => { const range = document.getElementById('rangeTamanho').value; const url = document.getElementById('imgAtividade').value; const img = document.getElementById('previewAvatar'); document.getElementById('labelTamanho').innerText = range + "px"; img.style.width = range + "px"; img.style.height = range + "px"; if(url && url.length > 5) img.src = url; };

function carregarFilhos() { const sel = document.getElementById('selectFilho'); onSnapshot(collection(db, `usuarios/${usuarioAtual.uid}/filhos`), (s) => { sel.innerHTML=""; let tem=false; s.forEach(d=>{ tem=true; let o=document.createElement('option'); o.value=d.id; o.innerText=d.data().nome; sel.appendChild(o); }); if(!tem) novoFilho(); else { if(!filhoAtualId) filhoAtualId=sel.value; if(sel.querySelector(`option[value="${filhoAtualId}"]`)) sel.value=filhoAtualId; else { sel.value = sel.options[0].value; filhoAtualId = sel.value; } carregarDadosFilho(); } }); }

window.novoFilho = async () => { const n = prompt("Nome do Filho:"); if(!n) return; const c = Math.random().toString(36).substring(2,8).toUpperCase(); const r = await addDoc(collection(db, `usuarios/${usuarioAtual.uid}/filhos`), { nome: n, codigo_pareamento: c }); await setDoc(doc(db, "conexoes", c), { caminho_dados: `usuarios/${usuarioAtual.uid}/filhos/${r.id}` }); mudarFilho(); };
window.excluirFilho = async () => { if(!filhoAtualId) return; if(confirm("Excluir perfil?")) { await deleteDoc(doc(db, `usuarios/${usuarioAtual.uid}/filhos`, filhoAtualId)); location.reload(); } };
window.mudarFilho = () => { filhoAtualId=document.getElementById('selectFilho').value; carregarDadosFilho(); };

function carregarDadosFilho() {
if(!filhoAtualId) return;
const base = `usuarios/${usuarioAtual.uid}/filhos/${filhoAtualId}`;
getDoc(doc(db, base)).then(d => { if(d.exists()) document.getElementById('displayCodigo').innerText=d.data().codigo_pareamento; });

if(unsubscribeDispositivos) unsubscribeDispositivos();
if(unsubscribeAtividades) unsubscribeAtividades();
if(unsubscribeRotinas) unsubscribeRotinas();
if(unsubscribeHistorico) unsubscribeHistorico();

// 1. MONITORAMENTO
unsubscribeDispositivos = onSnapshot(collection(db, `${base}/dispositivos`), (snap) => {
const boxSelect = document.getElementById('listaDispositivos');
const boxMonitor = document.getElementById('painelMonitoramento');
let htmlSelect = `<label class="device-label"><input type="checkbox" id="dev_todos" value="todos" checked> <b>ğŸ“± Todos</b></label>`;
let htmlMonitor = "";

if(snap.empty) {
htmlSelect += `<div style="padding:15px; color:#999; font-size:0.9em; text-align:center">Aguardando PC...</div>`;
htmlMonitor = `<div style="padding:40px 20px; text-align:center; color:#999">Nenhum computador conectado.</div>`;
} else {
let devices = [];
snap.forEach(d => { let obj = d.data(); obj.id = d.id; devices.push(obj); });
devices.sort((a,b) => (b.online?.toDate() || 0) - (a.online?.toDate() || 0));

devices.forEach(dev => {
const isOnline = dev.online && (new Date() - dev.online.toDate() < 120000);
const statusDot = isOnline ? "ğŸŸ¢" : "âšª";

let tempoDiario = "--";
if(dev.tempo_hoje_minutos !== undefined) {
const h = Math.floor(dev.tempo_hoje_minutos / 60);
const m = dev.tempo_hoje_minutos % 60;
tempoDiario = `${h}h ${m}m`;
}

htmlSelect += `<label class="device-label"><input type="checkbox" name="dev_item" value="${dev.id}"> ${statusDot} ${dev.nome || "PC"}</label>`;

htmlMonitor += `
<div class="pc-status-card ${isOnline ? 'online' : ''}">
<div class="pc-info">
<h3>ğŸ’» ${dev.nome || "Computador"}</h3>
<span class="pc-badge ${isOnline ? 'badge-online' : 'badge-offline'}">${isOnline ? 'ğŸŸ¢ ONLINE' : 'âšª OFFLINE'}</span>
</div>
<div style="display:flex; align-items:center;">
<div class="pc-timer">
<small>HOJE</small><span>${tempoDiario}</span>
</div>
<button class="btn-trash btn-del-device" onclick="apagarDispositivo('${dev.id}')" title="Remover">ğŸ—‘ï¸</button>
</div>
</div>`;
});
}
boxSelect.innerHTML = htmlSelect;
boxMonitor.innerHTML = htmlMonitor;
});

// 2. HISTÃ“RICO
const histRef = query(collection(db, `${base}/historico_uso`), orderBy("data", "desc"), limit(31));
unsubscribeHistorico = onSnapshot(histRef, (snap) => {
const box = document.getElementById('graficoHistorico');
if(snap.empty) { box.innerHTML = "<small style='color:#999; display:block; text-align:center; padding:20px;'>Sem histÃ³rico.</small>"; return; }

let dados = [];
let totalMinutosMes = 0;
const mesAtual = new Date().toISOString().slice(0, 7);

snap.forEach(d => {
const dia = d.data();
if(dia.data.startsWith(mesAtual)) {
totalMinutosMes += (dia.minutos || 0);
}
dados.push(dia);
});

const hTotal = Math.floor(totalMinutosMes / 60);
const mTotal = totalMinutosMes % 60;
const metaInfo = `MÃªs: ${hTotal}h ${mTotal}m`;

let html = "";
let dadosGrafico = dados.slice(0, 7).reverse();
let max = Math.max(...dadosGrafico.map(d => d.minutos), 1);

dadosGrafico.forEach(d => {
const altura = Math.max(8, (d.minutos / max) * 100);
const diaFormat = d.data.split('-')[2] + '/' + d.data.split('-')[1];
const valorLabel = d.minutos > 60 ? (d.minutos / 60).toFixed(1) + 'h' : d.minutos + 'm';

html += `
<div class="barra-wrapper">
<div class="barra-valor">${valorLabel}</div>
<div class="barra" style="height:${altura}px"></div>
<div class="barra-dia">${diaFormat}</div>
</div>`;
});

box.innerHTML = html;
const tituloHist = document.getElementById('tituloHistorico');
if(tituloHist) tituloHist.innerHTML = `ğŸ“Š Uso Hoje <span style="float:right; color:#3498db; font-size:0.9em;">${metaInfo}</span>`;
});

// 3. ATIVIDADES
unsubscribeAtividades = onSnapshot(collection(db, `${base}/atividades`), (snap) => {
const l=document.getElementById('listaAtividades'); const s=document.getElementById('selectAtividadeRotina'); const g=document.getElementById('gridAcoes');
l.innerHTML=""; s.innerHTML=""; g.innerHTML=""; cacheAtividades={};
snap.forEach(d => {
const dd=d.data(); cacheAtividades[d.id]=dd;
l.innerHTML+=`<li><div style="display:flex; align-items:center"><img src="${dd.imagem}" class="img-mini" onerror="this.style.display='none'" style="width:40px;height:40px;border-radius:12px;margin-right:15px;"><b>${d.id}</b></div><div><button class="btn-edit" onclick="carregarEdicaoAtividade('${d.id}')" style="margin-right:8px;">âœï¸</button><button class="btn-red" onclick="apagarAtividade('${d.id}')">ğŸ—‘ï¸</button></div></li>`;
let o=document.createElement('option'); o.value=d.id; o.innerText=d.id; s.appendChild(o);
g.innerHTML+=`<div style="text-align:center; border:2px solid #e1e8ed; padding:20px 10px; border-radius:20px; cursor:pointer; background:rgba(255,255,255,0.8); transition:all 0.2s;" onclick="enviarAcao('${d.id}')"><img src="${dd.imagem}" style="width:35px; height:35px; object-fit:contain; margin:0 auto 10px; border-radius:12px; display:block;"><br><small style="font-weight:700; color:#333">${d.id}</small></div>`;
});
renderizarTimeline();
});

// 4. ROTINAS
unsubscribeRotinas = onSnapshot(collection(db, `${base}/rotinas`), (snap) => {
const c=document.getElementById('calendarioContainer'); c.innerHTML="";
const dias=["DOM","SEG","TER","QUA","QUI","SEX","SÃB"];
for(let i=0; i<7; i++) c.innerHTML+=`<div class="dia-coluna" id="col-${i}"><div style="text-align:center; font-weight:700; color:#667eea; border-bottom:1px solid rgba(102,126,234,0.3); padding-bottom:10px; margin-bottom:10px">${dias[i]}</div></div>`;
cacheRotinas = {};
snap.forEach(d => {
const r=d.data(); cacheRotinas[d.id]=r;
const h=`<div class="card-rotina"><b>${r.hora}</b> ${r.acao}<div style="text-align:right; margin-top:8px"><button class="btn-edit" onclick="carregarEdicaoRotina('${d.id}')" style="margin-right:5px;">âœï¸</button><button class="btn-red" onclick="apagarRotina('${d.id}')">ğŸ—‘ï¸</button></div></div>`;
if(r.dia_semana==='todos') { for(let i=0;i<7;i++) document.getElementById(`col-${i}`).innerHTML+=h; }
else { try{document.getElementById(`col-${r.dia_semana}`).innerHTML+=h}catch(e){} }
});
renderizarTimeline();
});
}

function renderizarTimeline() {
const container = document.getElementById('timelineInteligente');
if(!container) return;
container.innerHTML = "";
const hoje = new Date();
const diaSemana = hoje.getDay().toString();
const horaAtual = hoje.getHours() * 60 + hoje.getMinutes();
let rotinasHoje = Object.values(cacheRotinas).filter(r => r.dia_semana === 'todos' || r.dia_semana === diaSemana).sort((a,b) => a.hora.localeCompare(b.hora));
if(rotinasHoje.length === 0) { container.innerHTML = "<p style='color:#999; text-align:center; padding:40px 20px;'>Sem rotinas hoje.</p>"; return; }
let proxMarked = false;
rotinasHoje.forEach(r => {
const [h, m] = r.hora.split(':').map(Number);
const minutos = h * 60 + m;
let cl = minutos < horaAtual ? "passado" : (!proxMarked ? (proxMarked=true, "proximo") : "futuro");
const atv = cacheAtividades[r.acao] || {};
container.innerHTML += `<div class="tl-item ${cl}"><div class="tl-time">${r.hora}</div><div class="tl-content"><img src="${atv.imagem||''}" class="tl-img" style="width:50px;height:50px;border-radius:50%;"><div class="tl-text"><b>${r.acao} ${cl==='proximo'?'â³ PRÃ“XIMA':''}</b><span>${atv.texto||''}</span></div></div></div>`;
});
}

window.salvarAtividade = async () => {
const idInput = document.getElementById('idAtividade');
const editId = document.getElementById('editIdAtividade').value;
let idFinal = editId ? editId : idInput.value.toLowerCase().replace(/\s/g, '');
if(!idFinal) return alert("ID ObrigatÃ³rio");
let alvos = []; try { if(document.getElementById('dev_todos')?.checked) alvos.push('todos'); document.querySelectorAll('input[name="dev_item"]:checked').forEach(c => alvos.push(c.value)); } catch(e){}
await setDoc(doc(db, `usuarios/${usuarioAtual.uid}/filhos/${filhoAtualId}/atividades`, idFinal), { 
  texto: document.getElementById('txtAtividade').value, 
  imagem: document.getElementById('imgAtividade').value, 
  tempo_personalizado: document.getElementById('tempoAtividade').value, 
  tamanho_avatar: document.getElementById('rangeTamanho').value, 
  texto_5min: document.getElementById('txt5min').value, 
  imagem_5min: document.getElementById('img5min').value, 
  texto_3min: document.getElementById('txt3min').value, 
  imagem_3min: document.getElementById('img3min').value, 
  posicao_especifica: document.getElementById('posAtividade').value, 
  falar_texto: document.getElementById('checkVoz').checked, 
  bloquear_tela: document.getElementById('checkBlock').checked, 
  dispositivos_alvo: alvos 
});
alert("âœ… Atividade Salva!"); limparFormAtividade();
};

window.carregarEdicaoAtividade = (id) => { const d = cacheAtividades[id]; if(!d) return; document.getElementById('idAtividade').value = id; document.getElementById('idAtividade').disabled = true; document.getElementById('editIdAtividade').value = id; document.getElementById('txtAtividade').value = d.texto||""; document.getElementById('imgAtividade').value = d.imagem||""; document.getElementById('tempoAtividade').value = d.tempo_personalizado||""; document.getElementById('rangeTamanho').value = d.tamanho_avatar||"150"; atualizarPreview(); document.getElementById('txt5min').value = d.texto_5min||""; document.getElementById('txt3min').value = d.texto_3min||""; document.getElementById('posAtividade').value = d.posicao_especifica||""; document.getElementById('checkVoz').checked = (d.falar_texto!==false); document.getElementById('checkBlock').checked = (d.bloquear_tela===true); };
window.limparFormAtividade = () => { document.getElementById('idAtividade').disabled = false; document.getElementById('idAtividade').value = ""; document.getElementById('editIdAtividade').value = ""; document.querySelectorAll('input[type=text], input[type=number]').forEach(i=>i.value=""); document.getElementById('rangeTamanho').value="150"; atualizarPreview(); };
window.salvarRotina = async () => { const h=document.getElementById('horaRotina').value; const id=document.getElementById('editIdRotina').value; if(!h)return alert("Hora obrigatÃ³ria"); const d={hora:h, dia_semana:document.getElementById('diaRotina').value, acao:document.getElementById('selectAtividadeRotina').value}; if(id) await updateDoc(doc(db,`usuarios/${usuarioAtual.uid}/filhos/${filhoAtualId}/rotinas`,id),d); else await addDoc(collection(db,`usuarios/${usuarioAtual.uid}/filhos/${filhoAtualId}/rotinas`),d); document.getElementById('editIdRotina').value=""; document.getElementById('horaRotina').value=""; };
window.carregarEdicaoRotina = (id) => { const r=cacheRotinas[id]; if(!r)return; document.getElementById('editIdRotina').value=id; document.getElementById('horaRotina').value=r.hora; document.getElementById('diaRotina').value=r.dia_semana; document.getElementById('selectAtividadeRotina').value=r.acao; };
window.apagarAtividade = async(id) => { if(confirm("Apagar atividade?")) await deleteDoc(doc(db, `usuarios/${usuarioAtual.uid}/filhos/${filhoAtualId}/atividades`, id)); };
window.apagarRotina = async(id) => { if(confirm("Apagar rotina?")) await deleteDoc(doc(db, `usuarios/${usuarioAtual.uid}/filhos/${filhoAtualId}/rotinas`, id)); };
window.enviarAcao = async(a) => { if(!filhoAtualId) return alert("Selecione um filho"); await setDoc(doc(db, `usuarios/${usuarioAtual.uid}/filhos/${filhoAtualId}/config/estado_atual`), {acao:a, timestamp:new Date()}, {merge:true}); };
window.apagarDispositivo = async(id) => { if(confirm("Remover este computador?")) await deleteDoc(doc(db, `usuarios/${usuarioAtual.uid}/filhos/${filhoAtualId}/dispositivos`, id)); };
window.abrirDicas = () => document.getElementById('modalDicas').classList.add('aberta');
window.fecharDicas = () => document.getElementById('modalDicas').classList.remove('aberta');
</script>
</body>
</html>
