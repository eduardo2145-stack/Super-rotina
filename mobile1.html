<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Amigo Virtual - Sensorial</title>
    <style>
        /* Paleta TEA Friendly (Baixa Satura√ß√£o, Tons Past√©is e Calmantes) */
        :root { 
            --cor-primaria: #93C49D; 
            --cor-secundaria: #E8B87D; 
            --cor-texto: #5A5A5A; 
            --fundo-base: #F7F5F0; 
        }
        
        * { box-sizing: border-box; }

        html, body { 
            margin: 0; padding: 0; width: 100vw; height: 100vh; 
            overflow: hidden !important; 
            overscroll-behavior: none; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--fundo-base);
        }

        /* --- FUNDO REGULADO --- */
        body {
            background: linear-gradient(to bottom, #EBF4F6 0%, #F7F5F0 50%, #E9F0E6 100%);
            background-image: url('IMG/bg.jpg'); /* Carrega sua imagem se ela existir */
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-blend-mode: overlay; 
        }

        #app-scroll-wrapper {
            width: 100%; height: 100%;
            overflow-y: auto; 
            overflow-x: hidden !important; 
            -webkit-overflow-scrolling: touch; 
            position: relative;
        }

        #app-scroll-wrapper::-webkit-scrollbar { display: none; } 
        #app-scroll-wrapper { -ms-overflow-style: none; scrollbar-width: none; } 

        /* --- MENUS E LOGIN --- */
        .tela-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(247, 245, 240, 0.92); backdrop-filter: blur(8px); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; }
        .box-auth { background: white; padding: 40px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.06); text-align: center; max-width: 350px; width: 90%; border: 2px solid #EBEBEB; }
        .box-auth h1 { margin-top: 0; color: var(--cor-texto); font-size: 24px; font-weight: 700; }
        .box-auth input { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #E0E0E0; border-radius: 12px; font-size: 16px; outline: none; transition: 0.3s; color: var(--cor-texto); background: #FCFCFC; }
        .box-auth input:focus { border-color: var(--cor-primaria); background: #FFF; }
        .box-auth button { width: 100%; padding: 15px; background: var(--cor-primaria); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.3s; box-shadow: 0 4px 10px rgba(147, 196, 157, 0.3); }
        
        #grid-filhos { display: flex; flex-direction: column; gap: 15px; width: 100%; max-width: 300px; margin-top: 20px; }
        .btn-filho { background: white; border: 2px solid var(--cor-primaria); padding: 18px; border-radius: 16px; font-size: 20px; font-weight: bold; color: var(--cor-texto); cursor: pointer; transition: 0.2s; box-shadow: 0 4px 12px rgba(147, 196, 157, 0.15); }
        .btn-filho:hover { background: var(--cor-primaria); color: white; transform: translateY(-2px); }
        .btn-sair { background: transparent !important; color: #D98880 !important; border: 2px solid #D98880 !important; box-shadow: none !important; margin-top: 20px;}

        #menu-container { position: fixed; top: 20px; left: 20px; z-index: 1000; }
        #menu-btn { background: rgba(255,255,255,0.9); border: 2px solid #EBEBEB; padding: 10px 20px; border-radius: 30px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.05); font-weight: bold; font-size: 15px; display: flex; align-items: center; gap: 8px; color: var(--cor-texto); backdrop-filter: blur(5px); }
        #lista-criancas { background: white; border-radius: 16px; box-shadow: 0 8px 25px rgba(0,0,0,0.08); display: none; padding: 8px; border: 1px solid #EBEBEB; margin-top: 8px; min-width: 160px; }
        .opcao-crianca { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #F0F0F0; transition: 0.2s; font-size: 15px; border-radius: 10px; font-weight: 600; color: var(--cor-texto);}
        .opcao-crianca:hover { background: #F4F9F5; color: var(--cor-primaria); }

        #telaDiaLivre { display: none; flex-direction: column; align-items: center; justify-content: center; height: 90vh; text-align: center; color: var(--cor-texto); background: rgba(255,255,255,0.7); border-radius: 30px; margin: 20px; backdrop-filter: blur(10px); }
        #telaDiaLivre img { width: 120px; opacity: 0.6; margin-bottom: 20px; }
        #telaDiaLivre h1 { font-size: 30px; margin: 0; color: var(--cor-primaria); font-weight: 800; }

        /* --- MODAL DO MASCOTE --- */
        #modalDica { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            background: rgba(247, 245, 240, 0.85); backdrop-filter: blur(8px);
            display: none; align-items: center; justify-content: center; z-index: 9999;
            opacity: 0; transition: opacity 0.4s ease;
        }
        
        .mascote-container {
            display: flex; align-items: flex-end; gap: 20px;
            transform: translateY(30px); transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            max-width: 90%;
        }

        .mascote-img { width: 150px; height: auto; filter: drop-shadow(0 8px 15px rgba(0,0,0,0.1)); }

        .balao-fala {
            background: white; padding: 25px 30px; border-radius: 28px; border-bottom-left-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); position: relative; max-width: 380px; border: 2px solid #F0F0F0;
        }
        
        .balao-fala::before {
            content: ""; position: absolute; bottom: -2px; left: -18px;
            width: 0; height: 0; border-right: 20px solid white; border-top: 20px solid transparent; border-bottom: 0px solid transparent;
        }

        .balao-fala h2 { margin: 0 0 12px 0; color: var(--cor-primaria); font-size: 22px; text-transform: uppercase; letter-spacing: 0.5px; }
        .balao-fala p { margin: 0 0 24px 0; font-size: 17px; color: var(--cor-texto); line-height: 1.5; font-weight: 500; }
        .balao-fala button {
            background: var(--cor-primaria); color: white; border: none; padding: 14px 25px;
            border-radius: 14px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%;
            box-shadow: 0 4px 12px rgba(147, 196, 157, 0.3); transition: 0.2s;
        }
        .balao-fala button:active { transform: scale(0.97); }

        #modalDica.ativo { opacity: 1; display: flex; }
        #modalDica.ativo .mascote-container { transform: translateY(0); }

        /* --- ESTRADA --- */
        #mapa-container { 
            position: relative; width: 100%; max-width: 1100px; 
            margin: 150px auto 50px auto; padding-bottom: 80px; 
        }
        svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; overflow: visible; }
        
        .estrada-corpo { fill: none; stroke-width: 45; stroke-linecap: round; opacity: 1; filter: drop-shadow(0 6px 12px rgba(0,0,0,0.06)); }
        .estrada-tracejada { fill: none; stroke: rgba(255,255,255,0.8); stroke-width: 4; stroke-dasharray: 14,14; stroke-linecap: round; pointer-events: none; z-index: 3; }
        
        .c-1 { stroke: #E8B87D; } 
        .c-2 { stroke: #93C49D; } 
        .c-3 { stroke: #80C2D6; } 
        .c-4 { stroke: #86A3D4; } 
        .c-5 { stroke: #B4A3D6; } 
        
        .seta-final { position: absolute; width: 0; height: 0; border-top: 48px solid transparent; border-bottom: 48px solid transparent; z-index: 2; filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.08)); transition: left 0.5s; }
        .seta-dir { border-left: 68px solid #B4A3D6; transform: translate(0, -50%); }
        .seta-esq { border-right: 68px solid #B4A3D6; transform: translate(-100%, -50%); }
        .seta-baixo { border-top: 55px solid #B4A3D6; border-left: 40px solid transparent; border-right: 40px solid transparent; transform: translate(-50%, 0); }

        /* --- MARCADORES --- */
        .marcador { position: absolute; width: 0; height: 0; z-index: 10; transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }

        .icone-circulo {
            position: absolute; left: 0; top: 0; transform: translate(-50%, -50%);
            width: 82px; height: 82px; background: white; border-radius: 50%; border: 5px solid #ccc;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08); display: flex; align-items: center; justify-content: center;
            overflow: hidden; z-index: 3; transition: all 0.3s ease; cursor: pointer;
        }
        
        .icone-circulo:hover { transform: translate(-50%, -50%) scale(1.05); box-shadow: 0 12px 25px rgba(0,0,0,0.12); }
        .icone-circulo:active { transform: translate(-50%, -50%) scale(0.98); }
        .icone-circulo img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }

        .textos { 
            position: absolute; left: 0; bottom: 55px; transform: translateX(-50%); width: 220px; text-align: center;
            z-index: 5; pointer-events: none; display: flex; flex-direction: column; align-items: center;
        }

        .badge-hora { 
            display: inline-block; padding: 4px 16px; border-radius: 20px; 
            color: white !important; font-size: 16px; font-weight: 800; letter-spacing: 0.5px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08); margin-bottom: 6px; border: 2px solid rgba(255,255,255,0.5);
        }
        
        .textos .acao { 
            display: block; font-size: 14px; font-weight: 700; color: var(--cor-texto) !important; 
            text-transform: uppercase; 
            text-shadow: 0 2px 5px rgba(255,255,255,0.9), 0 -2px 5px rgba(255,255,255,0.9), 2px 0 5px rgba(255,255,255,0.9), -2px 0 5px rgba(255,255,255,0.9);
        }

        /* --- ESTADOS (CALMOS) --- */
        .passado .icone-circulo { border-color: #D5D5D5 !important; opacity: 0.7; filter: grayscale(0.4) opacity(0.8); transform: translate(-50%, -50%) scale(0.95); box-shadow: none; }
        .passado .textos { opacity: 0.6; }
        
        .agora { z-index: 100; }
        .agora .icone-circulo { 
            border-color: var(--cor-primaria) !important; 
            box-shadow: 0 0 0 4px rgba(147, 196, 157, 0.2), 0 15px 30px rgba(0,0,0,0.1);
            animation: respiracaoCalma 3s infinite alternate ease-in-out; 
        }
        .agora .badge-hora { transform: scale(1.05); background: var(--cor-primaria) !important; box-shadow: 0 4px 12px rgba(147, 196, 157, 0.4); }

        @keyframes respiracaoCalma { 
            0% { transform: translate(-50%, -50%) scale(1); } 
            100% { transform: translate(-50%, -50%) scale(1.04); box-shadow: 0 0 0 8px rgba(147, 196, 157, 0.1), 0 20px 40px rgba(0,0,0,0.15); } 
        }
    </style>
</head>
<body>

    <div id="modalDica" onclick="fecharDica()">
        <div class="mascote-container" onclick="event.stopPropagation()">
            <img src="https://cdn-icons-png.flaticon.com/512/4712/4712010.png" class="mascote-img" alt="Amigo Virtual">
            <div class="balao-fala">
                <h2 id="dicaTitulo">Hora da A√ß√£o!</h2>
                <p id="dicaTexto">Mensagem do mascote aqui...</p>
                <button onclick="fecharDica()">Entendi!</button>
            </div>
        </div>
    </div>

    <div id="app-scroll-wrapper">

        <div id="telaLogin" class="tela-overlay" style="display: flex;">
            <div class="box-auth">
                <h1>Login Amigo Virtual</h1>
                <p style="color:#888; margin-bottom: 20px; font-size: 14px;">Use a mesma conta do painel</p>
                <input type="email" id="inputEmail" placeholder="Seu E-mail">
                <input type="password" id="inputSenha" placeholder="Sua Senha">
                <button onclick="fazerLogin()">ENTRAR NO PAINEL</button>
            </div>
        </div>

        <div id="telaSelecionarFilho" class="tela-overlay" style="display: none;">
            <h1 style="color: var(--cor-texto); font-size: 28px;">Quem est√° usando?</h1>
            <div id="grid-filhos"></div>
            <button class="btn-filho btn-sair" onclick="sairApp()">Sair da Conta</button>
        </div>

        <div id="telaMapa" style="display: none;">
            <div id="menu-container">
                <button id="menu-btn" onclick="toggleMenu()">ü§ñ <span id="nome-atual">...</span> ‚ñæ</button>
                <div id="lista-criancas">
                    <div id="menu-filhos-items"></div>
                    <div class="opcao-crianca" style="color:#D98880; border-top: 1px solid #F0F0F0; text-align: center;" onclick="sairApp()">Sair da Conta</div>
                </div>
            </div>

            <div id="telaDiaLivre">
                <img src="https://cdn-icons-png.flaticon.com/512/3082/3082025.png" alt="Dia Livre">
                <h1>Dia Livre!</h1>
                <p>Nenhuma rotina cadastrada para hoje.</p>
            </div>

            <div id="mapa-container">
                <svg id="svgEstrada">
                    <g id="camada-cores"></g>
                    <path id="pathCinzaPassado" class="estrada-corpo" style="stroke: #EAE6DF; opacity: 0.9; transition: stroke-dashoffset 1.5s ease-in-out; z-index: 2;" />
                    <path id="pathTracejado" class="estrada-tracejada" />
                </svg>
                <div id="cards-layer"></div>
                <div id="seta-final-container"></div>
            </div>
        </div>

    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, query, orderBy, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyAh3J8bp7xvNGct8k4TfAoCcIpVRoWjBYI", authDomain: "rotinaeduardo.firebaseapp.com", projectId: "rotinaeduardo", appId: "1:210945268922:web:ce9e585872090b378d7683" };
    const app = initializeApp(firebaseConfig); 
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    let id_usuario_pai = null; 
    let caminho_dados = localStorage.getItem('caminho_dados');
    let nome_crianca = localStorage.getItem('nome_crianca');
    let cacheAtividades = {};
    let rotinasCache = [];

    // ==========================================
    // O SUPER C√âREBRO DO MASCOTE (IGNORA ACENTOS!)
    // ==========================================
    const dicasMascote = {
        "comer": "O alimento √© a energia m√°gica que faz voc√™ crescer forte e esperto. Bom apetite!",
        "almo√ß": "Pausa para reabastecer! O almo√ßo deixa seu corpo preparado para as aventuras da tarde.",
        "jant": "O jantar ajuda sua barriguinha a ficar tranquila para voc√™ ter sonhos muito felizes.",
        "caf√©": "O caf√© da manh√£ liga o motor do seu corpo para come√ßar o dia com tudo!",
        "lanch": "Hora do lanchinho! Uma pausa gostosa para encher a barriga e voltar a brincar.",
        "frut": "Frutas s√£o doces da natureza! Elas t√™m vitaminas que s√£o como escudos protetores para o corpo.",
        "ma√ß√£": "A ma√ß√£ √© crocante e faz um barulhinho super legal! E ainda deixa seus dentes fortes.",
        "banana": "Sabia que a banana √© a fruta dos campe√µes? Ela d√° muita for√ßa para os m√∫sculos!",
        "morango": "Vermelhinho e docinho! O morango √© cheio de superpoderes para a sua sa√∫de.",
        "√°gua": "Glub, glub! Beber √°gua refresca e ajuda o seu c√©rebro a pensar bem rapidinho.",
        "suco": "Um suquinho gostoso para refrescar e encher o corpo de vitaminas boas!",
        "banho": "√Ågua quentinha e sabonete! O banho relaxa o corpo e manda as sujeirinhas pelo ralo.",
        "dente": "Sua escova √© uma varinha m√°gica que deixa os dentes brilhantes e fortes!",
        "escovar": "Sua escova √© uma varinha m√°gica que deixa os dentes brilhantes e fortes!",
        "m√£o": "Lavar as m√£os manda os bichinhos invis√≠veis embora. Chu√°, chu√°, tchau sujeira!",
        "banheiro": "Muito bem! Usar o banheiro e lavar as m√£os depois mostra como voc√™ j√° est√° grande.",
        "xixi": "Sinal verde para o banheiro! Fazer xixi alivia a barriguinha e te deixa pronto para brincar mais.",
        "coc√¥": "Hora de ir ao trono! O corpo fica levinho e muito feliz depois de usar o banheiro.",
        "cabelo": "Pentear o cabelo faz uma massagem gostosa na cabe√ßa e te deixa super estiloso!",
        "unha": "Cortar as unhas deixa seus dedos prontos para tocar em tudo sem arranhar. Rapidinho e n√£o d√≥i!",
        "pijama": "Colocar o pijama √© o abra√ßo de pano que avisa ao corpo: 'est√° chegando a hora de descansar'.",
        "dormir": "Hora de descansar. Enquanto voc√™ dorme, seu c√©rebro guarda tudo de legal que voc√™ aprendeu hoje.",
        "acordar": "Bom dia! Espreguice o corpo como um gatinho e d√™ boas-vindas a um novo dia de aventuras.",
        "soneca": "Uma pausa para os olhinhos descansarem. A soneca recarrega a sua bateria para mais tarde!",
        "cama": "Sua cama √© o seu ninho quentinho e seguro. Feche os olhos e tenha sonhos lindos!",
        "escola": "A escola √© um lugar cheio de descobertas e amigos novos. Aproveite bastante!",
        "estud": "Aprender coisas novas deixa sua mente super poderosa. Voc√™ consegue!",
        "tarefa": "Fazer a tarefa √© como um treino de her√≥i: deixa seu c√©rebro cada vez mais forte!",
        "li√ß√£": "Fazer a li√ß√£o √© como montar um quebra-cabe√ßa. Um passinho de cada vez e voc√™ termina!",
        "ler": "Ler um livro √© como viajar para um mundo m√°gico sem sair do lugar. Que hist√≥ria legal!",
        "livro": "Os livros guardam segredos incr√≠veis. Qual ser√° a descoberta de hoje?",
        "pintar": "Uau! Usar as cores faz a sua imagina√ß√£o brilhar. Capriche na sua obra de arte.",
        "desenhar": "Desenhar √© colocar no papel o que est√° na sua cabe√ßa. Mostre seu talento!",
        "m√©dico": "O m√©dico √© o amigo que ajuda o seu corpo a ficar sempre forte e saud√°vel.",
        "terapia": "Hora de treinar habilidades novas e super legais! Voc√™ vai se divertir e aprender muito.",
        "fono": "Hora de brincar com as palavras e os sons! Sua voz √© muito importante.",
        "psic√≥log": "Um momento para falar sobre as emo√ß√µes e sentimentos. Seu cora√ß√£o est√° em um lugar seguro.",
        "guardar": "Guardar os brinquedos √© como colocar cada coisa na sua caminha. Eles v√£o adorar descansar!",
        "brinquedo": "Guardar os brinquedos √© como colocar cada coisa na sua caminha. Eles v√£o adorar descansar!",
        "arrumar": "Um ambiente arrumado deixa a cabe√ßa tranquila. Obrigado por ser um super ajudante!",
        "limpar": "Tudo limpinho e brilhando! Ajudar em casa √© uma atitude de gente grande.",
        "lixo": "Jogar o lixo no lixo ajuda a salvar o planeta Terra. O meio ambiente agradece!",
        "roupa": "Roupa limpa no arm√°rio, roupa suja no cesto. A organiza√ß√£o faz o dia ficar mais f√°cil!",
        "pc": "Telinhas s√£o divertidas, mas n√£o esque√ßa de piscar os olhos e dar uma esticadinha no corpo!",
        "computador": "Hora de usar a m√°quina inteligente! Lembre-se de sentar com a coluna retinha.",
        "celular": "A telinha diverte, mas lembre-se que o mundo real tamb√©m est√° cheio de brincadeiras.",
        "tablet": "O tablet √© muito legal, mas n√£o deixe ele muito pertinho do rosto, t√° bom?",
        "tv": "Assistir TV √© gostoso! Quando acabar, que tal criar sua pr√≥pria historinha?",
        "videogame": "Voc√™ √© o controle mestre! Mas lembre-se: her√≥is de verdade tamb√©m brincam l√° fora.",
        "brincar": "Use sua imagina√ß√£o! Brincar √© a melhor forma de aprender a ser feliz.",
        "correr": "Correr faz o vento bater no rosto e o cora√ß√£o bater forte. Gaste toda essa energia boa!",
        "parque": "O parque √© o lugar perfeito para rir alto, pular e explorar a natureza.",
        "abra√ß": "Um abra√ßo apertado cura qualquer tristeza e enche o cora√ß√£o de alegria. Que del√≠cia!",
        "respirar": "Puxe o ar como se cheirasse uma flor, solte como se soprasse uma vela. Isso traz muita paz."
    };

        window.abrirDica = (acaoTexto, descricaoPersonalizada) => {
        const modal = document.getElementById('modalDica');
        const titulo = document.getElementById('dicaTitulo');
        const texto = document.getElementById('dicaTexto');
        
        let mensagemEncontrada = null;
        
        // Remove acentos da palavra clicada ("√Ågua" vira "agua")
        let palavraChave = acaoTexto.trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "");
        
        // 1¬™ PRIORIDADE: O Super C√©rebro do Mascote! 
        for (const [palavra, dica] of Object.entries(dicasMascote)) {
            let palavraLimpa = palavra.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "");
            if (palavraChave.includes(palavraLimpa)) {
                mensagemEncontrada = dica;
                break; // Achou a palavra! Para de procurar.
            }
        }

        // 2¬™ PRIORIDADE: Se o mascote n√£o souber o que √©, ele l√™ o que o pai escreveu no Painel
        if (!mensagemEncontrada && descricaoPersonalizada && descricaoPersonalizada.trim() !== "" && descricaoPersonalizada !== "undefined") {
            mensagemEncontrada = descricaoPersonalizada;
        } 

        // 3¬™ PRIORIDADE: Frase de backup padr√£o de incentivo
        if (!mensagemEncontrada) {
            mensagemEncontrada = "Cada atividade que voc√™ faz √© um passo para um dia incr√≠vel. Continue assim!";
        }

        titulo.innerText = acaoTexto;
        texto.innerText = mensagemEncontrada;
        
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('ativo'), 10);
    };


    window.fecharDica = () => {
        const modal = document.getElementById('modalDica');
        modal.classList.remove('ativo');
        setTimeout(() => modal.style.display = 'none', 400); 
    };

    onAuthStateChanged(auth, (user) => {
        if (user) {
            id_usuario_pai = user.uid;
            if (caminho_dados && caminho_dados.includes(user.uid)) {
                iniciarApp();
            } else {
                mostrarTelaSelecaoFilho();
            }
        } else {
            document.getElementById('telaLogin').style.display = 'flex';
            document.getElementById('telaSelecionarFilho').style.display = 'none';
            document.getElementById('telaMapa').style.display = 'none';
        }
    });

    window.fazerLogin = () => {
        const email = document.getElementById('inputEmail').value;
        const senha = document.getElementById('inputSenha').value;
        if(!email || !senha) return alert("Preencha e-mail e senha!");
        signInWithEmailAndPassword(auth, email, senha).catch(e => alert("Erro! Verifique as credenciais."));
    };

    window.sairApp = () => {
        localStorage.removeItem('caminho_dados');
        localStorage.removeItem('nome_crianca');
        signOut(auth);
    };

    function mostrarTelaSelecaoFilho() {
        document.getElementById('telaLogin').style.display = 'none';
        document.getElementById('telaMapa').style.display = 'none';
        document.getElementById('telaSelecionarFilho').style.display = 'flex';

        onSnapshot(collection(db, `usuarios/${id_usuario_pai}/filhos`), (snap) => {
            const grid = document.getElementById('grid-filhos');
            grid.innerHTML = "";
            snap.forEach(d => {
                const info = d.data();
                const pathFilho = `usuarios/${id_usuario_pai}/filhos/${d.id}`;
                grid.innerHTML += `<button class="btn-filho" onclick="selecionarCrianca('${pathFilho}', '${info.nome}')">${info.nome}</button>`;
            });
            if(snap.empty) grid.innerHTML = "<p>Nenhum filho cadastrado.</p>";
        });
    }

    window.selecionarCrianca = (caminho, nome) => {
        localStorage.setItem('caminho_dados', caminho);
        localStorage.setItem('nome_crianca', nome);
        window.location.reload(true);
    };

    function processarCacheAtividades(snap) {
        snap.forEach(doc => {
            const data = doc.data();
            const idOriginal = doc.id;
            const nomeOrig = data.nome || "";
            const acaoOrig = data.acao || "";

            cacheAtividades[idOriginal] = data;
            if (nomeOrig) cacheAtividades[nomeOrig] = data;
            if (acaoOrig) cacheAtividades[acaoOrig] = data;

            cacheAtividades[idOriginal.trim().toLowerCase()] = data;
            if (nomeOrig) cacheAtividades[nomeOrig.trim().toLowerCase()] = data;
            if (acaoOrig) cacheAtividades[acaoOrig.trim().toLowerCase()] = data;
        });
        if(rotinasCache.length > 0) desenharPista(rotinasCache);
    }

    function iniciarApp() {
        document.getElementById('telaLogin').style.display = 'none'; 
        document.getElementById('telaSelecionarFilho').style.display = 'none'; 
        document.getElementById('telaMapa').style.display = 'block'; 
        document.getElementById('nome-atual').innerText = nome_crianca;
        
        const partes = caminho_dados.split('/'); 
        const pastaUsuario = `${partes[0]}/${partes[1]}`;
        const pastaIrmaos = `${partes[0]}/${partes[1]}/${partes[2]}`;

        onSnapshot(collection(db, `${pastaUsuario}/atividades`), processarCacheAtividades);
        onSnapshot(collection(db, `${caminho_dados}/atividades`), processarCacheAtividades);

        onSnapshot(collection(db, pastaIrmaos), (snap) => {
            const menu = document.getElementById('menu-filhos-items');
            menu.innerHTML = "";
            snap.forEach(d => { 
                const info = d.data(); 
                menu.innerHTML += `<div class="opcao-crianca" onclick="selecionarCrianca('${pastaIrmaos}/${d.id}', '${info.nome}')">${info.nome}</div>`;
            });
        });
        
        carregarRotinasDoBanco();
        setInterval(heartbeat, 30000);
        setInterval(() => desenharPista(rotinasCache), 60000);
    }
    
    window.toggleMenu = () => { const m = document.getElementById('lista-criancas'); m.style.display = m.style.display==='block'?'none':'block'; };
    
    function converterMin(h) { 
        let [hr, mn] = h.split(':').map(Number); 
        if(hr < 5) hr += 24; 
        return hr * 60 + mn; 
    }

    function obterMinutosAtuais() {
        const agora = new Date();
        let hrSys = agora.getHours();
        let mnSys = agora.getMinutes();
        if(hrSys < 5) hrSys += 24;
        return hrSys * 60 + mnSys;
    }

    const iconesInteligentes = {
        "dormir": "https://cdn-icons-png.flaticon.com/512/3094/3094836.png",
        "almo√ßar": "https://cdn-icons-png.flaticon.com/512/3413/3413574.png",
        "comer": "https://cdn-icons-png.flaticon.com/512/3413/3413574.png",
        "dentes": "https://cdn-icons-png.flaticon.com/512/2965/2965314.png",
        "banho": "https://cdn-icons-png.flaticon.com/512/3103/3103445.png"
    };
    function buscarIconeAcao(acaoTexto) {
        if(!acaoTexto) return 'https://cdn-icons-png.flaticon.com/512/1048/1048953.png';
        const textoLimpo = acaoTexto.toLowerCase();
        for (const [palavra, link] of Object.entries(iconesInteligentes)) {
            if (textoLimpo.includes(palavra)) return link;
        }
        return 'https://cdn-icons-png.flaticon.com/512/1048/1048953.png';
    }

    const H_ROW = 240; 
    
    function calcularConfiguracaoTela() {
        const container = document.getElementById('mapa-container');
        const W = container.clientWidth;
        
        let itensPorLinha = 5;
        let margemX = 140; 

        if (W < 550) { itensPorLinha = 2; margemX = 90; }
        else if (W < 800) { itensPorLinha = 3; margemX = 110; }
        else if (W < 1000) { itensPorLinha = 4; margemX = 130; }
        else { itensPorLinha = 5; margemX = 150; }

        return { W, ITENS_POR_LINHA: itensPorLinha, MARGEM_X: margemX };
    }    function criarCaminhoInfografico(totalRotinas, conf) {
        const container = document.getElementById('mapa-container');
        const linhas = Math.max(1, Math.ceil(totalRotinas / conf.ITENS_POR_LINHA));
        // Aumentei o espa√ßo no fundo para caber a reta final
        container.style.height = ((linhas * H_ROW) + 180) + "px"; 
        
        let d = `M ${conf.MARGEM_X},120 `;
        let y = 120;

        for (let i = 0; i < linhas; i++) {
            let nextX = (i % 2 === 0) ? (conf.W - conf.MARGEM_X) : conf.MARGEM_X;
            d += `L ${nextX},${y} `; 
            if (i < linhas - 1) {
                let arcY = y + H_ROW;
                let raio = H_ROW / 2;
                let direcaoArco = (i % 2 === 0) ? 1 : 0;
                d += `A ${raio} ${raio} 0 0 ${direcaoArco} ${nextX} ${arcY} `; 
                y = arcY;
            }
        }
        
        // --- A M√ÅGICA DA NOVA SETA ---
        // Desce uma reta vertical de 50px no final para n√£o sair da tela!
        let pontaFinalX = (linhas % 2 === 1) ? (conf.W - conf.MARGEM_X) : conf.MARGEM_X;
        let pontaFinalY = y + 50;
        d += ` L ${pontaFinalX},${pontaFinalY} `; // Adiciona a descida no SVG
        
        const setaContainer = document.getElementById('seta-final-container');
        
        // Usa a nossa nova seta apontada para baixo
        setaContainer.innerHTML = `<div class="seta-final seta-baixo" style="left: ${pontaFinalX}px; top: ${pontaFinalY}px;"></div>`;

        return d;
    }



    function carregarRotinasDoBanco() {
        const hoje = new Date();
        const diaSemanaAtual = hoje.getDay().toString();

        onSnapshot(query(collection(db, `${caminho_dados}/rotinas`), orderBy("hora")), (snap) => {
            const listaBruta = []; 
            snap.forEach(d => listaBruta.push(d.data()));
            rotinasCache = listaBruta.filter(r => !r.dia_semana || r.dia_semana === 'todos' || r.dia_semana === diaSemanaAtual);
            rotinasCache.sort((a,b) => converterMin(a.hora) - converterMin(b.hora));
            
            desenharPista(rotinasCache);
        });
    }

    function desenharPista(lista) {
        if(lista.length === 0) {
            document.getElementById('mapa-container').style.display = 'none';
            document.getElementById('telaDiaLivre').style.display = 'flex';
            return;
        } else {
            document.getElementById('mapa-container').style.display = 'block';
            document.getElementById('telaDiaLivre').style.display = 'none';
        }

        const conf = calcularConfiguracaoTela();
        const dPath = criarCaminhoInfografico(lista.length, conf);
        
        const pathTrace = document.getElementById('pathTracejado');
        pathTrace.setAttribute('d', dPath);
        const totalLen = pathTrace.getTotalLength();

        const grupoCores = document.getElementById('camada-cores'); grupoCores.innerHTML = "";
        const coresClasses = ["c-1", "c-2", "c-3", "c-4", "c-5"];
        const hexCores = ["#E8B87D", "#93C49D", "#80C2D6", "#86A3D4", "#B4A3D6"];
        const pedacoSize = totalLen / 5; 

        for(let i=0; i<5; i++) {
            const pathSeg = document.createElementNS("http://www.w3.org/2000/svg", "path");
            pathSeg.setAttribute('d', dPath); pathSeg.setAttribute('class', `estrada-corpo ${coresClasses[i]}`);
            pathSeg.style.strokeDasharray = `${pedacoSize + 10} ${totalLen}`; pathSeg.style.strokeDashoffset = -(i * pedacoSize);
            grupoCores.appendChild(pathSeg);
        }

        const container = document.getElementById('cards-layer'); container.innerHTML = "";
        
        const minAtual = obterMinutosAtuais();
        let indexAtual = -1;
        
        for(let i = 0; i < lista.length; i++) {
            if (minAtual >= converterMin(lista[i].hora)) {
                indexAtual = i; 
            }
        }

        lista.forEach((rot, index) => {
            const linhaAtual = Math.floor(index / conf.ITENS_POR_LINHA);
            const posNaLinha = index % conf.ITENS_POR_LINHA; 
            const yPos = 120 + (linhaAtual * H_ROW);
            const larguraUtil = conf.W - (2 * conf.MARGEM_X);
            const stepX = larguraUtil / (conf.ITENS_POR_LINHA - 1 || 1);

            let xPos = (linhaAtual % 2 === 0) ? conf.MARGEM_X + (posNaLinha * stepX) : (conf.W - conf.MARGEM_X) - (posNaLinha * stepX);

            const percentTotal = index / lista.length;
            const indiceCor = Math.floor(percentTotal * 4.99);
            const corAtual = hexCores[indiceCor % 5];

            const div = document.createElement('div');
            const classeTexto = (linhaAtual % 2 === 0) ? 'texto-cima' : 'texto-baixo';
            div.className = `marcador ${classeTexto}`;
            div.style.left = xPos + "px"; 
            div.style.top = yPos + "px";

            if(index < indexAtual) {
                div.classList.add('passado');
            }
            else if(index === indexAtual) {
                div.classList.add('agora');
                if(conf.W > 800) {
                   setTimeout(() => document.getElementById('app-scroll-wrapper').scrollTo({top: yPos - 300, behavior:'smooth'}), 500); 
                }
            }

            const acaoLimpa = (rot.acao || "").trim().toLowerCase();
            const atvBanco = cacheAtividades[acaoLimpa] || {};
            let imagemFinal = atvBanco.imagem || rot.imagem || rot.foto || buscarIconeAcao(rot.acao);

            // Resgata o texto que voc√™ digitou no painel e limpa ele para n√£o quebrar o c√≥digo
            let textoMascote = rot.descricao || atvBanco.texto || atvBanco.descricao || "";
            textoMascote = textoMascote.replace(/'/g, "\\'").replace(/"/g, '&quot;'); 
            let acaoSegura = rot.acao.replace(/'/g, "\\'").replace(/"/g, '&quot;');

            div.innerHTML = `
                <div class="icone-circulo" style="border-color:${corAtual}" onclick="abrirDica('${acaoSegura}', '${textoMascote}')">
                    <img src="${imagemFinal}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1048/1048953.png'">
                </div>
                <div class="textos">
                    <span class="badge-hora" style="background:${corAtual}">${rot.hora}</span>
                    <span class="acao">${rot.acao}</span>
                </div>
            `;
            container.appendChild(div);
        });

        let lengthPassado = 0;
        if (indexAtual >= 0) {
            const compReta = conf.W - (2 * conf.MARGEM_X);
            const compCurva = Math.PI * (H_ROW / 2);
            const pedacoReta = compReta / (conf.ITENS_POR_LINHA - 1 || 1);
            const linhaDoAtual = Math.floor(indexAtual / conf.ITENS_POR_LINHA);
            const posicaoNaLinha = indexAtual % conf.ITENS_POR_LINHA;
            lengthPassado = (linhaDoAtual * (compReta + compCurva)) + (posicaoNaLinha * pedacoReta);
        }

        const caminhoCinza = document.getElementById('pathCinzaPassado');
        caminhoCinza.setAttribute('d', dPath);
        caminhoCinza.style.strokeDasharray = totalLen;
        caminhoCinza.style.strokeDashoffset = totalLen - lengthPassado; 
    }

    let resizeTimer;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => desenharPista(rotinasCache), 300);
    });

    async function heartbeat() { if(caminho_dados) setDoc(doc(db, `${caminho_dados}/dispositivos/tablet_amigo`), { nome: "Tablet "+nome_crianca, online: serverTimestamp() }, {merge:true}); }
</script>
</body>
</html>
