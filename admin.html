<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Amigo Virtual</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* BASE PREMIUM */
        :root { --cor-bg: #f4f7f6; --cor-sidebar: #1e293b; --cor-primaria: #3498db; --cor-texto: #334155; }
        body { margin: 0; font-family: 'Inter', sans-serif; background-color: var(--cor-bg); color: var(--cor-texto); display: flex; height: 100vh; overflow: hidden; }
        * { box-sizing: border-box; }

        /* TELA DE SEGURAN√áA (O Bouncer) */
        #telaSeguranca { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: var(--cor-sidebar); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 99999; }
        .spinner { border: 4px solid rgba(255,255,255,0.1); border-left-color: var(--cor-primaria); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* O PAINEL PRINCIPAL (Escondido at√© validar) */
        #adminWrapper { display: none; width: 100%; height: 100%; }

        /* MENU LATERAL (Sidebar) */
        .sidebar { width: 260px; background-color: var(--cor-sidebar); color: white; display: flex; flex-direction: column; padding: 20px 0; }
        .sidebar-logo { padding: 0 20px 30px 20px; font-size: 20px; font-weight: 700; color: white; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px; }
        .nav-link { padding: 15px 25px; color: #94a3b8; text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: 0.2s; border-left: 3px solid transparent; }
        .nav-link:hover, .nav-link.ativo { color: white; background-color: rgba(255,255,255,0.05); border-left-color: var(--cor-primaria); }

        /* CONTE√öDO PRINCIPAL */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow-y: auto; }
        .topbar { background: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .topbar h2 { margin: 0; font-size: 18px; font-weight: 600; color: #0f172a; }
        .btn-sair { background: #fee2e2; color: #ef4444; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-sair:hover { background: #fecaca; }

        /* √ÅREA DAS TELAS INTERNAS */
        .conteudo-tela { padding: 30px; display: none; }
        .conteudo-tela.ativa { display: block; }

        /* CARDS DO DASHBOARD */
        .grid-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card-metric { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .card-title { color: #64748b; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
        .card-value { font-size: 32px; font-weight: 700; color: #0f172a; margin: 0; }
        .card-value span { font-size: 14px; font-weight: 500; color: #10b981; margin-left: 10px; } /* Texto verde extra */
    /* =========================================
   MENU HAMB√öRGUER PROFISSIONAL (CELULAR)
   ========================================= */
@media (max-width: 768px) {
    /* Mostra o cabe√ßalho com os 3 risquinhos */
    #cabecalhoMobile {
        display: flex !important;
    }

    #adminWrapper {
        display: block !important; /* Desliga o modo lado-a-lado */
    }

    /* Esconde a barra lateral fora da tela (√† esquerda) */
    #adminWrapper > div:nth-child(1) {
        position: fixed !important;
        top: 0 !important;
        left: -100% !important; /* <--- Fica escondido aqui */
        width: 280px !important;
        max-width: 80vw !important;
        height: 100vh !important;
        z-index: 999 !important;
        transition: left 0.3s ease-in-out !important; /* Anima√ß√£o suave */
        box-shadow: 5px 0 20px rgba(0,0,0,0.5) !important;
    }

    /* Classe que faz o menu deslizar para dentro da tela */
    #adminWrapper > div:nth-child(1).menu-aberto {
        left: 0 !important;
    }

    /* √Årea principal do Dashboard (Atr√°s do menu) */
    #adminWrapper > div:nth-child(2) {
        width: 100% !important;
        padding: 15px !important;
        box-sizing: border-box !important;
    }

    /* Empilha os blocos de estat√≠sticas */
    div[style*="display: flex; gap: 20px;"] {
        flex-direction: column !important;
        gap: 15px !important;
    }
    div[style*="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;"] {
        flex-direction: column !important;
        align-items: flex-start !important;
    }
}

</style>
</head>
<body>

    <div id="telaSeguranca">
        <div class="spinner"></div>
        <h2>Validando Credenciais Master...</h2>
    </div>
     
   <div id="adminWrapper">
        <div id="cabecalhoMobile" style="display: none; background: #1e293b; color: white; padding: 15px 20px; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 997;">
        <div style="font-size: 18px; font-weight: bold;">üëë Sala de Comando</div>
        <button onclick="toggleMenuMobile()" style="background: none; border: none; color: white; font-size: 26px; cursor: pointer;">‚ò∞</button>
    </div>

    <div id="overlayMenu" onclick="toggleMenuMobile()" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.6); z-index: 998;"></div>

        <aside class="sidebar">
            <div class="sidebar-logo">üëë Sala de Comando</div>
            <div class="nav-link ativo" onclick="mudarAba('dashboard', this)">üìä Dashboard</div>
            <div class="nav-link" onclick="mudarAba('clientes', this)">üë• Clientes e Acessos</div>
            <div class="nav-link" onclick="mudarAba('financeiro', this)">üí∞ Financeiro / Gateways</div>
            <div class="nav-link" onclick="mudarAba('avisos', this)">üì¢ Enviar Avisos</div>
        </aside>

        <main class="main-content">
            <header class="topbar">
                <h2 id="tituloPagina">Vis√£o Geral</h2>
                <button class="btn-sair" onclick="sairDoAdmin()">Sair do Sistema</button>
            </header>

            <div id="tab-dashboard" class="conteudo-tela ativa">
                <div class="grid-cards">
                    <div class="card-metric">
                        <div class="card-title">Total de Cadastros</div>
                        <p class="card-value" id="valTotalUsuarios">--</p>
                    </div>
                    <div class="card-metric">
                        <div class="card-title">Assinaturas Ativas</div>
                        <p class="card-value" id="valUsuariosAtivos">--</p>
                    </div>
                    <div class="card-metric" style="border-top: 4px solid var(--cor-primaria);">
                        <div class="card-title">Receita Mensal (MRR)</div>
                        <p class="card-value" id="valMRR">R$ 0,00 <span>Estimado</span></p>
                    </div>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0;">
                    <h3 style="margin-top: 0; color: #0f172a;">√öltimos PCs Conectados</h3>
                    <p style="color: #64748b; font-size: 14px;"><div style="margin-top: 15px; overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; text-align: left;">
                            <thead style="background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                                <tr>
                                    <th style="padding: 12px 15px; color: #64748b; font-size: 13px; font-weight: 600;">Computador</th>
                                    <th style="padding: 12px 15px; color: #64748b; font-size: 13px; font-weight: 600;">Pai / Respons√°vel</th>
                                    <th style="padding: 12px 15px; color: #64748b; font-size: 13px; font-weight: 600; text-align: center;">Status</th>
                                </tr>
                            </thead>
                            <tbody id="listaPCsBody">
                                <tr><td colspan="3" style="text-align: center; padding: 20px; color: #64748b;">Buscando computadores na rede... üì°</td></tr>
                            </tbody>
                        </table>
                    </div></p>
                </div>
            </div>

          <div id="tab-clientes" class="conteudo-tela">
                               <div class="card" style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2>üë• Gest√£o de Clientes</h2>
                        <button onclick="carregarClientes()" style="background: white; border: 1px solid #cbd5e1; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 13px;">üîÑ Atualizar</button>
                    </div>

                    <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                        <div style="background: #fef08a; color: #854d0e; padding: 8px 15px; border-radius: 8px; font-weight: bold; font-size: 13px; display: flex; align-items: center; gap: 5px;">
                            ‚≠ê Premium: <span id="contadorPremium" style="font-size: 16px;">0</span>
                        </div>
                        <div style="background: #eff6ff; color: #1e3a8a; padding: 8px 15px; border-radius: 8px; font-weight: bold; font-size: 13px; display: flex; align-items: center; gap: 5px;">
                            ‚è≥ Trial (Testes): <span id="contadorTrial" style="font-size: 16px;">0</span>
                        </div>
                    </div>

                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; text-align: left;">
                            <thead style="background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                                <tr>
                                    <th style="padding: 12px 15px; color: #64748b; font-size: 13px; font-weight: 600;">E-mail do Pai</th>
                                    <th style="padding: 12px 15px; color: #64748b; font-size: 13px; font-weight: 600;">Cadastro</th>
                                    <th style="padding: 12px 15px; color: #64748b; font-size: 13px; font-weight: 600;">Plano</th>
                                    <th style="padding: 12px 15px; color: #64748b; font-size: 13px; font-weight: 600;">Vencimento</th>
                                    <th style="padding: 12px 15px; color: #64748b; font-size: 13px; font-weight: 600; text-align: center;">Filhos</th>
                                    <th style="padding: 12px 15px; color: #64748b; font-size: 13px; font-weight: 600;">Status</th>
                                    <th style="padding: 12px 15px; color: #64748b; font-size: 13px; font-weight: 600; text-align: right;">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="listaClientes">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-financeiro" class="conteudo-tela">
                <h2 style="margin-top: 0; color: #0f172a; margin-bottom: 20px;">Integra√ß√£o de Pagamento</h2>
                
                <div class="card-metric" style="max-width: 600px;">
                    <p style="color: #64748b; font-size: 14px; margin-top: 0; margin-bottom: 20px;">
                        Configure como os pais far√£o o pagamento. O valor digitado aqui atualizar√° o c√°lculo do seu Dashboard automaticamente.
                    </p>

                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #475569; font-size: 14px;">Gateway Principal</label>
                    <select id="selectGateway" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; margin-bottom: 20px; font-size: 14px; background: #f8fafc;">
                        <option value="mercadopago">Mercado Pago</option>
                        <option value="stripe">Stripe</option>
                        <option value="asaas">Asaas</option>
                        <option value="manual">Manual (Pix Direto / WhatsApp)</option>
                    </select>

                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #475569; font-size: 14px;">Link de Checkout (URL de Pagamento)</label>
                    <input type="text" id="linkCheckout" placeholder="Ex: https://mpago.la/..." style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; margin-bottom: 20px; font-size: 14px; box-sizing: border-box;">

                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #475569; font-size: 14px;">Valor Mensal da Assinatura (R$)</label>
                    <input type="number" id="valorAssinatura" placeholder="Ex: 29.90" step="0.01" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; margin-bottom: 30px; font-size: 14px; box-sizing: border-box;">

                    <button onclick="salvarConfigPagamento(this)" style="background: #10b981; color: white; border: none; padding: 14px 20px; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: bold; width: 100%; box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2); transition: 0.2s;">
                        üíæ Salvar Configura√ß√µes
                    </button>
                </div>
            </div>

            <div id="tab-avisos" class="conteudo-tela">
                <h2 style="margin-top: 0; color: #0f172a; margin-bottom: 20px;">üì¢ Disparador de Avisos</h2>
                
                <div class="card-metric" style="max-width: 600px;">
                    <p style="color: #64748b; font-size: 14px; margin-top: 0; margin-bottom: 20px;">
                        Escreva uma mensagem aqui e ela aparecer√° instantaneamente como um pop-up no ecr√£ de todos os pais que estiverem com o painel aberto.
                    </p>

                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #475569; font-size: 14px;">Tipo de Mensagem</label>
                    <select id="tipoAviso" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; margin-bottom: 20px; font-size: 14px; background: #f8fafc;">
                        <option value="info">üîµ Informativo (Novidades, dicas)</option>
                        <option value="alerta">üü† Alerta (Aviso de manuten√ß√£o, instabilidade)</option>
                        <option value="urgente">üî¥ Urgente (Bloqueios gerais, avisos cr√≠ticos)</option>
                    </select>

                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #475569; font-size: 14px;">A sua Mensagem</label>
                    <textarea id="textoAvisoGlobal" rows="4" placeholder="Escreva o seu aviso para os pais aqui..." style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; margin-bottom: 20px; font-size: 14px; box-sizing: border-box; resize: vertical;"></textarea>

                    <button onclick="dispararAviso(this)" style="background: #3498db; color: white; border: none; padding: 14px 20px; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: bold; width: 100%; box-shadow: 0 4px 6px rgba(52, 152, 219, 0.2); transition: 0.2s;">
                        üöÄ Disparar para Todos
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, getDocs, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

         const firebaseConfig = { apiKey: "AIzaSyAh3J8bp7xvNGct8k4TfAoCcIpVRoWjBYI", authDomain: "rotinaeduardo.firebaseapp.com", projectId: "rotinaeduardo", storageBucket: "rotinaeduardo.firebasestorage.app", messagingSenderId: "210945268922", appId: "1:210945268922:web:ce9e585872090b378d7683", measurementId: "G-MDYWRH9RNP" };
       

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // O SEGURAN√áA VIP
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Pergunta pro Firestore: Esse cara t√° na lista de Admins?
                const docRef = doc(db, "admins", user.uid);
                try {
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        // √â O DONO! Apaga a tela de carregamento e mostra o painel
                        document.getElementById('telaSeguranca').style.display = 'none';
                        document.getElementById('adminWrapper').style.display = 'flex';
                        // LIGA O CONTADOR AQUI üëá
                        carregarEstatisticas();
                        carregarClientes(); // <-- LIGA A TABELA AQUI!
                        carregarConfigPagamento(); // <-- LIGA O GATEWAY AQUI!
                        carregarUltimosPCs(); // <--- LIGA O RADAR AQUI!
                    } else {
                        // √â UM PAI TENTANDO ENTRAR AQUI! Chuta pro site normal.
                        alert("‚õî Acesso Restrito! √Årea exclusiva da administra√ß√£o.");
                        window.location.replace("painel.html"); 
                    }
                } catch (error) {
                    console.error("Erro na valida√ß√£o VIP:", error);
                    window.location.replace("index.html");
                }
            } else {
                window.location.replace("painel.html"); // Ningu√©m logado
            }
        });

        // FUN√á√ÉO QUE PUXA OS N√öMEROS DO BANCO
   window.carregarEstatisticas = async function() {
            try {
                // 1. Descobre qual o valor da assinatura que voc√™ configurou no Gateway
                let valorMensalidade = 0;
                const configSnap = await getDoc(doc(db, "configuracoes", "pagamento"));
                if (configSnap.exists()) {
                    valorMensalidade = configSnap.data().valor_mensal || 0;
                }

                // 2. Conta os clientes
                const assinaturasRef = collection(db, "assinaturas");
                const snapshot = await getDocs(assinaturasRef);

                let totalUsuarios = 0;
                let usuariosAtivos = 0;

                snapshot.forEach((doc) => {
                    totalUsuarios++; 
                    if (doc.data().status === "ativo") usuariosAtivos++; 
                });

                // 3. Calcula e mostra na tela
                const mrrTotal = usuariosAtivos * valorMensalidade;
                const mrrFormatado = mrrTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

                document.getElementById('valTotalUsuarios').innerText = totalUsuarios;
                document.getElementById('valUsuariosAtivos').innerText = usuariosAtivos;
                document.getElementById('valMRR').innerHTML = mrrFormatado + " <span>Estimado</span>";

            } catch (erro) {
                console.error("Erro ao buscar as estat√≠sticas:", erro);
            }
        };
      // FUN√á√ÉO QUE CARREGA CLIENTES, DATA DE CADASTRO E CONTA FILHOS
        window.carregarClientes = async function() {
            const tbody = document.getElementById('listaClientes');
            if (!tbody) return;

            // Muda o colspan para 7 porque agora temos mais colunas
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #64748b;">Carregando clientes e contando filhos... ‚è≥</td></tr>';

            try {
                const querySnapshot = await getDocs(collection(db, "assinaturas"));
                
                let totalPremium = 0;
                let totalTrial = 0;
                let htmlTabela = ""; // Vamos construir a tabela aqui primeiro

                // Usa um loop "for...of" para conseguirmos usar o "await" ao contar os filhos
                for (const docPai of querySnapshot.docs) {
                    const dados = docPai.data();
                    const id = docPai.id;
                    const email = dados.email || "Sem e-mail";
                    const status = dados.status || "bloqueado";
                    const plano = dados.plano || "N/A";
                    
                    // --- 1. CONTA QUANTOS FILHOS ESTE PAI TEM ---
                    const filhosRef = collection(db, "usuarios", id, "filhos");
                    const filhosSnap = await getDocs(filhosRef);
                    const qtdFilhos = filhosSnap.size; // Pega o n√∫mero exato de perfis!

                    // Atualiza os Contadores do topo
                    if (plano === "premium") totalPremium++;
                    if (plano === "trial") totalTrial++;

                    // --- 2. DESCOBRE A DATA DE CADASTRO ---
                    let dataCadastroFormatada = "Antigo";
                    let timestampCadastro = dados.dataCadastro;
                    
                    // Truque: Se n√£o salvamos a data de cadastro, deduzimos subtraindo 7 dias do vencimento Trial!
                    if (!timestampCadastro && dados.vencimento && plano === "trial") {
                        timestampCadastro = dados.vencimento - (7 * 24 * 60 * 60 * 1000);
                    }

                    if (timestampCadastro) {
                        const d = new Date(timestampCadastro);
                        dataCadastroFormatada = `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
                    }

                    // --- 3. FORMATA A DATA DE VENCIMENTO ---
                    let dataVencimentoFormatada = "--/--/----";
                    if (dados.vencimento) {
                        const dataObj = new Date(dados.vencimento);
                        const dia = String(dataObj.getDate()).padStart(2, '0');
                        const mes = String(dataObj.getMonth() + 1).padStart(2, '0');
                        const ano = dataObj.getFullYear();
                        dataVencimentoFormatada = `${dia}/${mes}/${ano}`;
                        
                        // Destaca em vermelho se estiver vencido
                        const hoje = new Date().getTime();
                        if (hoje > dados.vencimento) {
                            dataVencimentoFormatada = `<span style="color: #ef4444; font-weight: bold;">${dataVencimentoFormatada} <br><small>(Vencido)</small></span>`;
                        }
                    }

                    // --- 4. CORES DIN√ÇMICAS ---
                    const isAtivo = status === 'ativo';
                    const corStatus = isAtivo ? '#dcfce7' : '#fee2e2';
                    const corTextoStatus = isAtivo ? '#166534' : '#991b1b';
                    const textoBotao = isAtivo ? 'üîí Bloquear' : 'üîì Liberar';
                    const corBotao = isAtivo ? '#ef4444' : '#10b981';
                    
                    const corPlano = plano === 'premium' ? '#fef08a' : '#eff6ff';
                    const corTextoPlano = plano === 'premium' ? '#854d0e' : '#1e3a8a';
                    const iconePlano = plano === 'premium' ? '‚≠ê' : '‚è≥';

                    // --- 5. ADICIONA A LINHA NA TABELA ---
                    htmlTabela += `
                        <tr style="border-bottom: 1px solid #f1f5f9;">
                            <td style="padding: 12px 15px; color: #334155; font-weight: 500;">${email}</td>
                            <td style="padding: 12px 15px; color: #64748b; font-size: 13px; font-weight: 600;">üìÖ ${dataCadastroFormatada}</td>
                            <td style="padding: 12px 15px;">
                                <span style="background: ${corPlano}; color: ${corTextoPlano}; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; text-transform: uppercase;">
                                    ${iconePlano} ${plano}
                                </span>
                            </td>
                            <td style="padding: 12px 15px; color: #64748b; font-size: 13px;">${dataVencimentoFormatada}</td>
                            <td style="padding: 12px 15px; font-weight: bold; color: #0ea5e9; text-align: center; font-size: 14px;">üë¶ ${qtdFilhos}</td>
                            <td style="padding: 12px 15px;">
                                <span style="background: ${corStatus}; color: ${corTextoStatus}; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; text-transform: uppercase;">
                                    ${status}
                                </span>
                            </td>
                            <td style="padding: 12px 15px; text-align: right;">
                                <button onclick="alterarStatus('${id}', '${status}')" style="background: ${corBotao}; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold; transition: 0.2s;">
                                    ${textoBotao}
                                </button>
                            </td>
                        </tr>
                    `;
                }
                
                // Joga todo o HTML para dentro da tabela de uma vez
                tbody.innerHTML = htmlTabela || '<tr><td colspan="7" style="text-align: center; color: #94a3b8; padding: 20px;">Nenhum cliente encontrado.</td></tr>';
                
                // Atualiza os n√∫meros no topo
                const elPremium = document.getElementById('contadorPremium');
                const elTrial = document.getElementById('contadorTrial');
                if(elPremium) elPremium.innerText = totalPremium;
                if(elTrial) elTrial.innerText = totalTrial;

            } catch (erro) {
                console.error("Erro ao carregar clientes:", erro);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #ef4444; padding: 20px;">Erro ao carregar os dados.</td></tr>';
            }
        };
// FUN√á√ÉO QUE RASTREA OS PCs CONECTADOS (O CLONE EXATO DO PAINEL)
        window.carregarUltimosPCs = async function() {
            const tbody = document.getElementById('listaPCsBody');
            if (!tbody) return;

            try {
                // 1. Pega a lista de todos os pais
                const paisRef = collection(db, "assinaturas");
                const paisSnap = await getDocs(paisRef);
                
                let todosPCs = [];

                // 2. Vai de pai em pai...
                for (const docPai of paisSnap.docs) {
                    const paiId = docPai.id;
                    const paiEmail = docPai.data().email || "Sem e-mail";

                    const filhosRef = collection(db, "usuarios", paiId, "filhos");
                    const filhosSnap = await getDocs(filhosRef);

                    // 3. Vai de filho em filho...
                    for (const docFilho of filhosSnap.docs) {
                        const filhoId = docFilho.id;
                        
                        // 4. AQUI ESTAVA O SEGREDO! Busca na pasta correta: "dispositivos"
                        const dispRef = collection(db, "usuarios", paiId, "filhos", filhoId, "dispositivos");
                        const dispSnap = await getDocs(dispRef);

                        dispSnap.forEach(docDisp => {
                            const dev = docDisp.data();
                            
                            // A MESMA M√ÅGICA DO SEU PAINEL AQUI:
                            let isOnline = false;
                            let pingTime = 0;

                            if (dev.online) {
                                // Pega a data que o Firebase salvou e transforma em tempo real
                                pingTime = dev.online.toDate().getTime();
                                const agora = new Date().getTime();
                                
                                // Se a diferen√ßa for menor que 120000ms (2 minutos), est√° ONLINE!
                                if ((agora - pingTime) < 120000) {
                                    isOnline = true;
                                }
                            }

                            todosPCs.push({
                                nome: dev.nome || "PC Desconhecido",
                                paiEmail: paiEmail,
                                status: isOnline ? "online" : "offline",
                                ultimoPing: pingTime
                            });
                        });
                    }
                }

                // 5. Ordena a lista: Quem t√° online aparece no topo!
                todosPCs.sort((a, b) => {
                    if (a.status === 'online' && b.status !== 'online') return -1;
                    if (b.status === 'online' && a.status !== 'online') return 1;
                    return b.ultimoPing - a.ultimoPing; 
                });

                // Pega s√≥ os 10 mais recentes
                const topPCs = todosPCs.slice(0, 10);

                tbody.innerHTML = ""; 

                if (topPCs.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='3' style='text-align: center; padding: 20px; color: #94a3b8;'>Nenhum computador conectado ainda.</td></tr>";
                    return;
                }

                // 6. Desenha na tela
                topPCs.forEach(pc => {
                    const corFundo = pc.status === 'online' ? '#dcfce7' : '#fee2e2';
                    const corTexto = pc.status === 'online' ? '#166534' : '#991b1b';

                    tbody.innerHTML += `
                        <tr style="border-bottom: 1px solid #f1f5f9;">
                            <td style="padding: 12px 15px; font-weight: 600; color: #334155;">üíª ${pc.nome}</td>
                            <td style="padding: 12px 15px; color: #64748b; font-size: 14px;">${pc.paiEmail}</td>
                            <td style="padding: 12px 15px; text-align: center;">
                                <span style="background: ${corFundo}; color: ${corTexto}; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; text-transform: uppercase;">
                                    ${pc.status}
                                </span>
                            </td>
                        </tr>
                    `;
                });

            } catch (erro) {
                console.error("Erro ao rastrear PCs:", erro);
                tbody.innerHTML = "<tr><td colspan='3' style='text-align: center; padding: 20px; color: #ef4444;'>Erro ao buscar computadores.</td></tr>";
            }
        };
        // FUN√á√ÉO QUE ATUALIZA O STATUS NO BANCO DE DADOS
   window.alterarStatus = async function(idUsuario, statusAtual) {
            const novoStatus = statusAtual === 'ativo' ? 'bloqueado' : 'ativo';
            const confirmacao = confirm(`Tem certeza que deseja ${novoStatus === 'ativo' ? 'LIBERAR' : 'BLOQUEAR'} este cliente?`);
            
            if (confirmacao) {
                try {
                    const docRef = doc(db, "assinaturas", idUsuario);
                    
                    // Calcula 30 dias a partir de AGORA
                    const hoje = new Date();
                    const trintaDias = hoje.getTime() + (30 * 24 * 60 * 60 * 1000);

                    // A M√ÅGICA: Se ativar, vira Premium e ganha 30 dias. Se n√£o, √© bloqueado.
                    const dadosAtualizar = novoStatus === 'ativo' ? 
                                          { status: 'ativo', plano: 'premium', vencimento: trintaDias } : 
                                          { status: 'bloqueado' };
                                          
                    await updateDoc(docRef, dadosAtualizar);
                    
                    carregarClientes(); 
                    carregarEstatisticas(); 
                } catch (erro) {
                    console.error("Erro ao alterar status:", erro);
                    alert("Erro ao alterar o status.");
                }
            }
        };
        // FUN√á√ÉO QUE SALVA AS CONFIGURA√á√ïES DE PAGAMENTO
        window.salvarConfigPagamento = async function(botao) {
            botao.innerText = "‚è≥ Salvando..."; // Efeito visual
            
            const gateway = document.getElementById('selectGateway').value;
            const link = document.getElementById('linkCheckout').value;
            const valor = parseFloat(document.getElementById('valorAssinatura').value) || 0;

            try {
                // Cria uma "pasta" secreta no banco chamada "configuracoes"
                const configRef = doc(db, "configuracoes", "pagamento");
                await setDoc(configRef, {
                    gateway: gateway,
                    link_checkout: link,
                    valor_mensal: valor
                }, { merge: true }); // Merge garante que n√£o apague outras coisas

                alert("‚úÖ Configura√ß√µes de Gateway salvas com sucesso!");
                carregarEstatisticas(); // Recalcula o painel principal!
            } catch (erro) {
                console.error("Erro ao salvar pagamento:", erro);
                alert("Erro ao salvar. Verifique o console.");
            }
            
            botao.innerText = "üíæ Salvar Configura√ß√µes";
        };
// FUN√á√ÉO QUE DISPARA O AVISO PARA TODOS OS CLIENTES
        window.dispararAviso = async function(botao) {
            const texto = document.getElementById('textoAvisoGlobal').value;
            const tipo = document.getElementById('tipoAviso').value;

            // Bloqueia se a caixa de texto estiver vazia
            if (!texto.trim()) {
                alert("‚ö†Ô∏è Por favor, escreva uma mensagem antes de disparar!");
                return;
            }

            botao.innerText = "‚è≥ A Enviar...";

            try {
                // Cria/Atualiza um documento global no banco de dados que todos os pais v√£o "escutar"
                const avisoRef = doc(db, "configuracoes", "aviso_global");
                await setDoc(avisoRef, {
                    mensagem: texto,
                    tipo: tipo,
                    // Usamos a data/hora exata do envio para o sistema dos pais saber que √© um aviso NOVO
                    timestamp: new Date().getTime() 
                });

                alert("‚úÖ Megafone ativado! O aviso foi disparado com sucesso para todos os clientes.");
                document.getElementById('textoAvisoGlobal').value = ""; // Limpa a caixa de texto ap√≥s o envio
                
            } catch (erro) {
                console.error("Erro ao disparar aviso:", erro);
                alert("Ocorreu um erro ao enviar o aviso. Verifique a consola.");
            }
            
            botao.innerText = "üöÄ Disparar para Todos";
        };
        // FUN√á√ÉO QUE CARREGA AS CONFIGURA√á√ïES AO ABRIR A TELA
        window.carregarConfigPagamento = async function() {
            try {
                const configRef = doc(db, "configuracoes", "pagamento");
                const docSnap = await getDoc(configRef);
                
                if (docSnap.exists()) {
                    const dados = docSnap.data();
                    document.getElementById('selectGateway').value = dados.gateway || 'mercadopago';
                    document.getElementById('linkCheckout').value = dados.link_checkout || '';
                    document.getElementById('valorAssinatura').value = dados.valor_mensal || '';
                }
            } catch (erro) {
                console.error("Erro ao carregar configura√ß√µes de pagamento:", erro);
            }
        };
        // Fun√ß√£o de navegar no menu lateral
        window.mudarAba = function(abaId, elementoClicado) {
            // Esconde todas as telas
            document.querySelectorAll('.conteudo-tela').forEach(t => t.classList.remove('ativa'));
            // Tira o destaque de todos os bot√µes do menu
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('ativo'));
            
            // Mostra a tela certa e destaca o bot√£o clicado
            document.getElementById('tab-' + abaId).classList.add('ativa');
            elementoClicado.classList.add('ativo');

            // Atualiza o t√≠tulo l√° no topo
            document.getElementById('tituloPagina').innerText = elementoClicado.innerText.replace(/[^\w\s√Ä-√∫]/g, '').trim(); // Remove emojis do t√≠tulo
        };

        // Fun√ß√£o de sair
        window.sairDoAdmin = function() {
            signOut(auth).then(() => {
                window.location.replace("painel.html");
            });
        };
    </script>
        <script>
        // FUN√á√ÉO PARA ABRIR E FECHAR O MENU MOBILE
        window.toggleMenuMobile = function() {
            // Pega a barra lateral escura
            const menu = document.querySelector('#adminWrapper > div:nth-child(1)');
            // Pega o fundo escuro
            const overlay = document.getElementById('overlayMenu');
            
            // Se estiver aberto, ele fecha. Se estiver fechado, ele abre!
            if (menu.classList.contains('menu-aberto')) {
                menu.classList.remove('menu-aberto');
                overlay.style.display = 'none';
            } else {
                menu.classList.add('menu-aberto');
                overlay.style.display = 'block';
            }
        };
    </script>

</body>

</html>


