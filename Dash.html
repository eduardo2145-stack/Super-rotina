<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Amigo Virtual - Gamificado</title>
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* Paleta TEA Friendly */
        :root { 
            --cor-primaria: #93C49D; 
            --cor-secundaria: #F4D03F; /* Amarelo Estrela Suave */
            --cor-texto: #5A5A5A; 
            --fundo-base: #F7F5F0; 
        }
        
        * { box-sizing: border-box; }

        html, body { 
            margin: 0; padding: 0; width: 100vw; height: 100vh; 
            overflow: hidden !important; overscroll-behavior: none; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--fundo-base);
        }

        body {
            background: linear-gradient(to bottom, #EBF4F6 0%, #F7F5F0 50%, #E9F0E6 100%);
            background-image: url('IMG/bg.jpg'); 
            background-size: cover; background-position: center;
            background-attachment: fixed; background-blend-mode: overlay; 
        }

        #app-scroll-wrapper {
            width: 100%; height: 100%; overflow-y: auto; overflow-x: hidden !important; 
            -webkit-overflow-scrolling: touch; position: relative;
        }

        #app-scroll-wrapper::-webkit-scrollbar { display: none; } 
        #app-scroll-wrapper { -ms-overflow-style: none; scrollbar-width: none; } 

        /* --- PLACAR DE ESTRELAS NO TOPO DIREITO --- */
        #placar-estrelas {
            position: fixed; top: 20px; right: 20px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95); border: 2px solid #F4D03F; padding: 10px 20px;
            border-radius: 30px; font-size: 22px; font-weight: 900; color: #D4AC0D;
            box-shadow: 0 5px 15px rgba(244, 208, 63, 0.3); backdrop-filter: blur(5px);
            display: none; /* S√≥ aparece quando logado */
            align-items: center; gap: 8px; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        /* Anima√ß√£o quando ganha estrela */
        .placar-animado { transform: scale(1.2); color: #F1C40F !important; }

        /* --- MENUS E LOGIN --- */
        .tela-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(247, 245, 240, 0.92); backdrop-filter: blur(8px); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; }
        .box-auth { background: white; padding: 40px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.06); text-align: center; max-width: 350px; width: 90%; border: 2px solid #EBEBEB; }
        .box-auth h1 { margin-top: 0; color: var(--cor-texto); font-size: 24px; font-weight: 700; }
        .box-auth input { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #E0E0E0; border-radius: 12px; font-size: 16px; outline: none; color: var(--cor-texto); background: #FCFCFC; }
        .box-auth input:focus { border-color: var(--cor-primaria); background: #FFF; }
        .box-auth button { width: 100%; padding: 15px; background: var(--cor-primaria); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.3s; }
        
        #grid-filhos { display: flex; flex-direction: column; gap: 15px; width: 100%; max-width: 300px; margin-top: 20px; }
        .btn-filho { background: white; border: 2px solid var(--cor-primaria); padding: 18px; border-radius: 16px; font-size: 20px; font-weight: bold; color: var(--cor-texto); cursor: pointer; transition: 0.2s; }
        .btn-filho:hover { background: var(--cor-primaria); color: white; transform: translateY(-2px); }
        .btn-sair { background: transparent !important; color: #D98880 !important; border: 2px solid #D98880 !important; margin-top: 20px;}

        #menu-container { position: fixed; top: 20px; left: 20px; z-index: 1000; }
        #menu-btn { background: rgba(255,255,255,0.9); border: 2px solid #EBEBEB; padding: 10px 20px; border-radius: 30px; cursor: pointer; font-weight: bold; font-size: 15px; display: flex; align-items: center; gap: 8px; color: var(--cor-texto); backdrop-filter: blur(5px); }
        #lista-criancas { background: white; border-radius: 16px; box-shadow: 0 8px 25px rgba(0,0,0,0.08); display: none; padding: 8px; border: 1px solid #EBEBEB; margin-top: 8px; min-width: 160px; }
        .opcao-crianca { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #F0F0F0; font-size: 15px; border-radius: 10px; font-weight: 600; color: var(--cor-texto);}

        /* --- MODAL DE AVALIA√á√ÉO (GAMEFICA√á√ÉO) --- */
        #modalAvaliacao { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            background: rgba(247, 245, 240, 0.85); backdrop-filter: blur(8px);
            display: none; align-items: center; justify-content: center; z-index: 9999;
            opacity: 0; transition: opacity 0.3s ease;
        }
        
        .box-avaliacao {
            background: white; padding: 35px 30px; border-radius: 28px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.1); text-align: center; max-width: 380px; width: 90%;
            border: 2px solid #F0F0F0; transform: translateY(30px); transition: transform 0.4s ease;
        }

        #modalAvaliacao.ativo { opacity: 1; display: flex; }
        #modalAvaliacao.ativo .box-avaliacao { transform: translateY(0); }

        .box-avaliacao h2 { margin: 0 0 10px 0; color: var(--cor-texto); font-size: 24px; text-transform: uppercase; }
        .box-avaliacao p.sub { color: #888; font-size: 15px; margin-bottom: 25px; }

        .botoes-estrelas { display: flex; flex-direction: column; gap: 12px; }
        
        .btn-star {
            background: #FFFDE7; border: 2px solid #F4D03F; padding: 15px; border-radius: 18px;
            font-size: 26px; cursor: pointer; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 5px;
            box-shadow: 0 4px 10px rgba(244, 208, 63, 0.15);
        }
        .btn-star:hover { background: #FCF3CF; transform: scale(1.03); }
        .btn-star:active { transform: scale(0.97); }

        .btn-nao-fez {
            background: transparent; color: #D98880; border: 2px dashed #D98880; padding: 12px;
            border-radius: 15px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 15px; font-size: 16px; transition: 0.2s;
        }
        .btn-nao-fez:hover { background: #FDEDEC; }

        #mensagem-feedback {
            font-size: 18px; font-weight: 800; color: var(--cor-primaria); margin-top: 20px; 
            min-height: 25px; opacity: 0; transition: opacity 0.3s;
        }

        /* --- ESTRADA E √çCONES (Mantidos Intactos) --- */
        #mapa-container { position: relative; width: 100%; max-width: 1100px; margin: 150px auto 50px auto; padding-bottom: 80px; }
        svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; overflow: visible; }
        
        .estrada-corpo { fill: none; stroke-width: 45; stroke-linecap: round; opacity: 1; filter: drop-shadow(0 6px 12px rgba(0,0,0,0.06)); }
        .estrada-tracejada { fill: none; stroke: rgba(255,255,255,0.8); stroke-width: 4; stroke-dasharray: 14,14; stroke-linecap: round; pointer-events: none; z-index: 3; }
        
        .c-1 { stroke: #E8B87D; } .c-2 { stroke: #93C49D; } .c-3 { stroke: #80C2D6; } .c-4 { stroke: #86A3D4; } .c-5 { stroke: #B4A3D6; } 

        .marcador { position: absolute; width: 0; height: 0; z-index: 10; transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }

        .icone-circulo {
            position: absolute; left: 0; top: 0; transform: translate(-50%, -50%);
            width: 82px; height: 82px; background: white; border-radius: 50%; border: 5px solid #ccc;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08); display: flex; align-items: center; justify-content: center;
            overflow: hidden; z-index: 3; transition: all 0.3s ease; cursor: pointer;
        }
        .icone-circulo:hover { transform: translate(-50%, -50%) scale(1.05); box-shadow: 0 12px 25px rgba(0,0,0,0.12); }
        .icone-circulo:active { transform: translate(-50%, -50%) scale(0.98); }
        .icone-circulo img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }

        .textos { position: absolute; left: 0; bottom: 55px; transform: translateX(-50%); width: 220px; text-align: center; z-index: 5; pointer-events: none; display: flex; flex-direction: column; align-items: center; }
        .badge-hora { display: inline-block; padding: 4px 16px; border-radius: 20px; color: white !important; font-size: 16px; font-weight: 800; box-shadow: 0 4px 10px rgba(0,0,0,0.08); margin-bottom: 6px; border: 2px solid rgba(255,255,255,0.5); }
        .textos .acao { display: block; font-size: 14px; font-weight: 700; color: var(--cor-texto) !important; text-transform: uppercase; text-shadow: 0 2px 5px rgba(255,255,255,0.9), 0 -2px 5px rgba(255,255,255,0.9), 2px 0 5px rgba(255,255,255,0.9), -2px 0 5px rgba(255,255,255,0.9); }

        .passado .icone-circulo { border-color: #D5D5D5 !important; opacity: 0.7; filter: grayscale(0.4) opacity(0.8); transform: translate(-50%, -50%) scale(0.95); box-shadow: none; }
        .passado .textos { opacity: 0.6; }
        
        .agora { z-index: 100; }
        .agora .icone-circulo { border-color: var(--cor-primaria) !important; box-shadow: 0 0 0 4px rgba(147, 196, 157, 0.2), 0 15px 30px rgba(0,0,0,0.1); animation: respiracaoCalma 3s infinite alternate ease-in-out; }
        .agora .badge-hora { transform: scale(1.05); background: var(--cor-primaria) !important; box-shadow: 0 4px 12px rgba(147, 196, 157, 0.4); }

        @keyframes respiracaoCalma { 
            0% { transform: translate(-50%, -50%) scale(1); } 
            100% { transform: translate(-50%, -50%) scale(1.04); box-shadow: 0 0 0 8px rgba(147, 196, 157, 0.1), 0 20px 40px rgba(0,0,0,0.15); } 
        }
    </style>
</head>
<body>

    <div id="app-scroll-wrapper">

        <div id="placar-estrelas">
            ‚≠ê <span id="num-estrelas">0</span>
        </div>

        <div id="modalAvaliacao" onclick="fecharAvaliacao()">
            <div class="box-avaliacao" onclick="event.stopPropagation()">
                <h2 id="titulo-aval">Atividade</h2>
                <p class="sub">Como voc√™ se saiu nessa tarefa?</p>
                
                <div class="botoes-estrelas">
                    <button class="btn-star" onclick="avaliar(3)">‚≠ê ‚≠ê ‚≠ê</button>
                    <button class="btn-star" onclick="avaliar(2)">‚≠ê ‚≠ê</button>
                    <button class="btn-star" onclick="avaliar(1)">‚≠ê</button>
                </div>
                
                <button class="btn-nao-fez" onclick="avaliar(0)">N√£o executei</button>
                
                <div id="mensagem-feedback"></div>
            </div>
        </div>

        <div id="telaLogin" class="tela-overlay" style="display: flex;">
            <div class="box-auth">
                <h1>Login Amigo Virtual</h1>
                <p style="color:#888; margin-bottom: 20px; font-size: 14px;">Use a mesma conta do painel</p>
                <input type="email" id="inputEmail" placeholder="Seu E-mail">
                <input type="password" id="inputSenha" placeholder="Sua Senha">
                <button onclick="fazerLogin()">ENTRAR NO PAINEL</button>
            </div>
        </div>

        <div id="telaSelecionarFilho" class="tela-overlay" style="display: none;">
            <h1 style="color: var(--cor-texto); font-size: 28px;">Quem est√° usando?</h1>
            <div id="grid-filhos"></div>
            <button class="btn-filho btn-sair" onclick="sairApp()">Sair da Conta</button>
        </div>

        <div id="telaMapa" style="display: none;">
            <div id="menu-container">
                <button id="menu-btn" onclick="toggleMenu()">ü§ñ <span id="nome-atual">...</span> ‚ñæ</button>
                <div id="lista-criancas">
                    <div id="menu-filhos-items"></div>
                    <div class="opcao-crianca" style="color:#D98880; border-top: 1px solid #F0F0F0; text-align: center;" onclick="sairApp()">Sair da Conta</div>
                </div>
            </div>

            <div id="mapa-container">
                <svg id="svgEstrada">
                    <g id="camada-cores"></g>
                    <path id="pathCinzaPassado" class="estrada-corpo" style="stroke: #EAE6DF; opacity: 0.9; transition: stroke-dashoffset 1.5s ease-in-out; z-index: 2;" />
                    <path id="pathTracejado" class="estrada-tracejada" />
                </svg>
                <div id="cards-layer"></div>
            </div>
        </div>

    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyAh3J8bp7xvNGct8k4TfAoCcIpVRoWjBYI", authDomain: "rotinaeduardo.firebaseapp.com", projectId: "rotinaeduardo", appId: "1:210945268922:web:ce9e585872090b378d7683" };
    const app = initializeApp(firebaseConfig); 
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    let id_usuario_pai = null; 
    let caminho_dados = localStorage.getItem('caminho_dados');
    let nome_crianca = localStorage.getItem('nome_crianca');
    let cacheAtividades = {};
    let rotinasCache = [];
    
    let rotinaAvaliacaoAtual = null; // Guarda o ID da rotina que est√° sendo avaliada

    // ==========================================
    // L√ìGICA DE GAMIFICA√á√ÉO E AVALIA√á√ÉO
    // ==========================================
    
    // Pega a data de hoje formatada (Ex: "2026-02-20") para resetar as estrelas todo dia
    function obterDataDeHoje() {
        const hoje = new Date();
        return `${hoje.getFullYear()}-${String(hoje.getMonth()+1).padStart(2,'0')}-${String(hoje.getDate()).padStart(2,'0')}`;
    }

    window.abrirModalAvaliacao = (idRotina, nomeAcao) => {
        rotinaAvaliacaoAtual = idRotina;
        document.getElementById('titulo-aval').innerText = nomeAcao;
        document.getElementById('mensagem-feedback').style.opacity = '0';
        
        const modal = document.getElementById('modalAvaliacao');
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('ativo'), 10);
    };

    window.fecharAvaliacao = () => {
        const modal = document.getElementById('modalAvaliacao');
        modal.classList.remove('ativo');
        setTimeout(() => { modal.style.display = 'none'; rotinaAvaliacaoAtual = null; }, 300); 
    };

    window.avaliar = async (qtdEstrelas) => {
        if(!rotinaAvaliacaoAtual) return;
        
        const feedbackEl = document.getElementById('mensagem-feedback');
        
        // As mensagens m√°gicas que voc√™ pediu!
        if(qtdEstrelas === 3) {
            feedbackEl.innerText = "Parab√©ns! Voc√™ √© incr√≠vel! üöÄ";
            feedbackEl.style.color = "#27AE60";
            // Solta os fogos! (Confete)
            confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
        } else if (qtdEstrelas === 2) {
            feedbackEl.innerText = "Continue assim, voc√™ chega l√°! üëç";
            feedbackEl.style.color = "#F39C12";
        } else if (qtdEstrelas === 1) {
            feedbackEl.innerText = "Muito bom, mas vamos melhorar! üí™";
            feedbackEl.style.color = "#E67E22";
        } else {
            feedbackEl.innerText = "Tudo bem, tentaremos amanh√£! üíô";
            feedbackEl.style.color = "#D98880";
        }

        feedbackEl.style.opacity = '1';

        // Salva a avalia√ß√£o no Firebase (na rotina espec√≠fica, com a data de hoje)
        const rotinaRef = doc(db, `${caminho_dados}/rotinas`, rotinaAvaliacaoAtual);
        await updateDoc(rotinaRef, {
            estrelas_ganhas: qtdEstrelas,
            data_avaliacao: obterDataDeHoje()
        });

        // Espera 2.5 segundos para a crian√ßa ler a mensagem e fecha sozinho
        setTimeout(() => {
            fecharAvaliacao();
        }, 2500);
    };

    function atualizarPlacarDeEstrelas(listaRotinas) {
        let total = 0;
        const hoje = obterDataDeHoje();

        // Soma as estrelas apenas se a avalia√ß√£o foi feita HOJE
        listaRotinas.forEach(rot => {
            if (rot.data_avaliacao === hoje && typeof rot.estrelas_ganhas === 'number') {
                total += rot.estrelas_ganhas;
            }
        });

        const placarNum = document.getElementById('num-estrelas');
        const placarBox = document.getElementById('placar-estrelas');
        
        // Faz a anima√ß√£o de pulso se o n√∫mero mudar
        if(placarNum.innerText !== total.toString()) {
            placarNum.innerText = total;
            placarBox.classList.add('placar-animado');
            setTimeout(() => placarBox.classList.remove('placar-animado'), 300);
        }
    }

    // ==========================================
    // SISTEMA DE LOGIN 
    // ==========================================
    onAuthStateChanged(auth, (user) => {
        if (user) {
            id_usuario_pai = user.uid;
            if (caminho_dados && caminho_dados.includes(user.uid)) {
                iniciarApp();
            } else {
                mostrarTelaSelecaoFilho();
            }
        } else {
            document.getElementById('telaLogin').style.display = 'flex';
            document.getElementById('telaSelecionarFilho').style.display = 'none';
            document.getElementById('telaMapa').style.display = 'none';
            document.getElementById('placar-estrelas').style.display = 'none';
        }
    });

    window.fazerLogin = () => {
        const email = document.getElementById('inputEmail').value;
        const senha = document.getElementById('inputSenha').value;
        if(!email || !senha) return alert("Preencha e-mail e senha!");
        signInWithEmailAndPassword(auth, email, senha).catch(e => alert("Erro! Verifique as credenciais."));
    };

    window.sairApp = () => {
        localStorage.removeItem('caminho_dados');
        localStorage.removeItem('nome_crianca');
        signOut(auth);
    };

    function mostrarTelaSelecaoFilho() {
        document.getElementById('telaLogin').style.display = 'none';
        document.getElementById('telaMapa').style.display = 'none';
        document.getElementById('telaSelecionarFilho').style.display = 'flex';

        onSnapshot(collection(db, `usuarios/${id_usuario_pai}/filhos`), (snap) => {
            const grid = document.getElementById('grid-filhos');
            grid.innerHTML = "";
            snap.forEach(d => {
                const info = d.data();
                const pathFilho = `usuarios/${id_usuario_pai}/filhos/${d.id}`;
                grid.innerHTML += `<button class="btn-filho" onclick="selecionarCrianca('${pathFilho}', '${info.nome}')">${info.nome}</button>`;
            });
        });
    }

    window.selecionarCrianca = (caminho, nome) => {
        localStorage.setItem('caminho_dados', caminho);
        localStorage.setItem('nome_crianca', nome);
        window.location.reload(true);
    };

    function iniciarApp() {
        document.getElementById('telaLogin').style.display = 'none'; 
        document.getElementById('telaSelecionarFilho').style.display = 'none'; 
        document.getElementById('telaMapa').style.display = 'block'; 
        document.getElementById('placar-estrelas').style.display = 'flex'; // Mostra as estrelas
        document.getElementById('nome-atual').innerText = nome_crianca;
        
        const partes = caminho_dados.split('/'); 
        const pastaUsuario = `${partes[0]}/${partes[1]}`;
        const pastaIrmaos = `${partes[0]}/${partes[1]}/${partes[2]}`;

        onSnapshot(collection(db, `${pastaUsuario}/atividades`), processarCache);
        onSnapshot(collection(db, `${caminho_dados}/atividades`), processarCache);

        onSnapshot(collection(db, pastaIrmaos), (snap) => {
            const menu = document.getElementById('menu-filhos-items');
            menu.innerHTML = "";
            snap.forEach(d => { 
                const info = d.data(); 
                menu.innerHTML += `<div class="opcao-crianca" onclick="selecionarCrianca('${pastaIrmaos}/${d.id}', '${info.nome}')">${info.nome}</div>`;
            });
        });
        
        carregarRotinasDoBanco();
        setInterval(heartbeat, 30000);
        setInterval(() => desenharPista(rotinasCache), 60000);
    }

    function processarCache(snap) {
        snap.forEach(doc => {
            const data = doc.data();
            const id = doc.id.trim().toLowerCase();
            const n = (data.nome || "").trim().toLowerCase();
            const a = (data.acao || "").trim().toLowerCase();
            cacheAtividades[id] = data;
            if(n) cacheAtividades[n] = data;
            if(a) cacheAtividades[a] = data;
        });
        if(rotinasCache.length > 0) desenharPista(rotinasCache);
    }
    
    window.toggleMenu = () => { const m = document.getElementById('lista-criancas'); m.style.display = m.style.display==='block'?'none':'block'; };
    
    function converterMin(h) { let [hr, mn] = h.split(':').map(Number); if(hr < 5) hr += 24; return hr * 60 + mn; }

    function obterMinutosAtuais() {
        const agora = new Date(); let hrSys = agora.getHours(); let mnSys = agora.getMinutes();
        if(hrSys < 5) hrSys += 24; return hrSys * 60 + mnSys;
    }

    function buscarIconeAcao(acaoTexto) { return 'https://cdn-icons-png.flaticon.com/512/1048/1048953.png'; }

    const H_ROW = 240; 
    
    function calcularConfiguracaoTela() {
        const W = document.getElementById('mapa-container').clientWidth;
        let itens = 5, margem = 140; 
        if (W < 550) { itens = 2; margem = 90; }
        else if (W < 800) { itens = 3; margem = 110; }
        else if (W < 1000) { itens = 4; margem = 130; }
        return { W, ITENS_POR_LINHA: itens, MARGEM_X: margem };
    }

    function criarCaminhoInfografico(totalRotinas, conf) {
        const container = document.getElementById('mapa-container');
        if (totalRotinas === 0) return "";
        const ultimaLinhaIndex = Math.floor((totalRotinas - 1) / conf.ITENS_POR_LINHA);
        container.style.height = ((ultimaLinhaIndex * H_ROW) + 200) + "px";
        
        let d = `M ${conf.MARGEM_X},120 `;
        let y = 120;
        const stepX = (conf.W - (2 * conf.MARGEM_X)) / (conf.ITENS_POR_LINHA - 1 || 1);

        for (let i = 0; i <= ultimaLinhaIndex; i++) {
            if (i < ultimaLinhaIndex) {
                let nextX = (i % 2 === 0) ? (conf.W - conf.MARGEM_X) : conf.MARGEM_X;
                d += `L ${nextX},${y} A ${H_ROW/2} ${H_ROW/2} 0 0 ${(i % 2 === 0) ? 1 : 0} ${nextX} ${y + H_ROW} `; 
                y += H_ROW;
            } else {
                let pos = (totalRotinas - 1) % conf.ITENS_POR_LINHA;
                let endX = (i % 2 === 0) ? conf.MARGEM_X + (pos * stepX) : (conf.W - conf.MARGEM_X) - (pos * stepX);
                d += `L ${endX},${y} `;
            }
        }
        return d;
    }

    function carregarRotinasDoBanco() {
        const hoje = new Date();
        const diaSemanaAtual = hoje.getDay().toString();

        onSnapshot(query(collection(db, `${caminho_dados}/rotinas`), orderBy("hora")), (snap) => {
            const listaBruta = []; 
            snap.forEach(d => {
                let r = d.data();
                r.id = d.id; // Preciso salvar o ID do documento para poder atualizar as estrelas depois!
                listaBruta.push(r);
            });
            rotinasCache = listaBruta.filter(r => !r.dia_semana || r.dia_semana === 'todos' || r.dia_semana === diaSemanaAtual);
            rotinasCache.sort((a,b) => converterMin(a.hora) - converterMin(b.hora));
            
            atualizarPlacarDeEstrelas(rotinasCache); // Atualiza o placar l√° em cima
            desenharPista(rotinasCache);
        });
    }

    function desenharPista(lista) {
        if(lista.length === 0) return;
        const conf = calcularConfiguracaoTela();
        const dPath = criarCaminhoInfografico(lista.length, conf);
        
        document.getElementById('pathTracejado').setAttribute('d', dPath);
        const totalLen = document.getElementById('pathTracejado').getTotalLength();

        const grupoCores = document.getElementById('camada-cores'); grupoCores.innerHTML = "";
        const cores = ["#E8B87D", "#93C49D", "#80C2D6", "#86A3D4", "#B4A3D6"];
        const pedacoSize = totalLen / 5; 

        for(let i=0; i<5; i++) {
            const pathSeg = document.createElementNS("http://www.w3.org/2000/svg", "path");
            pathSeg.setAttribute('d', dPath); pathSeg.setAttribute('class', `estrada-corpo c-${i+1}`);
            pathSeg.style.strokeDasharray = `${pedacoSize + 10} ${totalLen}`; pathSeg.style.strokeDashoffset = -(i * pedacoSize);
            grupoCores.appendChild(pathSeg);
        }

        const container = document.getElementById('cards-layer'); container.innerHTML = "";
        
        const minAtual = obterMinutosAtuais();
        let indexAtual = -1;
        for(let i = 0; i < lista.length; i++) { if (minAtual >= converterMin(lista[i].hora)) indexAtual = i; }

        lista.forEach((rot, index) => {
            const linhaAtual = Math.floor(index / conf.ITENS_POR_LINHA);
            const stepX = (conf.W - (2 * conf.MARGEM_X)) / (conf.ITENS_POR_LINHA - 1 || 1);
            let xPos = (linhaAtual % 2 === 0) ? conf.MARGEM_X + ((index % conf.ITENS_POR_LINHA) * stepX) : (conf.W - conf.MARGEM_X) - ((index % conf.ITENS_POR_LINHA) * stepX);
            const corAtual = cores[Math.floor((index / lista.length) * 4.99) % 5];

            const div = document.createElement('div');
            div.className = `marcador ${(linhaAtual % 2 === 0) ? 'texto-cima' : 'texto-baixo'}`;
            div.style.left = xPos + "px"; div.style.top = (120 + (linhaAtual * H_ROW)) + "px";

            if(index < indexAtual) div.classList.add('passado');
            else if(index === indexAtual) div.classList.add('agora');

            const acaoLimpa = (rot.acao || "").trim().toLowerCase();
            const atv = cacheAtividades[acaoLimpa] || {};
            let imagemFinal = atv.imagem || rot.imagem || rot.foto || buscarIconeAcao(rot.acao);
            let acaoSegura = rot.acao.replace(/'/g, "\\'");

            // O ONCLICK AGORA ABRE A TELA DE ESTRELAS E PASSA O ID DA ROTINA!
            div.innerHTML = `
                <div class="icone-circulo" style="border-color:${corAtual}" onclick="abrirModalAvaliacao('${rot.id}', '${acaoSegura}')">
                    <img src="${imagemFinal}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1048/1048953.png'">
                </div>
                <div class="textos">
                    <span class="badge-hora" style="background:${corAtual}">${rot.hora}</span>
                    <span class="acao">${rot.acao}</span>
                </div>
            `;
            container.appendChild(div);
        });

        let lengthPassado = 0;
        if (indexAtual >= 0) {
            const compReta = conf.W - (2 * conf.MARGEM_X);
            const pedacoReta = compReta / (conf.ITENS_POR_LINHA - 1 || 1);
            lengthPassado = (Math.floor(indexAtual / conf.ITENS_POR_LINHA) * (compReta + Math.PI * (H_ROW / 2))) + ((indexAtual % conf.ITENS_POR_LINHA) * pedacoReta);
        }

        const caminhoCinza = document.getElementById('pathCinzaPassado');
        caminhoCinza.setAttribute('d', dPath);
        caminhoCinza.style.strokeDasharray = totalLen;
        caminhoCinza.style.strokeDashoffset = totalLen - lengthPassado; 
    }

    window.addEventListener('resize', () => { setTimeout(() => desenharPista(rotinasCache), 300); });
    async function heartbeat() { if(caminho_dados) setDoc(doc(db, `${caminho_dados}/dispositivos/tablet_amigo`), { nome: "Tablet", online: serverTimestamp() }, {merge:true}); }
</script>
</body>
</html>
