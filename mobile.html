<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Super Rotina App</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 80px; color: #333; -webkit-tap-highlight-color: transparent; }
        
        /* CABE√áALHO FIXO */
        .app-header { background: white; padding: 15px 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .app-logo { font-size: 18px; font-weight: 800; color: #3498db; }
        .status-pc { font-size: 12px; padding: 4px 10px; background: #eee; border-radius: 20px; color: #666; font-weight: bold; }
        .status-pc.online { background: #d4edda; color: #155724; }

        /* NAVEGA√á√ÉO INFERIOR (TABS) */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #eee; display: flex; justify-content: space-around; padding: 10px 0; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #999; font-size: 10px; cursor: pointer; flex: 1; }
        .nav-item i { font-size: 20px; margin-bottom: 3px; font-style: normal; }
        .nav-item.active { color: #3498db; font-weight: bold; }

        /* TELAS (ABAS) */
        .tab-content { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* CARDS GERAIS */
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .card-title { font-weight: bold; font-size: 16px; margin-bottom: 10px; color: #2c3e50; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; }

        /* TIMELINE (MAPA DO DIA) */
        .tl-item { display: flex; align-items: center; margin-bottom: 15px; position: relative; }
        .tl-item::before { content: ''; position: absolute; left: 24px; top: 35px; bottom: -20px; width: 2px; background: #eee; z-index: 0; }
        .tl-item:last-child::before { display: none; }
        .tl-time { background: #3498db; color: white; padding: 5px 8px; border-radius: 8px; font-size: 12px; font-weight: bold; z-index: 1; width: 40px; text-align: center; margin-right: 15px; }
        .tl-card { flex: 1; background: white; padding: 12px; border-radius: 10px; border: 1px solid #eee; display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .tl-img { width: 35px; height: 35px; border-radius: 50%; object-fit: contain; margin-right: 10px; background: #f8f9fa; }
        
        .tl-item.passado .tl-card { opacity: 0.6; background: #f9f9f9; }
        .tl-item.passado .tl-time { background: #bdc3c7; }
        .tl-item.proximo .tl-card { border: 2px solid #f39c12; }
        .tl-item.proximo .tl-time { background: #f39c12; }

        /* FORMUL√ÅRIOS MOBILE */
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 10px; box-sizing: border-box; background: #fdfdfd; }
        label { font-size: 12px; font-weight: bold; color: #7f8c8d; text-transform: uppercase; margin-bottom: 5px; display: block; }
        
        .btn-main { background: #3498db; color: white; border: none; padding: 15px; border-radius: 10px; width: 100%; font-size: 16px; font-weight: bold; margin-top: 10px; }
        .btn-sec { background: #ecf0f1; color: #333; border: none; padding: 15px; border-radius: 10px; width: 100%; font-size: 16px; font-weight: bold; margin-top: 10px; }

        /* LISTA ATIVIDADES */
        .atv-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .atv-info { display: flex; align-items: center; }
        .atv-img { width: 40px; height: 40px; border-radius: 8px; background: #eee; margin-right: 10px; object-fit: contain; }

        /* ACTIONS GRID */
        .actions-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .action-btn { background: white; border: 1px solid #eee; border-radius: 10px; padding: 15px 5px; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 80px; }
        .action-btn:active { background: #f0f0f0; transform: scale(0.98); }
        .action-btn img { width: 30px; height: 30px; margin-bottom: 5px; }
        .action-btn span { font-size: 10px; font-weight: bold; color: #555; }

        /* LOGIN */
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; padding: 30px; box-sizing: border-box; display: flex; flex-direction: column; justify-content: center; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="loginScreen" class="login-overlay">
        <h1 style="color:#3498db; text-align:center; margin-bottom:10px">Super Rotina</h1>
        <p style="text-align:center; color:#777; margin-bottom:40px">Controle Parental</p>
        <input type="email" id="email" placeholder="E-mail">
        <input type="password" id="senha" placeholder="Senha">
        <button class="btn-main" onclick="fazerLogin()">Entrar</button>
        <div style="text-align:center; margin-top:20px; font-size:14px; color:#999">Use a mesma conta do PC</div>
    </div>

    <div class="app-header">
        <div class="app-logo">üíô <span id="nomeFilhoHeader">Carregando...</span></div>
        <div id="statusPcBadge" class="status-pc">PC Offline</div>
    </div>

    <div id="tab-home" class="tab-content active">
        
        <div class="card">
            <div class="card-title">üéÆ Controle R√°pido</div>
            <div class="actions-grid" id="gridAcoesRapidas">
                </div>
            <button onclick="enviarAcao('livre')" style="background:#e74c3c; color:white; width:100%; padding:10px; border:none; border-radius:8px; margin-top:10px; font-weight:bold;">‚õî PARAR TUDO</button>
        </div>

        <div class="card">
            <div class="card-title">üìÖ Rotina de Hoje</div>
            <div id="timelineContainer">
                <div style="text-align:center; padding:20px; color:#999">Carregando...</div>
            </div>
        </div>
    </div>

    <div id="tab-editor" class="tab-content">
        <div class="card">
            <div class="card-title">üé® Nova Atividade</div>
            <input type="hidden" id="editIdAtividade">
            <label>ID (Nome Curto)</label>
            <input type="text" id="idAtividade" placeholder="Ex: banho">
            
            <div style="display:flex; gap:10px">
                <div style="flex:1"><label>Tempo (s)</label><input type="number" id="tempoAtividade" placeholder="15"></div>
                <div style="flex:1"><label>Falar?</label><select id="comboFalar"><option value="sim">Sim</option><option value="nao">N√£o</option></select></div>
            </div>

            <label>Texto do Bal√£o</label>
            <input type="text" id="txtAtividade">
            
            <label>Imagem (URL)</label>
            <input type="text" id="imgAtividade" placeholder="http://...">

            <button class="btn-main" onclick="salvarAtividade()">üíæ Salvar</button>
            <button class="btn-sec" onclick="limparForm()">Cancelar</button>
        </div>

        <div class="card">
            <div class="card-title">‚úèÔ∏è Atividades Salvas</div>
            <div id="listaAtividades"></div>
        </div>
    </div>

    <div id="tab-agenda" class="tab-content">
        <div class="card">
            <div class="card-title">‚è∞ Agendar Hor√°rio</div>
            <input type="hidden" id="editIdRotina">
            <label>Hor√°rio</label>
            <input type="time" id="horaRotina">
            
            <label>Dia da Semana</label>
            <select id="diaRotina">
                <option value="todos">Todos os dias</option>
                <option value="1">Segunda</option><option value="2">Ter√ßa</option><option value="3">Quarta</option>
                <option value="4">Quinta</option><option value="5">Sexta</option><option value="6">S√°bado</option><option value="0">Domingo</option>
            </select>

            <label>Atividade</label>
            <select id="selectAtividadeRotina"></select>

            <button class="btn-main" onclick="salvarRotina()">Confirmar Agendamento</button>
        </div>

        <div class="card">
            <div class="card-title">üóìÔ∏è Lista da Semana</div>
            <div id="listaRotinasCompletas"></div>
        </div>
    </div>

    <div id="tab-perfil" class="tab-content">
        <div class="card">
            <div class="card-title">‚öôÔ∏è Configura√ß√µes</div>
            <label>Filho Selecionado</label>
            <select id="selectFilho" onchange="mudarFilho()"></select>
            <button class="btn-main" onclick="novoFilho()" style="background:#2ecc71; margin-bottom:15px">+ Adicionar Filho</button>
            
            <div style="background:#fffbe6; padding:15px; border-radius:8px; border:1px solid #ffe58f; text-align:center; margin-bottom:15px">
                <small>C√ìDIGO DE PAREAMENTO DO PC</small><br>
                <strong style="font-size:24px; letter-spacing:3px" id="displayCodigo">---</strong>
            </div>

            <button class="btn-sec" onclick="sair()" style="color:#e74c3c">Sair da Conta</button>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="mudarTab('home', this)">
            <i>üè†</i>In√≠cio
        </div>
        <div class="nav-item" onclick="mudarTab('editor', this)">
            <i>üé®</i>Criar
        </div>
        <div class="nav-item" onclick="mudarTab('agenda', this)">
            <i>üìÖ</i>Agenda
        </div>
        <div class="nav-item" onclick="mudarTab('perfil', this)">
            <i>‚öôÔ∏è</i>Perfil
        </div>
    </div>

 <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot, deleteDoc, updateDoc, query } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyAh3J8bp7xvNGct8k4TfAoCcIpVRoWjBYI", authDomain: "rotinaeduardo.firebaseapp.com", projectId: "rotinaeduardo", storageBucket: "rotinaeduardo.firebasestorage.app", messagingSenderId: "210945268922", appId: "1:210945268922:web:ce9e585872090b378d7683", measurementId: "G-MDYWRH9RNP" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app);
        let usuarioAtual, filhoAtualId, cacheAtividades={}, cacheRotinas={};

        // UI TABS
        window.mudarTab = (tabName, el) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-'+tabName).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        };

        // LOGIN
        window.fazerLogin = async () => { 
            try { 
                await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('senha').value); 
            } catch(e){ alert("Erro: " + e.message); } 
        };
        window.sair = () => signOut(auth);

        onAuthStateChanged(auth, (u) => { 
            if(u) { 
                usuarioAtual=u; 
                document.getElementById('loginScreen').classList.add('hidden'); 
                carregarFilhos(); 
            } else { 
                document.getElementById('loginScreen').classList.remove('hidden'); 
            } 
        });

        // DADOS
        function carregarFilhos() {
            const sel = document.getElementById('selectFilho');
            onSnapshot(collection(db, `usuarios/${usuarioAtual.uid}/filhos`), (s) => {
                sel.innerHTML = ""; let tem = false;
                s.forEach(d => { tem=true; let o = document.createElement('option'); o.value=d.id; o.innerText=d.data().nome; sel.appendChild(o); });
                if(!tem) { window.novoFilho(); } 
                else {
                    // Mant√©m o selecionado ou pega o primeiro
                    if(filhoAtualId && sel.querySelector(`option[value="${filhoAtualId}"]`)) {
                        sel.value = filhoAtualId;
                    } else {
                        sel.value = sel.options[0].value;
                        filhoAtualId = sel.value;
                    }
                    
                    // Atualiza o nome no topo ao carregar
                    const nome = sel.options[sel.selectedIndex].text;
                    document.getElementById('nomeFilhoHeader').innerText = nome;
                    
                    carregarDados();
                }
            });
        }

        window.novoFilho = async () => {
            const n = prompt("Nome:"); if(!n) return;
            const c = Math.random().toString(36).substring(2,8).toUpperCase();
            const r = await addDoc(collection(db, `usuarios/${usuarioAtual.uid}/filhos`), { nome: n, codigo_pareamento: c });
            await setDoc(doc(db, "conexoes", c), { caminho_dados: `usuarios/${usuarioAtual.uid}/filhos/${r.id}` });
        };

        // --- FUN√á√ÉO CORRIGIDA AQUI ---
        window.mudarFilho = () => { 
            const sel = document.getElementById('selectFilho');
            filhoAtualId = sel.value; 
            
            // PEGA O TEXTO DO SELECT E JOGA NO CABE√áALHO
            const nome = sel.options[sel.selectedIndex].text;
            document.getElementById('nomeFilhoHeader').innerText = nome;

            carregarDados(); 
        };

        function carregarDados() {
            if(!filhoAtualId) return;
            const base = `usuarios/${usuarioAtual.uid}/filhos/${filhoAtualId}`;
            
            // C√≥digo e Status PC
            getDoc(doc(db, base)).then(d => { if(d.exists()) document.getElementById('displayCodigo').innerText = d.data().codigo_pareamento; });
            
            // Monitora status PC (Dispositivos)
            onSnapshot(collection(db, `${base}/dispositivos`), (snap) => {
                const badge = document.getElementById('statusPcBadge');
                let onlineCount = 0;
                snap.forEach(d => { if(new Date() - d.data().online.toDate() < 120000) onlineCount++; });
                if(onlineCount > 0) { badge.innerText = "PC Online üü¢"; badge.classList.add('online'); }
                else { badge.innerText = "PC Offline ‚ö´"; badge.classList.remove('online'); }
            });

            // Atividades
            onSnapshot(collection(db, `${base}/atividades`), (snap) => {
                const lista = document.getElementById('listaAtividades');
                const grid = document.getElementById('gridAcoesRapidas');
                const select = document.getElementById('selectAtividadeRotina');
                lista.innerHTML=""; grid.innerHTML=""; select.innerHTML=""; cacheAtividades={};

                snap.forEach(d => {
                    const dd = d.data(); cacheAtividades[d.id] = dd;
                    // Lista Editor
                    lista.innerHTML += `
                    <div class="atv-item">
                        <div class="atv-info"><img src="${dd.imagem}" class="atv-img" onerror="this.style.display='none'"> <b>${d.id}</b></div>
                        <div><button style="padding:5px 10px" onclick="editarAtv('${d.id}')">‚úèÔ∏è</button> <button style="padding:5px 10px; background:#e74c3c; color:white; border:none; border-radius:4px" onclick="apagarAtv('${d.id}')">X</button></div>
                    </div>`;
                    // Grid Home
                    grid.innerHTML += `<div class="action-btn" onclick="enviarAcao('${d.id}')"><img src="${dd.imagem}" onerror="this.style.display='none'"><span>${d.id}</span></div>`;
                    // Select
                    let opt = document.createElement('option'); opt.value=d.id; opt.innerText=d.id; select.appendChild(opt);
                });
                renderizarTimeline();
            });

            // Rotinas
            onSnapshot(collection(db, `${base}/rotinas`), (snap) => {
                const listaFull = document.getElementById('listaRotinasCompletas');
                listaFull.innerHTML = ""; cacheRotinas = {};
                
                let tempRotinas = [];
                snap.forEach(d => tempRotinas.push({id:d.id, ...d.data()}));
                tempRotinas.sort((a,b) => a.hora.localeCompare(b.hora));

                tempRotinas.forEach(r => {
                    cacheRotinas[r.id] = r;
                    const diasMap = {'todos':'Todos','1':'Seg','2':'Ter','3':'Qua','4':'Qui','5':'Sex','6':'S√°b','0':'Dom'};
                    listaFull.innerHTML += `
                    <div style="background:#fff; padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between">
                        <div><b style="color:#3498db">${r.hora}</b> - ${r.acao} <span style="font-size:10px; background:#eee; padding:2px 5px; border-radius:4px">${diasMap[r.dia_semana]}</span></div>
                        <button style="color:red; background:none; border:none" onclick="apagarRotina('${r.id}')">üóëÔ∏è</button>
                    </div>`;
                });
                renderizarTimeline(tempRotinas);
            });
        }

        function renderizarTimeline(rotinasOpcional) {
            const container = document.getElementById('timelineContainer');
            container.innerHTML = "";
            
            // Usa as rotinas passadas ou as do cache
            let rotinas = rotinasOpcional || Object.values(cacheRotinas);
            if(rotinas.length === 0) { container.innerHTML = "<div style='text-align:center; padding:20px; color:#ccc'>Sem rotinas hoje</div>"; return; }

            const hoje = new Date();
            const diaSemana = hoje.getDay().toString();
            const horaAtual = hoje.getHours() * 60 + hoje.getMinutes();

            // Filtra e Ordena
            let hojeRotinas = rotinas.filter(r => r.dia_semana === 'todos' || r.dia_semana === diaSemana);
            hojeRotinas.sort((a,b) => a.hora.localeCompare(b.hora));

            let proximoMarked = false;

            hojeRotinas.forEach(r => {
                const [h, m] = r.hora.split(':').map(Number);
                const minutos = h * 60 + m;
                let classe = "futuro";
                
                if(minutos < horaAtual) classe = "passado";
                else if(!proximoMarked) { classe = "proximo"; proximoMarked = true; }

                const img = cacheAtividades[r.acao] ? cacheAtividades[r.acao].imagem : '';
                
                container.innerHTML += `
                <div class="tl-item ${classe}">
                    <div class="tl-time">${r.hora}</div>
                    <div class="tl-card">
                        <img src="${img}" class="tl-img" onerror="this.style.display='none'">
                        <div><b>${r.acao}</b></div>
                    </div>
                </div>`;
            });
        }

        // A√á√ïES
        window.salvarAtividade = async () => {
            const idInput = document.getElementById('idAtividade');
            const editId = document.getElementById('editIdAtividade').value;
            let idFinal = editId ? editId : idInput.value.toLowerCase().replace(/\s/g,'');
            
            if(!idFinal) return alert("ID Obrigat√≥rio");
            
            await setDoc(doc(db, `usuarios/${usuarioAtual.uid}/filhos/${filhoAtualId}/atividades`, idFinal), {
                texto: document.getElementById('txtAtividade').value,
                imagem: document.getElementById('imgAtividade').value,
                tempo_personalizado: document.getElementById('tempoAtividade').value,
                falar_texto: document.getElementById('comboFalar').value === 'sim',
                dispositivos_alvo: ['todos'] // Padr√£o mobile
            });
            limparForm();
            mudarTab('home', document.querySelector('.bottom-nav .nav-item:first-child')); 
        };

        window.salvarRotina = async () => {
            const hora = document.getElementById('horaRotina').value;
            if(!hora) return alert("Hora obrigat√≥ria");
            await addDoc(collection(db, `usuarios/${usuarioAtual.uid}/filhos/${filhoAtualId}/rotinas`), {
                hora: hora, dia_semana: document.getElementById('diaRotina').value, acao: document.getElementById('selectAtividadeRotina').value
            });
            document.getElementById('horaRotina').value = "";
            alert("Agendado!");
        };

        // FUN√á√ÉO DE ENVIAR COMANDO (SEM ALERTA)
        window.enviarAcao = async (acao) => {
            // Vibra o celular rapidinho para dar um "tato" de que funcionou (se o navegador permitir)
            if (navigator.vibrate) navigator.vibrate(50); 

            await setDoc(doc(db, `usuarios/${usuarioAtual.uid}/filhos/${filhoAtualId}/config/estado_atual`), { acao, timestamp: new Date() }, {merge:true});
            
            // REMOVI O ALERT ABAIXO:
            // alert("Enviado para o PC!"); 
        };

        window.editarAtv = (id) => {
            const d = cacheAtividades[id];
            document.getElementById('idAtividade').value = id;
            document.getElementById('idAtividade').disabled = true; // Trava ID na edi√ß√£o
            document.getElementById('editIdAtividade').value = id;
            
            document.getElementById('txtAtividade').value = d.texto || "";
            document.getElementById('imgAtividade').value = d.imagem || "";
            document.getElementById('tempoAtividade').value = d.tempo_personalizado || "";
            document.getElementById('comboFalar').value = (d.falar_texto === false) ? 'nao' : 'sim';
            
            mudarTab('editor', document.querySelectorAll('.bottom-nav .nav-item')[1]);
        };

        window.limparForm = () => {
            document.getElementById('idAtividade').disabled = false;
            document.getElementById('idAtividade').value = "";
            document.getElementById('editIdAtividade').value = "";
            document.getElementById('txtAtividade').value = "";
            document.getElementById('imgAtividade').value = "";
        };

        window.apagarAtv = async (id) => { if(confirm("Apagar?")) deleteDoc(doc(db, `usuarios/${usuarioAtual.uid}/filhos/${filhoAtualId}/atividades`, id)); };
        window.apagarRotina = async (id) => { if(confirm("Apagar?")) deleteDoc(doc(db, `usuarios/${usuarioAtual.uid}/filhos/${filhoAtualId}/rotinas`, id)); };

    </script>
</body>
</html>