<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#3498db">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes"> 
    <title>Amigo Virtual</title>
    <link rel="icon" type="image/x-icon" href="icon.ico">

<link rel="apple-touch-icon" href="icon.ico">
    <style>
        /* --- ESTILOS GERAIS --- */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: #f4f7f6; margin: 0; padding-bottom: 90px; color: #333; 
            -webkit-tap-highlight-color: transparent;
        }

        /* --- TELAS E HEADER --- */
        .tela { display: none; padding: 15px; padding-top: 70px; animation: fadeIn 0.4s; }
        .tela.ativa { display: block; }
        .tela-login { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .app-header { position: fixed; top: 0; left: 0; width: 100%; height: 60px; background: white; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-sizing: border-box; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .grupo-filho { display: flex; align-items: center; gap: 5px; }
        .grupo-filho select { margin: 0; border: none; background: #f0f2f5; font-weight: bold; font-size: 15px; width: auto; padding: 8px 12px; border-radius: 20px; color: #2c3e50; }
        .btn-round { width: 32px; height: 32px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; color: white; margin: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* --- MENU INFERIOR --- */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; background: white; border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; z-index: 1000; box-shadow: 0 -5px 15px rgba(0,0,0,0.03); padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #bdc3c7; font-size: 10px; font-weight: 600; background: none; border: none; cursor: pointer; padding: 5px; transition: 0.2s; }
        .nav-item span { font-size: 24px; margin-bottom: 3px; }
        .nav-item.ativo { color: #3498db; transform: scale(1.1); }

        /* --- CARDS E INPUTS --- */
        .card { background: white; padding: 18px; border-radius: 20px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.04); }
        h2 { margin-top: 0; font-size: 16px; border-bottom: 1px solid #f5f5f5; padding-bottom: 10px; color: #2c3e50; font-weight: 800; display: flex; justify-content: space-between; align-items: center; }
        input, select { width: 100%; padding: 12px; border: 1px solid #e1e1e1; border-radius: 12px; box-sizing: border-box; font-size: 14px; background: #fbfbfb; margin-bottom: 10px; }
        label { display: block; font-size: 10px; font-weight: bold; color: #95a5a6; text-transform: uppercase; margin-bottom: 5px; letter-spacing: 0.5px; }
        button.btn-block { border: none; border-radius: 12px; padding: 14px; font-weight: bold; width: 100%; cursor: pointer; font-size: 14px; margin-bottom: 5px; transition: 0.2s; }
        button:active { transform: scale(0.96); }
        .btn-blue { background: #3498db; color: white; } .btn-green { background: #2ecc71; color: white; } .btn-red { background: #e74c3c; color: white; }
        .btn-acao-icone { background: transparent; border: none; cursor: pointer; font-size: 18px; padding: 5px 10px; margin: 0; transition: transform 0.2s; }
        .btn-acao-icone:active { transform: scale(1.2); }

        /* --- AGENDA (CARROSSEL) --- */
        .calendario-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 10px; display: flex; gap: 15px; }
        .dia-coluna { min-width: 280px; max-width: 350px; background: white; border: 1px solid #eee; border-radius: 16px; padding: 0; flex-shrink: 0; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .dia-header { background: #3498db; color: white; text-align: center; padding: 10px; font-weight: bold; font-size: 14px; letter-spacing: 1px; }
        .lista-rotinas { padding: 10px; min-height: 100px; background: #fdfdfd; }
        .card-rotina { background: white; border: 1px solid #eee; padding: 8px 10px; margin-bottom: 8px; border-radius: 10px; font-size: 13px; display: flex; align-items: center; gap: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .hora-tag { background: #eaf2f8; color: #2980b9; padding: 5px 8px; border-radius: 8px; font-weight: bold; font-size: 12px; flex-shrink: 0; }
        .rotina-img { width: 35px; height: 35px; object-fit: contain; background: #f9f9f9; border-radius: 6px; flex-shrink: 0; }
        .rotina-texto { flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 600; color: #444; font-size: 14px; }
        .acoes-rotina { display: flex; align-items: center; flex-shrink: 0; }

        /* --- HIST√ìRICO E MONITORAMENTO --- */
        .grafico-container { display: flex; align-items: flex-end; height: 140px; padding-top: 25px; overflow-x: auto; justify-content: flex-start; gap: 15px; }
        .barra-wrapper { display: flex; flex-direction: column; align-items: center; min-width: 30px; position: relative; }
        .barra { width: 18px; background: linear-gradient(to top, #3498db, #5dade2); border-radius: 6px 6px 0 0; }
        .barra-valor { position: absolute; top: -20px; font-size: 10px; font-weight: bold; width: 100%; text-align: center; color: #555; }
        .barra-dia { font-size: 10px; color: #888; margin-top: 6px; font-weight: 500; }
        .resumo-mes { background: #fdfefe; border: 1px solid #e1f5fe; color: #0277bd; padding: 10px; border-radius: 10px; text-align: center; font-size: 13px; margin-bottom: 15px; font-weight: bold; }
        .pc-status-card { display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #eee; }
        .pc-badge { padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: bold; letter-spacing: 0.5px; }
        .badge-online { background: #d4edda; color: #155724; } .badge-offline { background: #e2e3e5; color: #666; }

        /* --- NOVO ESTILO VISUAL TIMELINE (MAPA DO DIA) --- */
        .timeline-box { padding: 10px 0; }
        /* Flex container para cada item da linha do tempo */
        .tl-item { display: flex; align-items: stretch; margin-bottom: 0; position: relative; }
        
        /* Coluna da Hora (Esquerda) */
        .tl-time-col { width: 50px; text-align: right; padding-right: 12px; padding-top: 18px; font-weight: bold; color: #95a5a6; font-size: 12px; }
        
        /* Coluna da Linha Central e Bolinha */
        .tl-line-col { width: 24px; position: relative; display: flex; justify-content: center; }
        /* A linha vertical cont√≠nua */
        .tl-line-col::before { content: ''; position: absolute; top: 0; bottom: 0; width: 2px; background: #e0e0e0; z-index: 0; }
        /* A bolinha indicadora */
        .tl-dot { width: 14px; height: 14px; border-radius: 50%; background: #3498db; border: 3px solid white; z-index: 1; margin-top: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.3s ease; }

        /* Coluna do Cart√£o de Conte√∫do (Direita) */
        .tl-card { flex: 1; background: white; border-radius: 12px; padding: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); border: 1px solid #eee; display: flex; align-items: center; margin-bottom: 15px; transition: all 0.3s ease; }
        .tl-card img { width: 45px; height: 45px; object-fit: contain; margin-right: 12px; border-radius: 8px; background: #f9f9f9; }
        .tl-card b { font-size: 14px; color: #2c3e50; }

        /* Estilos para Passado e Futuro */
        .tl-item.passado .tl-dot { background: #bdc3c7; } /* Bolinha cinza */
        .tl-item.passado .tl-card { opacity: 0.7; background: #f9f9f9; } /* Card mais apagado */
        
        .tl-item.proximo .tl-dot { background: #f39c12; box-shadow: 0 0 0 4px rgba(243, 156, 18, 0.2); transform: scale(1.1); } /* Bolinha laranja pulsante */
        .tl-item.proximo .tl-card { border: 2px solid #f39c12; background: #fffcf5; box-shadow: 0 4px 12px rgba(243, 156, 18, 0.15); } /* Card destacado */
        
        /* --- OUTROS --- */
        .galeria-v { display: flex; gap: 10px; overflow-x: auto; background: #fff; padding: 10px; border-radius: 12px; border: 1px solid #eee; margin-bottom: 10px; min-height: 80px; }
        .img-sel { width: 65px; height: 65px; object-fit: contain; background: white; border-radius: 10px; border: 2px solid transparent; flex-shrink: 0; display: none; padding: 2px; }
        .img-sel.visivel { display: block; } .img-sel.ativa { border-color: #2ecc71; background: #eafaf1; }
        .grid-acoes { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .btn-acao { background: white; border: 1px solid #f0f0f0; border-radius: 15px; padding: 10px; text-align: center; display: flex; flex-direction: column; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .btn-acao img { width: 40px; height: 40px; object-fit: contain; margin-bottom: 5px; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; } .switch input { opacity: 0; width: 0; height: 0; } .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; } .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; } input:checked + .slider { background-color: #2ecc71; } input:checked + .slider:before { transform: translateX(20px); }
        .item-lista { display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid #f5f5f5; }
   /* --- ESTILO DA NOTIFICA√á√ÉO (TOAST) --- */
        #toast-aviso {
            visibility: hidden;
            min-width: 250px;
            background-color: white;
            color: #93C49D; /* Verde do seu tema */
            text-align: center;
            border: 2px solid #93C49D;
            border-radius: 30px;
            padding: 15px 20px;
            position: fixed;
            z-index: 99999;
            left: 50%;
            top: 20px; /* Come√ßa l√° embaixo */
            transform: translateX(-50%);
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(147, 196, 157, 0.3);
            opacity: 0;
            transition: opacity 0.4s, bottom 0.4s;
        }

        /* Classe que o Javascript vai adicionar para fazer ele aparecer e subir */
        #toast-aviso.mostrar {
            visibility: visible;
            opacity: 1;
            top: 50px; /* Sobe um pouquinho na anima√ß√£o */
        }
        .container-esqueci-senha {
    text-align: center;
    margin-top: 15px;
    margin-bottom: 20px;
}

.link-esqueci-senha {
    color: #7f8c8d; /* Cinza elegante */
    font-size: 14px;
    text-decoration: none;
    transition: all 0.3s ease;
    font-weight: 500;
    cursor: pointer;
}

.link-esqueci-senha:hover {
    color: #2ECC71; /* Fica da cor do seu tema ao passar o mouse */
    text-decoration: underline;
}

   </style>
</head>
<body>
<div id="toast-aviso">ü§ñ A√ß√£o enviada para o dispositivo!</div>

        <div id="telaLogin" class="tela-login" style="display:flex;">
        <div style="width: 80%; max-width: 300px; text-align: center;">
            <h1 style="color:#3498db; margin-bottom: 30px;">üîê Amigo Virtual</h1>
            <input type="email" id="emailInput" placeholder="Digite seu e-mail">
            <div style="position: relative; width: 100%;  display: block; margin-bottom: 15px;">
             <input type="password" id="senhaInput" placeholder="Digite sua senha" style="width: 100%; box-sizing: border-box; padding-right: 45px;">
             <button type="button" id="btnOlhinho" onclick="toggleSenha()" style=" position: absolute; right: 5%; top: 35%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 18px; padding: 0; outline: none; z-index: 10;">üëÅÔ∏è</button>
           </div>
            <div class="container-esqueci-senha">
              <a href="#" id="btnEsqueciSenha" class="link-esqueci-senha">ü§î Esqueceu a senha? Clique aqui</a>
           </div>
            <button class="btn-blue" onclick="fazerLogin()">Entrar</button>
            <button class="btn-green" onclick="criarConta()" style="margin-top:10px">Criar Nova Conta</button>
        </div>
    </div>

    
    <div id="appHeader" class="app-header" style="display:none;">
        <div class="grupo-filho">
            <select id="selectFilho" onchange="mudarFilho()"></select>
            <button onclick="novoFilho()" class="btn-round btn-green" title="Adicionar">+</button>
            <button onclick="excluirFilho()" class="btn-round btn-red" title="Excluir Perfil">üóëÔ∏è</button>
        </div>
        <div>
            <span id="displayCodigo" style="background:#fff8e1; padding:5px 10px; border-radius:12px; font-size:11px; color:#f1c40f; font-weight:bold; letter-spacing:1px">...</span>
            <button onclick="sair()" style="background:none; border:none; font-size:12px; color:#e74c3c; font-weight:bold; margin-left:5px;">SAIR</button>
        </div>
    </div>

    <div id="mainContent" style="display:none;">
        
        <div id="tab-home" class="tela ativa">
            <div class="card">
                <h2>üñ•Ô∏è Status do Computador</h2>
                <div id="painelMonitoramento"></div>
                <div id="listaDispositivos" style="display:none;"></div>
            </div>
            <div class="card">
                <h2>üìä Hist√≥rico de Uso</h2>
                <div id="resumoMensal" class="resumo-mes">Carregando total...</div>
                <div id="graficoHistorico" class="grafico-container"></div>
            </div>
            <div class="card">
                <h2>üó∫Ô∏è Roteiro de Hoje</h2>
                <div id="timelineInteligente" class="timeline-box"><p style="text-align:center; color:#999; padding:10px">Carregando...</p></div>
            </div>
        </div>

        <div id="tab-criar" class="tela">
            <div class="card">
                <h2>üé® Criar Atividade</h2>
                <input type="hidden" id="editIdAtividade">
                <div style="display:flex; gap:10px">
                    <div style="flex:2"><label>Nome (ID)</label><input type="text" id="idAtividade" placeholder="ex: banho"></div>
                    <div style="flex:1"><label>Tempo(s)</label><input type="number" id="tempoAtividade" placeholder="15"></div>
                </div>
                <input type="text" id="txtAtividade" placeholder="Texto que aparece na tela">
                
                <div style="background:#f9f9f9; padding:12px; border-radius:15px; border:1px solid #eee; margin-bottom:15px">
                    <label style="margin-bottom:10px">üñºÔ∏è Escolha a Imagem</label>
                    <div id="galVisual" class="galeria-v"></div>
                    <input type="text" id="imgAtividade" oninput="atualizarPreview()" placeholder="IMG/1.gif" style="margin-top:5px">
                    
                    <div style="display:flex; flex-direction:column; align-items:center; gap:10px; margin-top:15px; border-top:1px dashed #ddd; padding-top:15px;">
                        <div style="width:100%">
                            <label>Tamanho: <span id="labelTamanho" style="color:#3498db">150px</span></label>
                            <input type="range" id="rangeTamanho" min="50" max="300" value="150" oninput="atualizarPreview()" style="width:100%">
                        </div>
                        <div style="width:100%; min-height:160px; display:flex; align-items:center; justify-content:center; border:1px dashed #ccc; background:white; border-radius:12px; padding:10px;">
                            <img id="previewAvatar" src="" style="width:150px; transition: width 0.2s ease;">
                        </div>
                    </div>
                </div>

                <div style="background:#fff; border:1px solid #eee; padding:12px; border-radius:15px; margin-bottom:15px">
                    <label style="color:#3498db; margin-bottom:10px; display:block">üïí Antecipa√ß√£o (Avisos)</label>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:8px">
                        <div><label>Texto 5 min</label><input type="text" id="txt5min"></div>
                        <div><label>Img 5 min</label><input type="text" id="img5min" placeholder="IMG/..."></div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                        <div><label>Texto 3 min</label><input type="text" id="txt3min"></div>
                        <div><label>Img 3 min</label><input type="text" id="img3min" placeholder="IMG/..."></div>
                    </div>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; background:#f9f9f9; padding:10px; border-radius:10px; flex-wrap:wrap; gap:10px;">
    <div style="font-size:12px; font-weight:bold; color:#555">Ler Voz? <label class="switch" style="vertical-align:middle; margin-left:5px"><input type="checkbox" id="checkVoz" checked><span class="slider"></span></label></div>
    
    <div style="font-size:12px; font-weight:bold; color:#555">Voz: 
        <select id="generoVoz" style="padding:4px; border-radius:6px; border:1px solid #ddd; margin-left:5px;">
            <option value="M">üë¶ Menino</option>
            <option value="F">üëß Menina</option>
        </select>
    </div>

    <div style="font-size:12px; font-weight:bold; color:#555">Bloquear? <label class="switch" style="vertical-align:middle; margin-left:5px"><input type="checkbox" id="checkBlock"><span class="slider"></span></label></div>
</div>

                <label>Posi√ß√£o na Tela</label>
                <select id="posAtividade">
                    <option value="center">‚è∫ Centro (Padr√£o)</option>
                    <option value="top-left">‚Üñ Topo Esquerda</option>
                    <option value="top-center">‚¨Ü Topo Centro</option>
                    <option value="top-right">‚Üó Topo Direita</option>
                    <option value="bottom-left">‚Üô Baixo Esquerda</option>
                    <option value="bottom-center">‚¨á Baixo Centro</option>
                    <option value="bottom-right">‚Üò Baixo Direita</option>
                </select>

                <div style="display:flex; gap:10px">
                    <button class="btn-block btn-blue" onclick="salvarAtividade()">üíæ SALVAR</button>
                    <button class="btn-block" style="background:#bdc3c7; color:white;" onclick="limparFormAtividade()">LIMPAR</button>
                </div>
            </div>

            <div class="card">
                <h3>Atividades Salvas</h3>
                <ul id="listaAtividades" style="padding:0; list-style:none; max-height:400px; overflow-y:auto"></ul>
            </div>
        </div>

        <div id="tab-agenda" class="tela">
            <div class="card">
                <h2>üìÖ Agendar</h2>
                <input type="hidden" id="editIdRotina">
                <div style="display:flex; gap:10px; margin-bottom:10px">
                    <div style="flex:1"><label>Hora</label><input type="time" id="horaRotina"></div>
                    <div style="flex:1"><label>Dia</label><select id="diaRotina"><option value="todos">Todos</option><option value="1">Seg</option><option value="2">Ter</option><option value="3">Qua</option><option value="4">Qui</option><option value="5">Sex</option><option value="6">S√°b</option><option value="0">Dom</option></select></div>
                </div>
                <div style="display:flex; gap:10px;">
                    <select id="selectAtividadeRotina" style="flex:2"></select>
                    <button class="btn-block btn-green" style="width:auto; padding:0 25px; margin:0" onclick="salvarRotina()">OK</button>
                </div>
            </div>
            
            <div class="card" style="background:transparent; box-shadow:none; padding:0; border:none">
                <h2 style="margin-bottom:10px; padding-left:10px">Semana (Arraste para o lado)</h2>
                <div class="calendario-wrapper">
                    <div id="calendarioContainer" style="display:flex; gap:15px; padding:0 5px;"></div>
                </div>
            </div>
        </div>

        <div id="tab-controle" class="tela">
            <div class="card">
                <h2>üéÆ A√ß√µes R√°pidas</h2>
                <div id="gridAcoes" class="grid-acoes"></div>
            </div>
            <div class="card">
                <h2>Comandos Imediatos</h2>
                <div style="display:flex; gap:10px">
                    <button onclick="enviarAcao('livre')" class="btn-block" style="background:#95a5a6; color:white">üîì LIBERAR TELA</button>
                    <button onclick="enviarAcao('bloqueio')" class="btn-block btn-red">üîí BLOQUEAR TELA</button>
                </div>
            </div>
        </div>
    </div>

    <div id="bottomNav" class="bottom-nav" style="display:none;">
        <button class="nav-item ativo" onclick="mudarAba('home')"><span>üè†</span>In√≠cio</button>
        <button class="nav-item" onclick="mudarAba('criar')"><span>üé®</span>Criar</button>
        <button class="nav-item" onclick="mudarAba('agenda')"><span>üìÖ</span>Agenda</button>
        <button class="nav-item" onclick="mudarAba('controle')"><span>üéÆ</span>Controle</button>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot, deleteDoc, updateDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, sendPasswordResetEmail, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyAh3J8bp7xvNGct8k4TfAoCcIpVRoWjBYI", authDomain: "rotinaeduardo.firebaseapp.com", projectId: "rotinaeduardo", storageBucket: "rotinaeduardo.firebasestorage.app", messagingSenderId: "210945268922", appId: "1:210945268922:web:ce9e585872090b378d7683", measurementId: "G-MDYWRH9RNP" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app);
        let usuarioAtual, filhoAtualId, cacheAtividades={}, cacheRotinas={}, unsubs = [];
        window.mudarAba = (aba) => {
            document.querySelectorAll('.tela').forEach(t => t.classList.remove('ativa'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('ativo'));
            document.getElementById(`tab-${aba}`).classList.add('ativa');
            const btnIndex = { 'home':0, 'criar':1, 'agenda':2, 'controle':3 };
            document.querySelectorAll('.nav-item')[btnIndex[aba]].classList.add('ativo');
        };

     function montarGaleriaInfinita() {
    const container = document.getElementById('galVisual');
    if(!container) return; 
    container.innerHTML = "";
    
    // Lista de nomes base
    const nomes = ["ARRUMANDO_CAMA", "BANHO", "BOCEJANDO", "COMER", "DESLIGAR-PC", "LIGAR-PC", "ESCOVANDO_DENTES"];
    // Adiciona n√∫meros de 1 a 50
    for(let i=1; i<=50; i++) nomes.push(`${i}`); 

    nomes.forEach(nomeBase => {
        // Tenta todas as extens√µes poss√≠veis
        [".gif", ".png", ".jpg", ".GIF", ".PNG", ".JPG"].forEach(ext => {
            
            const nomeArq = nomeBase.includes('.') ? nomeBase : nomeBase + ext;
            const img = new Image();
            img.src = `IMG/${nomeArq}`; // Ou o caminho completo se preferir
            img.className = 'img-sel';
            
            // --- O SEGREDO EST√Å AQUI ---
            // Colocamos uma etiqueta √∫nica na imagem
            img.setAttribute('data-id', nomeBase); 

            img.onload = () => { 
                // Verificamos se j√° existe algu√©m com essa ETIQUETA EXATA
                // (Isso impede que o '1' seja confundido com o '10')
                if(!container.querySelector(`img[data-id="${nomeBase}"]`)) { 
                    img.classList.add('visivel'); 
                    container.appendChild(img); 
                }
            };

            img.onclick = () => {
                document.querySelectorAll('.img-sel').forEach(i => i.classList.remove('ativa'));
                img.classList.add('ativa'); 
                document.getElementById('imgAtividade').value = img.src; 
                window.atualizarPreview();
            };
        });
    });
}

             // A fun√ß√£o agora tem a palavra "async" na frente para o seguran√ßa poder aguardar a resposta do banco
window.fazerLogin = async function(event) {
    // 1. Trava a p√°gina para ela n√£o dar aquele "piscar" e recarregar
    if (event) event.preventDefault(); 

    try {
        // 2. O detector inteligente de caixinhas (pega o ID que voc√™ tiver usado)
        const campoEmail = document.getElementById('emailInput') || document.getElementById('email');
        const campoSenha = document.getElementById('senhaInput') || document.getElementById('senha');

        // Se ele n√£o achar a caixinha de jeito nenhum, ele te avisa na tela!
        if (!campoEmail || !campoSenha) {
            alert("ERRO NO HTML: O c√≥digo n√£o encontrou as caixinhas de e-mail e senha!");
            return;
        }

        const email = campoEmail.value;
        const senha = campoSenha.value;

        // 3. Tenta fazer o login
        const credenciais = await signInWithEmailAndPassword(auth, email, senha);
        const user = credenciais.user;

        // 4. O Seguran√ßa vai no Firestore
        const db = getFirestore(app);
        const docRef = doc(db, "assinaturas", user.uid);
        const docSnap = await getDoc(docRef);

        // 5. Analisa a ficha e abre a catraca
        if (docSnap.exists()) {
            const statusAssinatura = docSnap.data().status;

            if (statusAssinatura === "ativo") {
                window.location.replace("mobile.html"); 
            } else {
                window.location.replace("bloqueado.html");
            }
        } else {
            window.location.replace("bloqueado.html");
        }

    } catch (error) {
        // Se a senha estiver errada ou der algum erro no Firebase, ele avisa aqui
        alert("Erro ao entrar: Verifique seu e-mail e senha.");
        console.error("Detalhe do erro:", error);
    }
};
window.criarConta = async () => {
    // 1. Pega os valores dos inputs
    const email = document.getElementById('email').value;
    const senha = document.getElementById('senha').value;

    try {
        // 2. Tenta criar o usu√°rio
       const userCredential = await createUserWithEmailAndPassword(auth, email, senha);
        const user = userCredential.user;

        // Isso aqui cria a "ficha" dele no banco automaticamente
        const db = getFirestore(app);
        await setDoc(doc(db, "assinaturas", user.uid), {
            status: "bloqueado",
            email: email
        });

        window.location.replace("bloqueado.html");
    } catch (e) {
        // Se der erro (ex: e-mail j√° existe), avisa o usu√°rio
        console.error("Erro na cria√ß√£o:", e.code);
        if (e.code === 'auth/email-already-in-use') {
            alert("Este e-mail j√° est√° em uso. Tente fazer login.");
        } else {
            alert("Erro ao criar conta: " + e.message);
        }
    }
}; 
 window.sair = () => signOut(auth);
 // O "Olho que tudo v√™" agora tamb√©m verifica o pagamento
onAuthStateChanged(auth, async (u) => { 
    if(u) { 
        usuarioAtual = u; 
        
        const db = getFirestore(app);
        const docRef = doc(db, "assinaturas", u.uid);
        
        try {
            const docSnap = await getDoc(docRef);
            
if (docSnap.exists() && docSnap.data().status === "ativo") {
                // SUCESSO! Esconde o login e mostra as pe√ßas do Mobile (COM PROTE√á√ÉO)
                const tLogin = document.getElementById('telaLogin');
                const tDash = document.getElementById('telaDashboard');
                const aHeader = document.getElementById('appHeader');
                const bNav = document.getElementById('bottomNav');
                const mContent = document.getElementById('mainContent'); // <-- PEGA O MEIO

                // S√≥ tenta esconder/mostrar se a pe√ßa realmente existir no HTML
                if (tLogin) tLogin.style.display = 'none'; 
                if (tDash) tDash.style.display = 'block'; 
                if (aHeader) aHeader.style.display = 'flex'; 
                if (bNav) bNav.style.display = 'flex'; 
                if (mContent) mContent.style.display = 'block'; // <-- LIGA O MEIO!
                
                carregarFilhos(); 
                montarGaleriaInfinita(); 
            } else {
                await signOut(auth); 
                window.location.replace("bloqueado.html");
            }
        } catch (erro) {
            alert("ERRO INVIS√çVEL NO MOBILE: " + erro); 
            console.error(erro);
            await signOut(auth);
            window.location.replace("bloqueado.html");
        }

    } else { 
        // USU√ÅRIO DESLOGADO! Mostra o login e esconde o resto (COM PROTE√á√ÉO)
        const tLogin = document.getElementById('telaLogin');
        const tDash = document.getElementById('telaDashboard');
        const aHeader = document.getElementById('appHeader');
        const bNav = document.getElementById('bottomNav');

        if (tLogin) tLogin.style.display = 'flex'; 
        if (tDash) tDash.style.display = 'none'; 
        if (aHeader) aHeader.style.display = 'none'; 
        if (bNav) bNav.style.display = 'none'; 
    }
});

        window.atualizarPreview = () => { const r = document.getElementById('rangeTamanho').value; const u = document.getElementById('imgAtividade').value; document.getElementById('labelTamanho').innerText = r + "px"; const i = document.getElementById('previewAvatar'); i.style.width = r + "px"; if(u) i.src = u; };
        
        function carregarFilhos() { onSnapshot(collection(db, `usuarios/${usuarioAtual.uid}/filhos`), (s) => { const sel = document.getElementById('selectFilho'); sel.innerHTML=""; let tem=false; s.forEach(d=>{ tem=true; let o=document.createElement('option'); o.value=d.id; o.innerText=d.data().nome; sel.appendChild(o); }); if(!tem) novoFilho(); else { if(!filhoAtualId) filhoAtualId=sel.value; carregarDadosFilho(); } }); }
        window.novoFilho = async () => { const n = prompt("Nome:"); if(n){ const c = Math.random().toString(36).substring(2,8).toUpperCase(); const r = await addDoc(collection(db, `usuarios/${usuarioAtual.uid}/filhos`), { nome: n, codigo_pareamento: c }); await setDoc(doc(db, "conexoes", c), { caminho_dados: `usuarios/${usuarioAtual.uid}/filhos/${r.id}` }); mudarFilho(); }};
        window.excluirFilho = async () => { if(confirm("Tem certeza que deseja APAGAR este perfil?")) { await deleteDoc(doc(db, `usuarios/${usuarioAtual.uid}/filhos`, filhoAtualId)); location.reload(); }};
        window.mudarFilho = () => { filhoAtualId=document.getElementById('selectFilho').value; unsubs.forEach(f=>f()); unsubs=[]; carregarDadosFilho(); };

        function carregarDadosFilho() {
            if(!filhoAtualId) return;
            const base = `usuarios/${usuarioAtual.uid}/filhos/${filhoAtualId}`;
            getDoc(doc(db, base)).then(d => { if(d.exists()) document.getElementById('displayCodigo').innerText=d.data().codigo_pareamento; });

            unsubs.push(onSnapshot(collection(db, `${base}/dispositivos`), (snap) => {
                const boxM = document.getElementById('painelMonitoramento'); boxM.innerHTML = "";
                if(snap.empty) boxM.innerHTML = "<p style='text-align:center;color:#999;font-size:12px'>Nenhum PC Conectado</p>";
                snap.forEach(d => {
                    const dev = d.data(); const isO = dev.online && (new Date() - dev.online.toDate() < 120000);
                    const h = Math.floor((dev.tempo_hoje_minutos||0)/60); const m = (dev.tempo_hoje_minutos||0)%60;
                    boxM.innerHTML += `<div class="pc-status-card"><div><strong>${dev.nome||"PC"}</strong> <span class="pc-badge ${isO?'badge-online':'badge-offline'}">${isO?'ONLINE':'OFFLINE'}</span></div><div style="font-size:18px; font-weight:bold; color:#333">${h}h ${m}m</div></div>`;
                });
            }));

            unsubs.push(onSnapshot(query(collection(db, `${base}/historico_uso`), orderBy("data", "desc"), limit(31)), (snap) => {
                const box = document.getElementById('graficoHistorico'); box.innerHTML = "";
                const resumo = document.getElementById('resumoMensal');
                
                let dados = [];
                let totalMinutosMes = 0;
                const mesAtual = new Date().toISOString().slice(0, 7); 

                snap.forEach(doc => {
                    const d = doc.data();
                    if(d.data.startsWith(mesAtual)) totalMinutosMes += (d.minutos || 0);
                    dados.push(d);
                });

                const hT = Math.floor(totalMinutosMes/60); const mT = totalMinutosMes%60;
                resumo.innerHTML = `üìÖ Total em ${mesAtual.split('-')[1]}: <span style="font-size:16px; color:#2c3e50">${hT}h ${mT}m</span>`;

                if(dados.length===0) return box.innerHTML="<small>Sem hist√≥rico</small>";
                let dadosGrafico = dados.slice(0, 7).reverse();
                let max = Math.max(...dadosGrafico.map(x => x.minutos), 1);
                
                dadosGrafico.forEach(i => {
                    const alt = (i.minutos/max)*80; 
                    box.innerHTML += `<div class="barra-wrapper"><div class="barra-valor">${i.minutos>60?(i.minutos/60).toFixed(1)+'h':i.minutos+'m'}</div><div class="barra" style="height:${Math.max(alt,5)}px"></div><div class="barra-dia">${i.data.split('-')[2]}</div></div>`;
                });
            }));

            unsubs.push(onSnapshot(collection(db, `${base}/atividades`), (snap) => {
                const l = document.getElementById('listaAtividades'); const s = document.getElementById('selectAtividadeRotina'); const g = document.getElementById('gridAcoes');
                l.innerHTML=""; s.innerHTML=""; g.innerHTML=""; cacheAtividades={};
                snap.forEach(d => {
                    const dd = d.data(); cacheAtividades[d.id] = dd;
                    l.innerHTML += `<li class="item-lista">
                        <div style="display:flex; align-items:center; flex:1; min-width:0">
                            <img src="${dd.imagem}" style="width:40px;height:40px;object-fit:contain;border-radius:6px;margin-right:10px;background:#f9f9f9"> 
                            <b style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${d.id}</b>
                        </div>
                        <div style="flex-shrink:0">
                            <button class="btn-acao-icone" onclick="carregarEdicaoAtividade('${d.id}')">‚úèÔ∏è</button>
                            <button class="btn-acao-icone" style="color:red" onclick="apagarAtividade('${d.id}')">üóëÔ∏è</button>
                        </div>
                    </li>`;
                    s.innerHTML += `<option value="${d.id}">${d.id}</option>`;
                    g.innerHTML += `<div class="btn-acao" onclick="enviarAcao('${d.id}')"><img src="${dd.imagem}"><br><small>${d.id}</small></div>`;
                });
                renderizarTimeline();
            }));

            unsubs.push(onSnapshot(collection(db, `${base}/rotinas`), (snap) => {
                cacheRotinas={}; snap.forEach(d => cacheRotinas[d.id]=d.data());
                const c=document.getElementById('calendarioContainer'); c.innerHTML="";
                const dias=["DOM","SEG","TER","QUA","QUI","SEX","S√ÅB"];
                for(let i=0; i<7; i++) c.innerHTML+=`<div class="dia-coluna"><div class="dia-header">${dias[i]}</div><div class="lista-rotinas" id="col-${i}"></div></div>`;
                
                Object.entries(cacheRotinas).sort((a,b)=>a[1].hora.localeCompare(b[1].hora)).forEach(([id, r]) => {
                    const atv = cacheAtividades[r.acao] || {};
                    const imgUrl = atv.imagem || ''; 
                    const h=`<div class="card-rotina">
                        <span class="hora-tag">${r.hora}</span> 
                        ${imgUrl ? `<img src="${imgUrl}" class="rotina-img">` : ''}
                        <span class="rotina-texto">${r.acao}</span> 
                        <div class="acoes-rotina">
                            <button class="btn-acao-icone" style="font-size:14px" onclick="carregarEdicaoRotina('${id}')">‚úèÔ∏è</button>
                            <button class="btn-acao-icone" style="color:red; font-size:14px" onclick="apagarRotina('${id}')">üóëÔ∏è</button>
                        </div>
                    </div>`;
                    if(r.dia_semana==='todos') for(let i=0;i<7;i++) document.getElementById(`col-${i}`).innerHTML+=h;
                    else try{document.getElementById(`col-${r.dia_semana}`).innerHTML+=h}catch(e){}
                });
                renderizarTimeline();
            }));
        }

        // --- FUN√á√ÉO DE RENDERIZAR TIMELINE (VISUAL NOVO) ---
        function renderizarTimeline() {
            const t = document.getElementById('timelineInteligente'); if(!t) return; t.innerHTML="";
            const hoje = new Date(); const dS = hoje.getDay().toString(); const hA = hoje.getHours()*60+hoje.getMinutes();
            let prox=false;
            const lista = Object.values(cacheRotinas).filter(r=>r.dia_semana==='todos'||r.dia_semana===dS).sort((a,b)=>a.hora.localeCompare(b.hora));
            if(lista.length===0) return t.innerHTML="<p style='color:#999; text-align:center; padding:15px'>Sem atividades hoje.</p>";
            
            lista.forEach(r=>{
                const [h,m] = r.hora.split(':').map(Number); const min = h*60+m;
                let cl = min < hA ? "passado" : (!prox ? (prox=true, "proximo") : "futuro");
                const img = cacheAtividades[r.acao]?.imagem || '';
                
                // NOVA ESTRUTURA HTML DA TIMELINE (3 COLUNAS)
                t.innerHTML += `
                <div class="tl-item ${cl}">
                    <div class="tl-time-col">${r.hora}</div>
                    <div class="tl-line-col"><div class="tl-dot"></div></div>
                    <div class="tl-card">
                        <img src="${img}">
                        <b>${r.acao}</b>
                    </div>
                </div>`;
            });
        }

       window.salvarAtividade = async () => { 
    const id = document.getElementById('idAtividade').value.toLowerCase().replace(/\s/g,''); 
    if(!id) return alert("Por favor, preencha o ID (Nome Curto) da atividade."); 
    
    const textoAviso = document.getElementById('txtAtividade').value;
    const falarTexto = document.getElementById('checkVoz').checked;
    const bloquearTela = document.getElementById('checkBlock').checked;
    const genero = document.getElementById('generoVoz').value;

    let audioGerado = ""; // Vai guardar o MP3

    // SE O PAI QUER QUE FALE, GERAMOS O √ÅUDIO AGORA NO GOOGLE!
    if (falarTexto && textoAviso) {
        const API_KEY = "AIzaSyBSvEoSv8FgmCfedisR2qAsQYdPq5ADQfI"; // SUA CHAVE ATIVA
        const nomeVoz = (genero === 'M') ? 'pt-BR-Neural2-B' : 'pt-BR-Neural2-C';
        const tomVoz = (genero === 'M') ? -1.0 : 2.0;

        try {
            const resposta = await fetch(`https://texttospeech.googleapis.com/v1/text:synthesize?key=${API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    input: { text: textoAviso },
                    voice: { languageCode: "pt-BR", name: nomeVoz },
                    audioConfig: { audioEncoding: "MP3", pitch: tomVoz, speakingRate: 1.15 }
                })
            });
            const dados = await resposta.json();
            if (dados.audioContent) {
                audioGerado = dados.audioContent; 
            } else {
                console.error("Resposta do Google sem √°udio:", dados);
            }
        } catch(e) {
            console.error("Erro ao gerar √°udio:", e);
        }
    }

    // SALVA NO FIREBASE (COM O √ÅUDIO E O G√äNERO)
    await setDoc(doc(db, `usuarios/${usuarioAtual.uid}/filhos/${filhoAtualId}/atividades`, id), { 
        texto: textoAviso, 
        imagem: document.getElementById('imgAtividade').value, 
        tempo_personalizado: document.getElementById('tempoAtividade').value, 
        tamanho_avatar: document.getElementById('rangeTamanho').value, 
        texto_5min: document.getElementById('txt5min').value, 
        texto_3min: document.getElementById('txt3min').value, 
        imagem_5min: document.getElementById('img5min').value, 
        imagem_3min: document.getElementById('img3min').value, 
        posicao_especifica: document.getElementById('posAtividade').value, 
        falar_texto: falarTexto, 
        bloquear_tela: bloquearTela,
        genero_voz: genero,
        audio_base64: audioGerado
    }); 
    
    alert("‚úÖ Salvo com sucesso!"); 
    limparFormAtividade(); 
};

window.salvarRotina = async () => { const id=document.getElementById('editIdRotina').value; const dados={ hora: document.getElementById('horaRotina').value, dia_semana: document.getElementById('diaRotina').value, acao: document.getElementById('selectAtividadeRotina').value }; if(!dados.hora) return alert("Hora?"); if(id) await updateDoc(doc(db, `usuarios/${usuarioAtual.uid}/filhos/${filhoAtualId}/rotinas`, id), dados); else await addDoc(collection(db, `usuarios/${usuarioAtual.uid}/filhos/${filhoAtualId}/rotinas`), dados); document.getElementById('editIdRotina').value=""; document.getElementById('horaRotina').value=""; };
        window.apagarAtividade = async(id) => { if(confirm("Apagar?")) await deleteDoc(doc(db, `usuarios/${usuarioAtual.uid}/filhos/${filhoAtualId}/atividades`, id)); };
        window.apagarRotina = async(id) => { if(confirm("Apagar?")) await deleteDoc(doc(db, `usuarios/${usuarioAtual.uid}/filhos/${filhoAtualId}/rotinas`, id)); };
        window.enviarAcao = async(a) => { await setDoc(doc(db, `usuarios/${usuarioAtual.uid}/filhos/${filhoAtualId}/config/estado_atual`), {acao:a, timestamp:new Date()}, {merge:true}); mostrarAviso();};
        
        window.carregarEdicaoAtividade = (id) => { 
            const d=cacheAtividades[id]; if(d) { 
                document.getElementById('idAtividade').value=id; document.getElementById('idAtividade').disabled=true; document.getElementById('editIdAtividade').value=id; 
                document.getElementById('txtAtividade').value=d.texto||""; document.getElementById('imgAtividade').value=d.imagem||""; 
                document.getElementById('tempoAtividade').value=d.tempo_personalizado||""; document.getElementById('rangeTamanho').value=d.tamanho_avatar||"150"; 
                document.getElementById('txt5min').value=d.texto_5min||""; document.getElementById('txt3min').value=d.texto_3min||""; 
                document.getElementById('img5min').value=d.imagem_5min||""; document.getElementById('img3min').value=d.imagem_3min||""; 
                document.getElementById('posAtividade').value=d.posicao_especifica||"center"; document.getElementById('checkVoz').checked=(d.falar_texto!==false); 
                document.getElementById('checkBlock').checked=(d.bloquear_tela===true); 
                document.getElementById('generoVoz').value = d.genero_voz || "M";
                atualizarPreview(); mudarAba('criar'); window.scrollTo({ top: 0, behavior: 'smooth' }); 
            }
        };

        window.carregarEdicaoRotina = (id) => {
            const r = cacheRotinas[id]; if(!r) return;
            document.getElementById('editIdRotina').value = id;
            document.getElementById('horaRotina').value = r.hora;
            document.getElementById('diaRotina').value = r.dia_semana;
            document.getElementById('selectAtividadeRotina').value = r.acao;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };
        
        window.limparFormAtividade = () => { document.getElementById('idAtividade').value=""; document.getElementById('txtAtividade').value=""; document.getElementById('imgAtividade').value=""; document.getElementById('idAtividade').disabled=false; document.getElementById('previewAvatar').src=""; };


// Fun√ß√£o para mostrar o aviso flutuante
    window.mostrarAviso = (mensagem) => {
        const toast = document.getElementById("toast-aviso");
        
        // Se voc√™ quiser passar uma mensagem diferente, ele muda. Se n√£o, usa a padr√£o.
        if (mensagem) {
            toast.innerText = "ü§ñ " + mensagem;
        } else {
            toast.innerText = "ü§ñ A√ß√£o enviada para o dispositivo!";
        }

        // Faz aparecer
        toast.classList.add("mostrar");

        // Conta 3 segundos (3000 milissegundos) e faz sumir sozinho
        setTimeout(() => {
            toast.classList.remove("mostrar");
        }, 3000);
    };

// Captura o clique no bot√£o de Esqueci a Senha
document.getElementById('btnEsqueciSenha').addEventListener('click', function(event) {
    event.preventDefault(); // Evita que a p√°gina recarregue do zero

    // Pega o e-mail que o pai digitou na caixinha de login
    // ATEN√á√ÉO: Troque 'id-do-seu-campo-email' pelo ID real que voc√™ usa no seu HTML
   const emailDigitado = document.getElementById('emailInput').value;

    // Verifica se o campo est√° vazio
    if (!emailDigitado) {
        alert("Por favor, digite o seu e-mail na caixinha acima para recuperar a senha!");
        return;
    }

    // Pede para o Firebase mandar o e-mail m√°gico
    sendPasswordResetEmail(auth, emailDigitado)
        .then(() => {
            // Deu certo!
            alert("Sucesso! Um e-mail de recupera√ß√£o foi enviado para: " + emailDigitado + "\n\nVerifique sua caixa de entrada (e tamb√©m a pasta de Spam/Lixo Eletr√¥nico).");
        })
        .catch((error) => {
            // Deu erro (ex: e-mail n√£o existe no banco de dados)
            const codigoErro = error.code;
            if (codigoErro === 'auth/user-not-found') {
                alert("Nenhuma conta encontrada com este e-mail.");
            } else if (codigoErro === 'auth/invalid-email') {
                alert("Por favor, digite um e-mail v√°lido.");
            } else {
                alert("Ocorreu um erro: " + error.message);
            }
        });
});
window.toggleSenha = function() {
    const inputSenha = document.getElementById('senhaInput');
    const botaoOlhinho = document.getElementById('btnOlhinho');

    if (inputSenha.type === 'password') {
        // Se est√° escondida, mostra o texto e troca o √≠cone
        inputSenha.type = 'text';
        botaoOlhinho.innerText = 'üôà'; // √çcone de olho fechado ou macaco escondendo
    } else {
        // Se est√° aparecendo, volta a esconder
        inputSenha.type = 'password';
        botaoOlhinho.innerText = 'üëÅÔ∏è'; // √çcone de olho aberto
    }
};


    </script>
    <script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", function () {
    navigator.serviceWorker.register("./service-worker.js")
      .then(function (reg) {
        console.log("Service Worker registrado:", reg.scope);
      })
      .catch(function (err) {
        console.log("Erro SW:", err);
      });
  });
}

</script>
    </script>
</body>
</html>






