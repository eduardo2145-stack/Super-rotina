<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Amigo Virtual PC</title>
  <style>
    /* Estilos de tela e Reset */
    html, body { width: 100vw !important; height: 100vh !important; margin: 0 !important; padding: 0 !important; overflow: hidden !important; background: transparent; font-family: 'Segoe UI', sans-serif; pointer-events: none; user-select: none; }
    
    /* Container do Avatar e Bal√£o */
    #container { position: fixed; bottom: 0; right: 0; display: flex; flex-direction: column; align-items: center; padding: 20px; z-index: 2147483647; pointer-events: none; transition: opacity 0.5s ease; opacity: 0; }
    
    #balaoNormal { background: #ffffff; color: #333; padding: 15px 25px; border-radius: 20px; font-size: 20px; font-weight: bold; margin-bottom: 15px; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: none; pointer-events: auto; max-width: 300px; text-align: center; }
    #balaoNormal::after { content: ''; position: absolute; bottom: -15px; left: 50%; transform: translateX(-50%); border-width: 15px 15px 0; border-style: solid; border-color: #ffffff transparent transparent transparent; margin-top: -2px; }
    
    #avatar { display: block; height: auto; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2)); pointer-events: auto; width: 150px; }
/* --- POSI√á√ïES DIN√ÇMICAS DO AVATAR --- */
    #container.pos-center { top: 50% !important; left: 50% !important; bottom: auto !important; right: auto !important; transform: translate(-50%, -50%) !important; }
    #container.pos-top-left { top: 30px !important; left: 30px !important; bottom: auto !important; right: auto !important; transform: none !important; }
    #container.pos-top-center { top: 30px !important; left: 50% !important; bottom: auto !important; right: auto !important; transform: translateX(-50%) !important; }
    #container.pos-top-right { top: 30px !important; right: 30px !important; left: auto !important; bottom: auto !important; transform: none !important; }
    #container.pos-bottom-left { bottom: 10px !important; left: 30px !important; top: auto !important; right: auto !important; transform: none !important; }
    #container.pos-bottom-center { bottom: 10px !important; left: 50% !important; top: auto !important; right: auto !important; transform: translateX(-50%) !important; }
    #container.pos-bottom-right { bottom: 10px !important; right: 30px !important; top: auto !important; left: auto !important; transform: none !important; }
    /* --- TELA DE BLOQUEIO ESTILIZADA --- */
    #bloqueioTela { 
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
        background: rgba(0, 0, 0, 0.85); /* Fundo preto semi-transparente */
        backdrop-filter: grayscale(1) blur(10px); /* TUDO ATR√ÅS FICA PRETO E BRANCO E DESFOCADO */
        z-index: 2147483646; display: none; flex-direction: column; 
        justify-content: center; align-items: center; pointer-events: auto !important; 
    }
    .icone-atencao { font-size: 80px; margin-bottom: 20px; animation: piscar 1.5s infinite; }
    .titulo-bloqueio { color: #e74c3c; font-size: 42px; font-weight: 900; text-transform: uppercase; text-align: center; margin: 0; text-shadow: 0 0 20px rgba(231, 76, 60, 0.5); }
    .subtitulo-bloqueio { color: white; font-size: 24px; font-weight: 400; margin-top: 10px; }
    
    .tempo-uso-badge { color: #8899ac; font-size: 14px; border: 1px solid #444; padding: 10px 20px; border-radius: 20px; background: rgba(255,255,255,0.05); font-family: monospace; margin-top: 40px; }

    @keyframes piscar { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.1); } 100% { opacity: 1; transform: scale(1); } }

    /* Tela de Configura√ß√£o Inicial */
    #telaPareamento { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(240, 242, 245, 0.95); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 30000; pointer-events: auto !important; }
    .modal-config { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); width: 320px; text-align: center; }
  </style>
</head>
<body>

  <div id="telaPareamento">
      <div class="modal-config">
        <button onclick="window.close()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 20px; cursor: pointer; color: #95a5a6;">‚úï</button> 
        <h2 style="color:#2c3e50; margin-bottom: 25px;">Configurar PC</h2>
          <input type="text" id="inputNomeDevice" placeholder="Nome (Ex: PC Eduardo)" style="width:100%; padding:12px; margin-bottom:15px; border-radius:10px; border:1px solid #ddd;">
          <input type="text" id="inputCodigo" placeholder="C√ìDIGO" style="width:100%; padding:12px; margin-bottom:20px; text-align:center; text-transform:uppercase; font-weight:bold; border-radius:10px; border:1px solid #ddd;">
          <button id="btnConectar" style="width:100%; padding:15px; background:#3498db; color:white; border:none; border-radius:12px; font-weight:bold; cursor:pointer;">CONECTAR</button>
      </div>
  </div>

  <div id="bloqueioTela">
      <div class="icone-atencao">‚ö†Ô∏è</div>
      <h1 class="titulo-bloqueio">COMPUTADOR BLOQUEADO</h1>
      <div class="subtitulo-bloqueio">Hora de descansar os olhos! üí§</div>
      <div id="displayTempoUso" class="tempo-uso-badge">‚è≥ Calculando uso de hoje...</div>
  </div>

  <div id="container">
    <div id="balaoNormal">...</div>
    <img src="" id="avatar">
  </div>

  <script type="module">
    const { ipcRenderer } = require('electron');
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, increment } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyAh3J8bp7xvNGct8k4TfAoCcIpVRoWjBYI", authDomain: "rotinaeduardo.firebaseapp.com", projectId: "rotinaeduardo", storageBucket: "rotinaeduardo.firebasestorage.app", messagingSenderId: "210945268922", appId: "1:210945268922:web:ce9e585872090b378d7683" };
    const app = initializeApp(firebaseConfig); const db = getFirestore(app);

    let CAMINHO_DADOS = localStorage.getItem('caminho_dados_filho');
    let MEU_DEVICE_ID = localStorage.getItem('device_id') || 'dev_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('device_id', MEU_DEVICE_ID);

    let atividadesMap = {};
    let bloqueioAtivo = false;
    // VARI√ÅVEIS PARA CONTROLAR A SOBREPOSI√á√ÉO
    let timerOcultar;
    let timerBloqueio;
    let audioAtual = null;
    let tempoEsperaAviso = 10000; // 10 segundos de aviso antes de bloquear

    function dataHojeLocal() {
        const agora = new Date();
        const offset = agora.getTimezoneOffset() * 60000;
        return new Date(agora.getTime() - offset).toISOString().split('T')[0];
    }

   // CORRE√á√ÉO DO MOUSE (S√ì CAPTURA SE ESTIVER VIS√çVEL)
    window.addEventListener('mousemove', (event) => {
        const pareamentoVisivel = document.getElementById('telaPareamento').style.display === 'flex';
        const containerAtivo = document.getElementById('container').style.opacity === "1";
        
        if (pareamentoVisivel || bloqueioAtivo) {
            ipcRenderer.send('set-ignore-mouse-events', false);
            return;
        }

        if (containerAtivo) {
            let elem = document.elementFromPoint(event.clientX, event.clientY);
            // S√≥ clica se o mouse estiver exatamente em cima do bal√£o ou do boneco
            if (elem && (elem.id === 'avatar' || elem.id === 'balaoNormal')) {
                ipcRenderer.send('set-ignore-mouse-events', false);
                return;
            }
        }
        
        // Se o boneco sumiu ou o mouse n√£o est√° nele, ignora o mouse (atravessa)
        ipcRenderer.send('set-ignore-mouse-events', true, { forward: true });
    });

    function iniciarOuvintes(caminho) {
        onSnapshot(collection(db, `${caminho}/atividades`), (s) => { s.forEach(d => atividadesMap[d.id] = d.data()); });
        onSnapshot(doc(db, `${caminho}/config/estado_atual`), (d) => { 
            if(d.exists()) {
                const acao = d.data().acao;
                if (acao === 'bloqueio') { ativarBloqueioReal(); } 
                else if (acao === 'livre') { esconderTudo(); } 
                else { acionarAvisoComSequencia(acao); }
            }
        });
        setInterval(contarMinuto, 60000); contarMinuto();
    }

    async function contarMinuto() {
        if(!CAMINHO_DADOS) return;
        const hoje = dataHojeLocal();
        const refHist = doc(db, `${CAMINHO_DADOS}/historico_uso`, hoje);
        await setDoc(refHist, { data: hoje, minutos: increment(1) }, { merge: true });
        const snap = await getDoc(refHist);
        if(snap.exists()) {
            const min = snap.data().minutos || 0;
            await setDoc(doc(db, `${CAMINHO_DADOS}/dispositivos`, MEU_DEVICE_ID), { 
                nome: localStorage.getItem('nome_dispositivo') || 'PC', 
                online: new Date(), 
                tempo_hoje_minutos: min 
            }, {merge: true});
            document.getElementById('displayTempoUso').innerText = `‚è≥ Uso de Hoje: ${Math.floor(min/60)}h ${min%60}m`;
        }
    }

  function acionarAvisoComSequencia(acaoID) {
        let atv = atividadesMap[acaoID];
        if (!atv) return;

        // 1. CANCELA OS CRON√îMETROS ANTIGOS PARA N√ÉO CORTAR O TEMPO DA NOVA A√á√ÉO!
        clearTimeout(timerOcultar);
        clearTimeout(timerBloqueio);

        const containerBoneco = document.getElementById('container');
        const avatarImg = document.getElementById('avatar');
        const balao = document.getElementById('balaoNormal');

        // 2. Limpa posi√ß√µes e aplica a nova
        containerBoneco.classList.remove('pos-center', 'pos-top-left', 'pos-top-center', 'pos-top-right', 'pos-bottom-left', 'pos-bottom-center', 'pos-bottom-right');
        if (atv.posicao_especifica) {
            containerBoneco.classList.add('pos-' + atv.posicao_especifica);
        } else {
            containerBoneco.classList.add('pos-center'); 
        }

        // 3. Monta a tela
        avatarImg.style.width = (atv.tamanho_avatar || 150) + "px";
        avatarImg.src = atv.imagem;
        balao.innerText = atv.texto;
        balao.style.display = atv.texto ? 'block' : 'none';

        // 4. Faz aparecer e fala
        containerBoneco.style.opacity = "1";
        if (atv.falar_texto !== false) falar(atv);

        // 5. CRIA OS NOVOS CRON√îMETROS LIMPOS
        if (atv.bloquear_tela) {
            timerBloqueio = setTimeout(() => {
                containerBoneco.style.opacity = "0"; 
                ativarBloqueioReal(); 
            }, tempoEsperaAviso); 
        } else {
            // Se voc√™ definiu um tempo personalizado na atividade, ele usa. Se n√£o, usa 15s padr√£o.
            let tempoParaSumir = atv.tempo_personalizado ? (parseInt(atv.tempo_personalizado) * 1000) : 15000;
            
            timerOcultar = setTimeout(() => { 
                containerBoneco.style.opacity = "0"; 
            }, tempoParaSumir);
        }
    }

    function ativarBloqueioReal() {
        bloqueioAtivo = true;
        document.getElementById('bloqueioTela').style.display = 'flex';
        ipcRenderer.send('entrar-kiosk');
    }

   function falar(atv) { 
        // 1. MATA QUALQUER √ÅUDIO OU VOZ ANTIGA QUE ESTEJA TOCANDO
        if (audioAtual) {
            audioAtual.pause();
            audioAtual.currentTime = 0;
        }
        window.speechSynthesis.cancel(); 

        // 2. TOCA O NOVO
        if (atv.audio_base64 && atv.audio_base64.length > 10) {
            audioAtual = new Audio("data:audio/mp3;base64," + atv.audio_base64);
            audioAtual.play();
        } else if (atv.texto) {
            const f = new SpeechSynthesisUtterance(atv.texto); 
            f.lang = "pt-BR"; 
            window.speechSynthesis.speak(f); 
        }
    }
    function esconderTudo() { 
        // QUANDO CLICA EM LIBERAR, CANCELA TUDO TAMB√âM
        clearTimeout(timerOcultar);
        clearTimeout(timerBloqueio);
        if (audioAtual) audioAtual.pause();
        window.speechSynthesis.cancel();

        document.getElementById('container').style.opacity = "0"; 
        document.getElementById('bloqueioTela').style.display = 'none'; 
        ipcRenderer.send('sair-kiosk'); 
        bloqueioAtivo = false; 
    }

   // --- NOVO C√ìDIGO DE AUTENTICA√á√ÉO DO PC ---
    const auth = getAuth(app);
    
    // O PC pega o "Crach√° de Visitante" invis√≠vel
    signInAnonymously(auth).then(() => {
        console.log("PC Autenticado com sucesso!");
        
        // S√≥ depois de pegar o crach√°, ele tenta ler os dados
        if (CAMINHO_DADOS) {
            iniciarOuvintes(CAMINHO_DADOS);
        } else {
            document.getElementById('telaPareamento').style.display = 'flex';
        }
    }).catch((error) => {
        console.error("Erro ao autenticar o PC:", error);
    });
    document.getElementById('btnConectar').addEventListener('click', async () => {
        const cod = document.getElementById('inputCodigo').value.toUpperCase();
        const snap = await getDoc(doc(db, "conexoes", cod));
        if (snap.exists()) {
            localStorage.setItem('caminho_dados_filho', snap.data().caminho_dados);
            localStorage.setItem('nome_dispositivo', document.getElementById('inputNomeDevice').value || 'PC');
            location.reload();
        }
    });
  </script>
</body>
</html>